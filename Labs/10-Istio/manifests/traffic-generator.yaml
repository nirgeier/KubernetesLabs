##################################################################################################
# Traffic Generator - Immediate Job + CronJob that sends HTTP requests to Bookinfo
# Generates live traffic for observability in Kiali, Grafana, and Jaeger
##################################################################################################
apiVersion: v1
kind: Namespace
metadata:
  name: traffic-gen
  labels:
    istio-injection: enabled
---
# Immediate seed job - runs right away to populate dashboards with data
apiVersion: batch/v1
kind: Job
metadata:
  name: traffic-seed
  namespace: traffic-gen
  labels:
    app: traffic-generator
    job-type: seed
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: traffic-generator
        job-type: seed
    spec:
      restartPolicy: OnFailure
      containers:
        - name: traffic
          image: curlimages/curl:8.5.0
          command:
            - /bin/sh
            - -c
            - |
              echo "=== Traffic Seed Job Started ==="
              GATEWAY_URL="istio-ingressgateway.istio-system.svc.cluster.local"

              # Wait for gateway to be ready
              echo "Waiting for ingress gateway..."
              for attempt in $(seq 1 30); do
                STATUS=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 3 "http://${GATEWAY_URL}/productpage" 2>/dev/null)
                if [ "$STATUS" = "200" ]; then
                  echo "Gateway ready!"
                  break
                fi
                echo "  Attempt $attempt: HTTP $STATUS - retrying..."
                sleep 5
              done

              # Send a large burst of varied traffic to seed dashboards
              echo "=== Sending seed traffic (100 requests) ==="
              for i in $(seq 1 100); do
                # Productpage - main page
                curl -s -o /dev/null "http://${GATEWAY_URL}/productpage"

                # API endpoints
                curl -s -o /dev/null "http://${GATEWAY_URL}/api/v1/products"
                curl -s -o /dev/null "http://${GATEWAY_URL}/api/v1/products/0"
                curl -s -o /dev/null "http://${GATEWAY_URL}/api/v1/products/0/reviews"
                curl -s -o /dev/null "http://${GATEWAY_URL}/api/v1/products/0/ratings"

                # User "jason" requests (triggers header-based routing)
                curl -s -o /dev/null -H "end-user: jason" "http://${GATEWAY_URL}/productpage"

                # Simulate some 404s for error metrics
                curl -s -o /dev/null "http://${GATEWAY_URL}/nonexistent"

                # Static resources
                curl -s -o /dev/null "http://${GATEWAY_URL}/static/bootstrap/css/bootstrap.min.css"

                if [ $((i % 10)) -eq 0 ]; then
                  echo "[$(date '+%H:%M:%S')] Sent $i request batches..."
                fi
                sleep 0.5
              done

              echo "=== Traffic Seed Job Completed - $((100 * 8)) requests sent ==="
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 64Mi
---
# Recurring CronJob - keeps generating traffic continuously
apiVersion: batch/v1
kind: CronJob
metadata:
  name: traffic-generator
  namespace: traffic-gen
  labels:
    app: traffic-generator
spec:
  schedule: "*/1 * * * *"
  concurrencyPolicy: Allow
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      parallelism: 1
      completions: 1
      backoffLimit: 1
      template:
        metadata:
          labels:
            app: traffic-generator
        spec:
          restartPolicy: Never
          containers:
            - name: traffic
              image: curlimages/curl:8.5.0
              command:
                - /bin/sh
                - -c
                - |
                  echo "=== Traffic Generator Started ==="
                  GATEWAY_URL="istio-ingressgateway.istio-system.svc.cluster.local"

                  # Send multiple requests to generate varied traffic
                  for i in $(seq 1 30); do
                    # Normal productpage request
                    STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://${GATEWAY_URL}/productpage")
                    echo "[$(date '+%H:%M:%S')] Request $i: productpage -> HTTP $STATUS"

                    # API requests
                    curl -s -o /dev/null "http://${GATEWAY_URL}/api/v1/products"
                    curl -s -o /dev/null "http://${GATEWAY_URL}/api/v1/products/0/reviews"
                    curl -s -o /dev/null "http://${GATEWAY_URL}/api/v1/products/0/ratings"

                    # Request as user "jason" (for header-based routing demos)
                    if [ $((i % 3)) -eq 0 ]; then
                      curl -s -o /dev/null -H "end-user: jason" "http://${GATEWAY_URL}/productpage"
                      echo "[$(date '+%H:%M:%S')] Request $i: productpage (user=jason)"
                    fi

                    # Occasional bad request for error metrics
                    if [ $((i % 7)) -eq 0 ]; then
                      curl -s -o /dev/null "http://${GATEWAY_URL}/nonexistent"
                    fi

                    sleep 1
                  done

                  echo "=== Traffic Generator Completed ==="
              resources:
                requests:
                  cpu: 10m
                  memory: 32Mi
                limits:
                  cpu: 100m
                  memory: 64Mi
