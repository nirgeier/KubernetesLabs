<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A collection of Kubernetes Labs for learning and practicing Kubernetes skills."><meta name=author content="Nir Geier - nirgeier@gmail.com"><link href=https://nirgeier.github.io/KubernetesLabs/24-kubebuilder/ rel=canonical><link href=../21-KubeAPI/ rel=prev><link href=../25-krew/ rel=next><link rel=icon href=../assets/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.16"><title>24 Kubebuilder - KubernetesLabs</title><link rel=stylesheet href=../assets/stylesheets/main.7e37652d.min.css><link rel=stylesheet href=../assets/stylesheets/palette.06af60db.min.css><style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M12%202a7%207%200%200%200-7%207c0%202.38%201.19%204.47%203%205.74V17a1%201%200%200%200%201%201h6a1%201%200%200%200%201-1v-2.26c1.81-1.27%203-3.36%203-5.74a7%207%200%200%200-7-7M9%2021a1%201%200%200%200%201%201h4a1%201%200%200%200%201-1v-1H9z%22/%3E%3C/svg%3E');}</style><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Mulish:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Mulish";--md-code-font:"JetBrains Mono"}</style><link rel=stylesheet href=../css/print-site.css><link rel=stylesheet href=../css/print-site-material.css><link rel=stylesheet href="../assets/stylesheets/codewizard.css?v=1772199666"><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#kubebuilder-building-kubernetes-operators class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <!--
  Copyright (c) 2016-2025 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Determine classes --> <!-- Header --> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <!-- Link to home --> <a href=.. title=KubernetesLabs class="md-header__button md-logo" aria-label=KubernetesLabs data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"> <path d=M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z /> <path d=M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z style="fill-opacity: 0.5"/> <path d=M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z /> <path d=M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z style="fill-opacity: 0.25"/> </svg> </a> <!-- Button to open drawer --> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <!-- Header title --> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> KubernetesLabs </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 24 Kubebuilder </span> </div> </div> </div> <div class=m-social__top> <!-- Social links --> <div class=md-social> <a href=https://github.com/nirgeier/KubernetesLabs target=_blank rel=noopener title="View on GitHub" class="md-social__link social-class__github"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://github.com/nirgeier/KubernetesLabs/network/members target=_blank rel=noopener title="Fork this repo" class="md-social__link social-class__fork"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0M5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0m6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5m-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0"/></svg> </a> <a href=https://github.com/nirgeier/KubernetesLabs/stargazers target=_blank rel=noopener title="Star this repo" class="md-social__link social-class__star"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25m0 2.445L6.615 5.5a.75.75 0 0 1-.564.41l-3.097.45 2.24 2.184a.75.75 0 0 1 .216.664l-.528 3.084 2.769-1.456a.75.75 0 0 1 .698 0l2.77 1.456-.53-3.084a.75.75 0 0 1 .216-.664l2.24-2.183-3.096-.45a.75.75 0 0 1-.564-.41z"/></svg> </a> <a href=https://www.linkedin.com/in/nirgeier/ target=_blank rel=noopener title="Connect on LinkedIn" class="md-social__link social-class__linkedin"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://discord.gg/U6xW23Ss target=_blank rel=noopener title="Follow me on Discord" class="md-social__link social-class__discord"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"/></svg> </a> <a href=https://stackoverflow.com/users/1755598/codewizard target=_blank rel=noopener title="Follow me on Stack Overflow" class="md-social__link social-class__stackoverflow"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M291 311 95.3 269.7 87.1 309l195.7 41zm51-87L188.5 95.7 163 126.5l153.5 128.3zm-31.2 39.7L129.5 179l-16.7 36.5L294 300zM262.3 32l-32 24 119.3 160.3 32-24zm20.5 328h-200v39.7h200zm39.7 80H43V320H3v160h359.5V320h-40z"/></svg> </a> <a href=https://wa.me/972548122310 target=_blank rel=noopener title="Follow me on WhatsApp" class="md-social__link social-class__whatsapp"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157m-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1s56.2 81.2 56.1 130.5c0 101.8-84.9 184.6-186.6 184.6m101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8s-14.3 18-17.6 21.8c-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7s-12.5-30.1-17.1-41.2c-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2s-9.7 1.4-14.8 6.9c-5.1 5.6-19.4 19-19.4 46.3s19.9 53.7 22.6 57.4c2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4s4.6-24.1 3.2-26.4c-1.3-2.5-5-3.9-10.5-6.6"/></svg> </a> <a href=mailto:nirg@codewizard.co.il target=_blank rel=noopener title="Email me" class="md-social__link social-class__email"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l208 156a48 48 0 0 0 57.6 0l208-156c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48zM0 196v188c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V196L313.6 344.8c-34.1 25.6-81.1 25.6-115.2 0z"/></svg> </a> </div> </div> <!-- Color palette toggle --> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-hidden=true type=radio name=__palette id=__palette_0> </form> <!-- User preference: color palette --> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <!-- Site language selector --> <!-- Button to open search modal --> <!-- Check if search is actually enabled - see https://t.ly/DT_0V --> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <!-- Search interface --> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <!-- Repository information --> <div class=md-header__source> <a href=https://github.com/nirgeier/KubernetesLabs title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> nirgeier/KubernetesLabs </div> </a> </div> </nav> <!-- Navigation tabs (sticky) --> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../welcome/ class=md-tabs__link> Start Here </a> </li> <li class=md-tabs__item> <a href=.. class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../05-Services/ class=md-tabs__link> Networking </a> </li> <li class=md-tabs__item> <a href=../31-RBAC/ class=md-tabs__link> Security </a> </li> <li class=md-tabs__item> <a href=../06-DataStore/ class=md-tabs__link> Storage & Config </a> </li> <li class=md-tabs__item> <a href=../14-Logging/ class=md-tabs__link> Observability </a> </li> <li class=md-tabs__item> <a href=../13-HelmChart/ class=md-tabs__link> GitOps & CI/CD </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../11-CRD-Custom-Resource-Definition/ class=md-tabs__link> Advanced </a> </li> <li class=md-tabs__item> <a href=../Tasks/ class=md-tabs__link> Tasks </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title=KubernetesLabs class="md-nav__button md-logo" aria-label=KubernetesLabs data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"> <path d=M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z /> <path d=M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z style="fill-opacity: 0.5"/> <path d=M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z /> <path d=M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z style="fill-opacity: 0.25"/> </svg> </a> KubernetesLabs </label> <div class=md-nav__source> <a href=https://github.com/nirgeier/KubernetesLabs title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> nirgeier/KubernetesLabs </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../welcome/ class=md-nav__link> <span class=md-ellipsis> Start Here </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=.. class=md-nav__link> <span class=md-ellipsis> Getting Started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../05-Services/ class=md-nav__link> <span class=md-ellipsis> Networking </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../31-RBAC/ class=md-nav__link> <span class=md-ellipsis> Security </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../06-DataStore/ class=md-nav__link> <span class=md-ellipsis> Storage & Config </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../14-Logging/ class=md-nav__link> <span class=md-ellipsis> Observability </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../13-HelmChart/ class=md-nav__link> <span class=md-ellipsis> GitOps & CI/CD </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8 checked> <div class="md-nav__link md-nav__container"> <a href=../11-CRD-Custom-Resource-Definition/ class="md-nav__link "> <span class=md-ellipsis> Advanced </span> </a> <label class="md-nav__link " for=__nav_8 id=__nav_8_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=true> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Advanced </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../16-Affinity-Taint-Tolleration/ class=md-nav__link> <span class=md-ellipsis> 16 Affinity Taint Toleration </span> </a> </li> <li class=md-nav__item> <a href=../17-PodDisruptionBudgets-PDB/ class=md-nav__link> <span class=md-ellipsis> 17 PodDisruptionBudgets PDB </span> </a> </li> <li class=md-nav__item> <a href=../19-CustomScheduler/ class=md-nav__link> <span class=md-ellipsis> 19 CustomScheduler </span> </a> </li> <li class=md-nav__item> <a href=../21-KubeAPI/ class=md-nav__link> <span class=md-ellipsis> 21 KubeAPI </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> 24 Kubebuilder </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> 24 Kubebuilder </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#what-will-we-learn class=md-nav__link> <span class=md-ellipsis> What will we learn? </span> </a> </li> <li class=md-nav__item> <a href=#official-documentation-references class=md-nav__link> <span class=md-ellipsis> Official Documentation &amp; References </span> </a> </li> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> <nav class=md-nav aria-label=Introduction> <ul class=md-nav__list> <li class=md-nav__item> <a href=#what-is-the-operator-pattern class=md-nav__link> <span class=md-ellipsis> What is the Operator Pattern? </span> </a> </li> <li class=md-nav__item> <a href=#when-should-you-write-an-operator class=md-nav__link> <span class=md-ellipsis> When should you write an Operator? </span> </a> </li> <li class=md-nav__item> <a href=#kubebuilder-vs-raw-client-go class=md-nav__link> <span class=md-ellipsis> Kubebuilder vs Raw client-go </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#terminology class=md-nav__link> <span class=md-ellipsis> Terminology </span> </a> </li> <li class=md-nav__item> <a href=#architecture class=md-nav__link> <span class=md-ellipsis> Architecture </span> </a> </li> <li class=md-nav__item> <a href=#project-structure class=md-nav__link> <span class=md-ellipsis> Project Structure </span> </a> </li> <li class=md-nav__item> <a href=#common-kubebuilder-commands class=md-nav__link> <span class=md-ellipsis> Common Kubebuilder Commands </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../25-krew/ class=md-nav__link> <span class=md-ellipsis> 25 Krew </span> </a> </li> <li class=md-nav__item> <a href=../27-kubeadm/ class=md-nav__link> <span class=md-ellipsis> 27 kubeadm </span> </a> </li> <li class=md-nav__item> <a href=../28-Telepresence/ class=md-nav__link> <span class=md-ellipsis> 28 Telepresence </span> </a> </li> <li class=md-nav__item> <a href=../30-Keda/ class=md-nav__link> <span class=md-ellipsis> 30 KEDA </span> </a> </li> <li class=md-nav__item> <a href=../34-crictl/ class=md-nav__link> <span class=md-ellipsis> 34 crictl </span> </a> </li> <li class=md-nav__item> <a href=../36-kubectl-Deep-Dive/ class=md-nav__link> <span class=md-ellipsis> 36 kubectl Deep Dive </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../Tasks/ class=md-nav__link> <span class=md-ellipsis> Tasks </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=kubebuilder-building-kubernetes-operators>Kubebuilder - Building Kubernetes Operators<a class=headerlink href=#kubebuilder-building-kubernetes-operators title="Permanent link">&para;</a></h1> <ul> <li><code>Kubebuilder</code> is an SDK for building production-grade Kubernetes APIs and controllers (Operators) using Go and the <code>controller-runtime</code> library.</li> <li>Instead of writing low-level machinery by hand, <code>Kubebuilder</code> scaffolds everything - CRD types, RBAC manifests, Makefile targets, and the reconcile loop - so you can focus on business logic.</li> <li>In this lab we build a real <strong>WebApp Operator</strong> that manages a <code>WebApp</code> custom resource and automatically provisions the correct <code>Deployment</code>, <code>Service</code>, and <code>ConfigMap</code> in the cluster.</li> </ul> <hr> <h2 id=what-will-we-learn>What will we learn?<a class=headerlink href=#what-will-we-learn title="Permanent link">&para;</a></h2> <ul> <li>What the <strong>Operator pattern</strong> is and why it exists</li> <li>How <code>Kubebuilder</code> scaffolds a complete operator project</li> <li>How to define a <strong>Custom Resource Definition (CRD)</strong> with validation markers</li> <li>How to write a <strong>Reconciliation Loop</strong> using <code>controller-runtime</code></li> <li>How to manage child resources (<code>Deployment</code>, <code>Service</code>, <code>ConfigMap</code>) and their ownership</li> <li>How to update <strong>Status subresources</strong> and surface conditions</li> <li>How to run the operator <strong>locally</strong> and <strong>in-cluster</strong></li> <li>How to write <strong>admission webhooks</strong> for defaulting and validation</li> <li>How to write <strong>controller tests</strong> with <code>envtest</code></li> <li>How to build and push the operator <strong>Docker image</strong> and deploy via Kustomize</li> </ul> <hr> <h2 id=official-documentation-references>Official Documentation &amp; References<a class=headerlink href=#official-documentation-references title="Permanent link">&para;</a></h2> <table> <thead> <tr> <th>Resource</th> <th>Link</th> </tr> </thead> <tbody> <tr> <td>Kubebuilder Book (official)</td> <td><a href=https://book.kubebuilder.io/ >book.kubebuilder.io</a></td> </tr> <tr> <td>Kubebuilder GitHub</td> <td><a href=https://github.com/kubernetes-sigs/kubebuilder>github.com/kubernetes-sigs/kubebuilder</a></td> </tr> <tr> <td>controller-runtime docs</td> <td><a href=https://pkg.go.dev/sigs.k8s.io/controller-runtime>pkg.go.dev/sigs.k8s.io/controller-runtime</a></td> </tr> <tr> <td>Kubernetes API Conventions</td> <td><a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md>github.com/kubernetes/community/contributors/devel/sig-architecture/api-conventions.md</a></td> </tr> <tr> <td>CRD Validation Markers</td> <td><a href=https://book.kubebuilder.io/reference/markers/crd-validation.html>book.kubebuilder.io/reference/markers/crd-validation</a></td> </tr> <tr> <td>RBAC Markers</td> <td><a href=https://book.kubebuilder.io/reference/markers/rbac.html>book.kubebuilder.io/reference/markers/rbac</a></td> </tr> <tr> <td>Operator SDK (alternative)</td> <td><a href=https://sdk.operatorframework.io/ >sdk.operatorframework.io</a></td> </tr> <tr> <td>OperatorHub.io</td> <td><a href=https://operatorhub.io/ >operatorhub.io</a></td> </tr> <tr> <td>envtest (controller tests)</td> <td><a href=https://book.kubebuilder.io/cronjob-tutorial/writing-tests.html>book.kubebuilder.io/cronjob-tutorial/writing-tests</a></td> </tr> <tr> <td>Go Modules</td> <td><a href=https://go.dev/ref/mod>go.dev/ref/mod</a></td> </tr> </tbody> </table> <hr> <h2 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">&para;</a></h2> <h3 id=what-is-the-operator-pattern>What is the Operator Pattern?<a class=headerlink href=#what-is-the-operator-pattern title="Permanent link">&para;</a></h3> <ul> <li>Kubernetes manages built-in resources (Pods, Deployments, Services) with built-in controllers that run a <strong>reconciliation loop</strong>.</li> <li>A <strong>Kubernetes Operator</strong> extends this pattern to <strong>your own domain-specific resources</strong>.</li> <li>An operator is a combination of:</li> <li>A <strong>Custom Resource Definition (CRD)</strong> - defines the new resource type and its schema in the Kubernetes API</li> <li>A <strong>Controller</strong> - watches for changes to the custom resource and reconciles the cluster state towards the desired state</li> </ul> <pre class=mermaid><code>flowchart LR
    user["Developer\nkubectl apply -f webapp.yaml"] --&gt; api["Kubernetes API Server"]
    api --&gt; etcd["etcd\n(stores WebApp object)"]
    api --&gt; ctrl["WebApp Controller\n(our operator)"]
    ctrl --&gt;|"Reconcile Loop\nCreate/Update/Delete"| deploy["Deployment"]
    ctrl --&gt; svc["Service"]
    ctrl --&gt; cm["ConfigMap"]
    ctrl --&gt;|"Status update"| api</code></pre> <h3 id=when-should-you-write-an-operator>When should you write an Operator?<a class=headerlink href=#when-should-you-write-an-operator title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>Use case</th> <th>Example</th> </tr> </thead> <tbody> <tr> <td>Manage a stateful application lifecycle</td> <td>Database cluster (create, backup, restore, scale, upgrade)</td> </tr> <tr> <td>Encode operational runbook as code</td> <td>Auto-healing, canary rollouts</td> </tr> <tr> <td>Extend Kubernetes with domain knowledge</td> <td>CI/CD pipelines, ML training jobs</td> </tr> <tr> <td>Complex multi-resource coordination</td> <td>Provision <code>Deployment</code> + <code>Service</code> + <code>Certificate</code> as a single object</td> </tr> </tbody> </table> <h3 id=kubebuilder-vs-raw-client-go>Kubebuilder vs Raw client-go<a class=headerlink href=#kubebuilder-vs-raw-client-go title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th></th> <th>Raw client-go</th> <th>Kubebuilder</th> </tr> </thead> <tbody> <tr> <td>Code scaffolding</td> <td>Manual</td> <td>Automated</td> </tr> <tr> <td>CRD schema generation</td> <td>Manual YAML</td> <td>Auto-generated from Go struct + markers</td> </tr> <tr> <td>RBAC generation</td> <td>Manual</td> <td>Auto-generated from <code>//+kubebuilder:rbac</code> markers</td> </tr> <tr> <td>Controller boilerplate</td> <td>Manual</td> <td>Scaffolded</td> </tr> <tr> <td>Testing framework</td> <td>DIY</td> <td><code>envtest</code> built in</td> </tr> <tr> <td>Webhook scaffolding</td> <td>Manual</td> <td>Scaffolded</td> </tr> </tbody> </table> <hr> <h2 id=terminology>Terminology<a class=headerlink href=#terminology title="Permanent link">&para;</a></h2> <table> <thead> <tr> <th>Term</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><strong>CRD</strong></td> <td>Custom Resource Definition - registers a new resource type with the Kubernetes API</td> </tr> <tr> <td><strong>CR</strong></td> <td>Custom Resource - an instance of a CRD (like a Pod is an instance of the Pod resource)</td> </tr> <tr> <td><strong>Operator</strong></td> <td>A controller that implements domain-specific logic for a custom resource</td> </tr> <tr> <td><strong>Reconciler</strong></td> <td>The Go struct that implements the <code>Reconcile(ctx, req)</code> method</td> </tr> <tr> <td><strong>Reconcile Loop</strong></td> <td>Watch → Diff → Act cycle that continuously drives the cluster toward desired state</td> </tr> <tr> <td><strong>Desired State</strong></td> <td>What the user declared in the CR spec</td> </tr> <tr> <td><strong>Observed State</strong></td> <td>What is actually running in the cluster</td> </tr> <tr> <td><strong>Finalizer</strong></td> <td>A string added to <code>.metadata.finalizers</code>; prevents deletion until cleanup logic finished</td> </tr> <tr> <td><strong>Owner Reference</strong></td> <td>A pointer from a child resource (e.g. Deployment) back to its parent (WebApp CR)</td> </tr> <tr> <td><strong>Status Subresource</strong></td> <td>A separate sub-API for writing <code>.status</code> without triggering watches on <code>.spec</code></td> </tr> <tr> <td><strong>Marker</strong></td> <td>A Go comment like <code>//+kubebuilder:...</code> that drives code/manifest generation</td> </tr> <tr> <td><strong>envtest</strong></td> <td>A test environment that starts a real <code>kube-apiserver</code> + <code>etcd</code> binary for integration tests</td> </tr> <tr> <td><strong>Webhook</strong></td> <td>HTTP server ArgoCD calls before creating/updating resources; used for defaulting and validation</td> </tr> </tbody> </table> <hr> <h2 id=architecture>Architecture<a class=headerlink href=#architecture title="Permanent link">&para;</a></h2> <pre class=mermaid><code>graph TB
    subgraph dev["Developer Workflow"]
        code["Write Go types + reconciler"]
        gen["make generate\n(deepcopy funcs)"]
        manifest["make manifests\n(CRD YAML, RBAC YAML)"]
        test["make test\n(envtest suite)"]
        docker["make docker-build docker-push\n(build operator image)"]
        deploy["make deploy\n(kustomize | kubectl apply)"]
    end

    subgraph cluster["Kubernetes Cluster"]
        crd["CRD: webapps.apps.codewizard.io"]
        ns["Namespace: webapp-system"]
        ctrl_pod["Controller Pod\n(our operator binary)"]
        webhook_svc["Webhook Service"]

        subgraph managed["User Namespace"]
            webapp_cr["WebApp CR\n(desired state)"]
            cm["ConfigMap\n(HTML content)"]
            dep["Deployment\n(nginx pods)"]
            svc["Service\n(ClusterIP)"]
        end
    end

    code --&gt; gen --&gt; manifest --&gt; test --&gt; docker --&gt; deploy
    deploy --&gt; crd
    deploy --&gt; ns
    deploy --&gt; ctrl_pod
    ctrl_pod --&gt;|"watch + reconcile"| webapp_cr
    ctrl_pod --&gt;|"owns"| cm
    ctrl_pod --&gt;|"owns"| dep
    ctrl_pod --&gt;|"owns"| svc
    ctrl_pod --&gt;|"updates"| webapp_cr</code></pre> <hr> <h2 id=project-structure>Project Structure<a class=headerlink href=#project-structure title="Permanent link">&para;</a></h2> <p>After running <code>kubebuilder init</code> and <code>kubebuilder create api</code>, the project looks like:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>webapp-operator/
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>├── api/
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>│   └── v1/
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>│       ├── groupversion_info.go    # Group/Version registration
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>│       ├── webapp_types.go         # CRD Go types (Spec, Status, markers)
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>│       └── zz_generated.deepcopy.go  # Auto-generated (make generate)
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>│
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>├── internal/
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>│   └── controller/
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>│       ├── webapp_controller.go    # Reconcile() implementation
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>│       └── webapp_controller_test.go  # envtest-based integration tests
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>│
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>├── config/
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>│   ├── crd/                        # Generated CRD YAML manifests
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>│   ├── rbac/                       # Generated RBAC manifests
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>│   ├── manager/                    # Controller Deployment manifests
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>│   ├── default/                    # Kustomize base that wires everything together
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>│   ├── webhook/                    # Webhook certificates and Service
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>│   └── samples/
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>│       └── apps_v1_webapp.yaml     # Example CR for testing
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>│
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>├── cmd/
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a>│   └── main.go                     # Entry point: registers scheme, starts manager
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a>│
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a>├── Dockerfile                      # Multi-stage build for the operator image
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a>├── Makefile                        # All development targets
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a>├── go.mod                          # Go module definition
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a>└── go.sum                          # Dependency checksums
</span></code></pre></div> <hr> <h2 id=common-kubebuilder-commands>Common Kubebuilder Commands<a class=headerlink href=#common-kubebuilder-commands title="Permanent link">&para;</a></h2> <details class=example> <summary><code>kubebuilder init</code> - Initialize a new operator project</summary> <p><strong>Syntax:</strong> <code>kubebuilder init --domain &lt;domain&gt; --repo &lt;module&gt;</code></p> <p><strong>Description:</strong> Scaffolds the complete project skeleton: <code>cmd/main.go</code>, <code>Makefile</code>, <code>go.mod</code>, base Kustomize configs, and <code>.gitignore</code>.</p> <ul> <li><code>--domain</code> sets the API group suffix (e.g., resources will be <code>&lt;group&gt;.&lt;domain&gt;</code>)</li> <li><code>--repo</code> sets the Go module path</li> <li> <p><code>--plugins=go/v4</code> (default) uses the latest stable Go plugin</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1># Initialize with domain codewizard.io</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>kubebuilder<span class=w> </span>init<span class=w> </span><span class=se>\</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>    </span>--domain<span class=w> </span>codewizard.io<span class=w> </span><span class=se>\</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>    </span>--repo<span class=w> </span>codewizard.io/webapp-operator
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=c1># Initialize with an older plugin (kustomize only, no controller)</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>kubebuilder<span class=w> </span>init<span class=w> </span><span class=se>\</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>    </span>--domain<span class=w> </span>my.domain<span class=w> </span><span class=se>\</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>    </span>--repo<span class=w> </span>my.domain/guestbook<span class=w> </span><span class=se>\</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=w>    </span>--plugins<span class=o>=</span>kustomize/v2-alpha
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=c1># Verify the scaffolded structure</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>ls<span class=w> </span>-la
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>cat<span class=w> </span>go.mod
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>cat<span class=w> </span>Makefile
</span></code></pre></div> </li> </ul> </details> <details class=example> <summary><code>kubebuilder create api</code> - Create a new CRD + Controller</summary> <p><strong>Syntax:</strong> <code>kubebuilder create api --group &lt;group&gt; --version &lt;version&gt; --kind &lt;Kind&gt;</code></p> <p><strong>Description:</strong> Scaffolds a new API type (CRD struct in <code>api/&lt;version&gt;/&lt;kind&gt;_types.go</code>) and a controller stub (<code>internal/controller/&lt;kind&gt;_controller.go</code>).</p> <ul> <li>Prompts whether to create the Resource (CRD type) and the Controller</li> <li>Adds the type to the scheme and wires the controller into <code>cmd/main.go</code></li> <li> <p>Can be run multiple times to add more API kinds to the same project</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=c1># Create WebApp API and controller</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>kubebuilder<span class=w> </span>create<span class=w> </span>api<span class=w> </span><span class=se>\</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>    </span>--group<span class=w> </span>apps<span class=w> </span><span class=se>\</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>    </span>--version<span class=w> </span>v1<span class=w> </span><span class=se>\</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span>--kind<span class=w> </span>WebApp
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=c1># Create a second kind in the same project</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>kubebuilder<span class=w> </span>create<span class=w> </span>api<span class=w> </span><span class=se>\</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>    </span>--group<span class=w> </span>apps<span class=w> </span><span class=se>\</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>    </span>--version<span class=w> </span>v1<span class=w> </span><span class=se>\</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=w>    </span>--kind<span class=w> </span>WebAppPolicy
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=c1># Scaffolds CRD only, no controller</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>kubebuilder<span class=w> </span>create<span class=w> </span>api<span class=w> </span><span class=se>\</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=w>    </span>--group<span class=w> </span>apps<span class=w> </span><span class=se>\</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=w>    </span>--version<span class=w> </span>v1<span class=w> </span><span class=se>\</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=w>    </span>--kind<span class=w> </span>Database<span class=w> </span><span class=se>\</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=w>    </span>--controller<span class=o>=</span><span class=nb>false</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a><span class=c1># View generated type</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a>cat<span class=w> </span>api/v1/webapp_types.go
</span></code></pre></div> </li> </ul> </details> <details class=example> <summary><code>kubebuilder create webhook</code> - Add defaulting or validation webhook</summary> <p><strong>Syntax:</strong> <code>kubebuilder create webhook --group &lt;group&gt; --version &lt;version&gt; --kind &lt;Kind&gt;</code></p> <p><strong>Description:</strong> Scaffolds a webhook server for the given kind, supporting defaulting (mutating) and validation (validating) webhooks.</p> <ul> <li><code>--defaulting</code> generates a <code>Default()</code> method (MutatingAdmissionWebhook)</li> <li><code>--programmatic-validation</code> generates a <code>ValidateCreate/Update/Delete()</code> method (ValidatingAdmissionWebhook)</li> <li> <p>Also generates certificate management setup in <code>config/webhook/</code></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=c1># Add both defaulting and validation webhooks</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>kubebuilder<span class=w> </span>create<span class=w> </span>webhook<span class=w> </span><span class=se>\</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>    </span>--group<span class=w> </span>apps<span class=w> </span><span class=se>\</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>    </span>--version<span class=w> </span>v1<span class=w> </span><span class=se>\</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>    </span>--kind<span class=w> </span>WebApp<span class=w> </span><span class=se>\</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>    </span>--defaulting<span class=w> </span><span class=se>\</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=w>    </span>--programmatic-validation
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=c1># View scaffolded webhook file</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>cat<span class=w> </span>api/v1/webapp_webhook.go
</span></code></pre></div> </li> </ul> </details> <details class=example> <summary><code>make generate</code> - Generate DeepCopy functions</summary> <p><strong>Syntax:</strong> <code>make generate</code></p> <p><strong>Description:</strong> Runs <code>controller-gen object</code> to auto-generate <code>DeepCopyObject()</code> methods for all types. These are required by the Kubernetes runtime and must be regenerated after every change to <code>*_types.go</code>.</p> <div class=codehilite><pre><span></span><code><span class=err>```</span><span class=nx>bash</span>
<span class=err>#</span><span class=w> </span><span class=nx>Regenerate</span><span class=w> </span><span class=nx>after</span><span class=w> </span><span class=nx>changing</span><span class=w> </span><span class=nx>types</span>
<span class=nx>make</span><span class=w> </span><span class=nx>generate</span>

<span class=err>#</span><span class=w> </span><span class=nx>View</span><span class=w> </span><span class=nx>generated</span><span class=w> </span><span class=nx>file</span>
<span class=nx>cat</span><span class=w> </span><span class=kn>api</span><span class=o>/</span><span class=nx>v1</span><span class=o>/</span><span class=nx>zz_generated</span><span class=p>.</span><span class=nx>deepcopy</span><span class=p>.</span><span class=nx>go</span>

<span class=err>#</span><span class=w> </span><span class=nx>What</span><span class=w> </span><span class=nx>it</span><span class=w> </span><span class=nx>runs</span><span class=w> </span><span class=nx>under</span><span class=w> </span><span class=nx>the</span><span class=w> </span><span class=nx>hood</span><span class=p>:</span>
<span class=err>#</span><span class=w> </span><span class=nx>controller</span><span class=o>-</span><span class=nx>gen</span><span class=w> </span><span class=nx>object</span><span class=p>:</span><span class=nx>headerFile</span><span class=p>=</span><span class=s>&quot;hack/boilerplate.go.txt&quot;</span><span class=w> </span><span class=nx>paths</span><span class=p>=</span><span class=s>&quot;./...&quot;</span>
<span class=err>```</span>
</code></pre></div> </details> <details class=example> <summary><code>make manifests</code> - Generate CRD and RBAC manifests</summary> <p><strong>Syntax:</strong> <code>make manifests</code></p> <p><strong>Description:</strong> Runs <code>controller-gen</code> to generate CRD YAML, RBAC ClusterRole, and webhook manifests from Go markers. Must be run after every change to markers in <code>*_types.go</code> or <code>*_controller.go</code>.</p> <div class=codehilite><pre><span></span><code>```bash
<span class=gh>#</span> Generate all manifests
make manifests

<span class=gh>#</span> View generated CRD YAML
cat config/crd/bases/apps.codewizard.io_webapps.yaml

<span class=gh>#</span> View generated RBAC
cat config/rbac/role.yaml

<span class=gh>#</span> What it runs:
<span class=gh>#</span> controller-gen rbac:roleName=manager-role crd webhook paths=&quot;./...&quot; \
<span class=gh>#</span>   output:crd:artifacts:config=config/crd/bases
```
</code></pre></div> </details> <details class=example> <summary><code>make install</code> - Install CRDs into the cluster</summary> <p><strong>Syntax:</strong> <code>make install</code></p> <p><strong>Description:</strong> Applies the generated CRD manifests to the currently active cluster using <code>kubectl apply</code>. After this, <code>kubectl get webapps</code> will work.</p> <div class=codehilite><pre><span></span><code><span class=err>``</span><span class=no>`bash</span>
<span class=p>#</span><span class=w> </span><span class=n>Install</span><span class=w> </span><span class=n>CRDs</span>
<span class=n>make</span><span class=w> </span><span class=n>install</span>

<span class=p>#</span><span class=w> </span><span class=n>Verify</span><span class=w> </span><span class=n>CRD</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=n>registered</span>
<span class=n>kubectl</span><span class=w> </span><span class=n>get</span><span class=w> </span><span class=n>crds</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>grep</span><span class=w> </span><span class=n>codewizard</span>

<span class=p>#</span><span class=w> </span><span class=n>Describe</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>CRD</span><span class=w> </span><span class=n>schema</span>
<span class=n>kubectl</span><span class=w> </span><span class=n>describe</span><span class=w> </span><span class=n>crd</span><span class=w> </span><span class=n>webapps</span><span class=p>.</span><span class=n>apps</span><span class=p>.</span><span class=n>codewizard</span><span class=p>.</span><span class=n>io</span>

<span class=p>#</span><span class=w> </span><span class=n>What</span><span class=w> </span><span class=n>it</span><span class=w> </span><span class=nl>runs:</span>
<span class=p>#</span><span class=w> </span><span class=n>kubectl</span><span class=w> </span><span class=n>apply</span><span class=w> </span><span class=o>-</span><span class=n>k</span><span class=w> </span><span class=n>config</span><span class=o>/</span><span class=n>crd</span>
<span class=err>```</span>
</code></pre></div> </details> <details class=example> <summary><code>make run</code> - Run the controller locally</summary> <p><strong>Syntax:</strong> <code>make run</code></p> <p><strong>Description:</strong> Runs the controller binary on your local machine using the kubeconfig in <code>~/.kube/config</code>. The controller connects to the cluster and reconciles resources but runs outside the cluster (useful for development).</p> <div class=codehilite><pre><span></span><code>```bash
# Run controller locally (uses current kubeconfig)
make run

# Run with extra verbosity
make run ARGS=&quot;--zap-log-level=debug&quot;

# Run with leader election disabled (single instance mode)
make run ARGS=&quot;--leader-elect=false&quot;
```
</code></pre></div> </details> <details class=example> <summary><code>make test</code> - Run controller tests with envtest</summary> <p><strong>Syntax:</strong> <code>make test</code></p> <p><strong>Description:</strong> Runs the full test suite using <code>envtest</code>, which starts a real <code>kube-apiserver</code> and <code>etcd</code> binary locally - no cluster required.</p> <div class=codehilite><pre><span></span><code>```bash
# Run all tests
make test

# Run with verbose output
make test ARGS=&quot;-v&quot;

# Run only specific tests
make test ARGS=&quot;-run TestWebAppReconciler&quot;

# Run with coverage report
make test-coverage
```
</code></pre></div> </details> <details class=example> <summary><code>make docker-build</code> - Build the operator image</summary> <p><strong>Syntax:</strong> <code>make docker-build IMG=&lt;image:tag&gt;</code></p> <p><strong>Description:</strong> Builds a multi-stage Docker image containing the compiled operator binary.</p> <div class=codehilite><pre><span></span><code>```<span class=nv>bash</span>
#<span class=w> </span><span class=nv>Build</span><span class=w> </span><span class=nv>with</span><span class=w> </span><span class=nv>a</span><span class=w> </span><span class=nv>custom</span><span class=w> </span><span class=nv>image</span><span class=w> </span><span class=nv>name</span>
<span class=nv>make</span><span class=w> </span><span class=nv>docker</span><span class=o>-</span><span class=nv>build</span><span class=w> </span><span class=nv>IMG</span><span class=o>=</span><span class=nv>ghcr</span>.<span class=nv>io</span><span class=o>/</span><span class=nv>myorg</span><span class=o>/</span><span class=nv>webapp</span><span class=o>-</span><span class=nv>operator</span>:<span class=nv>v0</span>.<span class=mi>1</span>.<span class=mi>0</span>

#<span class=w> </span><span class=nv>Build</span><span class=w> </span><span class=nv>and</span><span class=w> </span><span class=nv>push</span><span class=w> </span><span class=nv>in</span><span class=w> </span><span class=nv>one</span><span class=w> </span><span class=nv>step</span>
<span class=nv>make</span><span class=w> </span><span class=nv>docker</span><span class=o>-</span><span class=nv>build</span><span class=w> </span><span class=nv>docker</span><span class=o>-</span><span class=nv>push</span><span class=w> </span><span class=nv>IMG</span><span class=o>=</span><span class=nv>ghcr</span>.<span class=nv>io</span><span class=o>/</span><span class=nv>myorg</span><span class=o>/</span><span class=nv>webapp</span><span class=o>-</span><span class=nv>operator</span>:<span class=nv>v0</span>.<span class=mi>1</span>.<span class=mi>0</span>

#<span class=w> </span><span class=nv>Build</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=nv>multiple</span><span class=w> </span><span class=nv>platforms</span><span class=w> </span><span class=ss>(</span><span class=nv>requires</span><span class=w> </span><span class=nv>buildx</span><span class=ss>)</span>
<span class=nv>make</span><span class=w> </span><span class=nv>docker</span><span class=o>-</span><span class=nv>buildx</span><span class=w> </span><span class=nv>IMG</span><span class=o>=</span><span class=nv>ghcr</span>.<span class=nv>io</span><span class=o>/</span><span class=nv>myorg</span><span class=o>/</span><span class=nv>webapp</span><span class=o>-</span><span class=nv>operator</span>:<span class=nv>v0</span>.<span class=mi>1</span>.<span class=mi>0</span>
```
</code></pre></div> </details> <details class=example> <summary><code>make deploy</code> - Deploy the operator to the cluster</summary> <p><strong>Syntax:</strong> <code>make deploy IMG=&lt;image:tag&gt;</code></p> <p><strong>Description:</strong> Uses Kustomize to render all manifests (CRD, RBAC, Deployment, webhook certs) and applies them to the cluster.</p> <div class=codehilite><pre><span></span><code>```bash
# Deploy with a specific image
make deploy IMG=ghcr.io/myorg/webapp-operator:v0.1.0

# Verify the operator pod is running
kubectl get pods -n webapp-system

# Check operator logs
kubectl logs -n webapp-system -l control-plane=controller-manager -f

# Undeploy
make undeploy
```
</code></pre></div> </details> <hr> <h1 id=lab>Lab<a class=headerlink href=#lab title="Permanent link">&para;</a></h1> <h2 id=part-01-prerequisites>Part 01 - Prerequisites<a class=headerlink href=#part-01-prerequisites title="Permanent link">&para;</a></h2> <h3 id=0101-install-go>01.01 Install Go<a class=headerlink href=#0101-install-go title="Permanent link">&para;</a></h3> <p>Kubebuilder requires <strong>Go 1.21+</strong>.</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>macOS</label><label for=__tabbed_1_2>Linux</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class="language-bash highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>brew<span class=w> </span>install<span class=w> </span>go
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=c1># Or download directly</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=c1># https://go.dev/dl/</span>
</span></code></pre></div> </div> <div class=tabbed-block> <div class="language-bash highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=c1># Download and install Go 1.22</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>curl<span class=w> </span>-LO<span class=w> </span>https://go.dev/dl/go1.22.4.linux-amd64.tar.gz
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>sudo<span class=w> </span>tar<span class=w> </span>-C<span class=w> </span>/usr/local<span class=w> </span>-xzf<span class=w> </span>go1.22.4.linux-amd64.tar.gz
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=nb>echo</span><span class=w> </span><span class=s1>&#39;export PATH=$PATH:/usr/local/go/bin&#39;</span><span class=w> </span>&gt;&gt;<span class=w> </span>~/.bashrc
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=nb>source</span><span class=w> </span>~/.bashrc
</span></code></pre></div> </div> </div> </div> <h4 id=verify>Verify<a class=headerlink href=#verify title="Permanent link">&para;</a></h4> <div class="language-bash highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>go<span class=w> </span>version
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=c1># go version go1.22.x linux/amd64  (or darwin/arm64 etc.)</span>
</span></code></pre></div> <h3 id=0102-install-kubebuilder>01.02 Install Kubebuilder<a class=headerlink href=#0102-install-kubebuilder title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=c1># Detect OS and architecture</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=nv>OS</span><span class=o>=</span><span class=k>$(</span>go<span class=w> </span>env<span class=w> </span>GOOS<span class=k>)</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=nv>ARCH</span><span class=o>=</span><span class=k>$(</span>go<span class=w> </span>env<span class=w> </span>GOARCH<span class=k>)</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=c1># Download the latest kubebuilder binary</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>curl<span class=w> </span>-L<span class=w> </span><span class=s2>&quot;https://go.kubebuilder.io/dl/latest/</span><span class=si>${</span><span class=nv>OS</span><span class=si>}</span><span class=s2>/</span><span class=si>${</span><span class=nv>ARCH</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=w>    </span>-o<span class=w> </span>/tmp/kubebuilder
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a>sudo<span class=w> </span>mv<span class=w> </span>/tmp/kubebuilder<span class=w> </span>/usr/local/bin/kubebuilder
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a>sudo<span class=w> </span>chmod<span class=w> </span>+x<span class=w> </span>/usr/local/bin/kubebuilder
</span></code></pre></div> <h4 id=verify_1>Verify<a class=headerlink href=#verify_1 title="Permanent link">&para;</a></h4> <div class="language-bash highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>kubebuilder<span class=w> </span>version
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=c1># Version: main.version{...KubeBuilderVersion:&quot;4.x.x&quot;,...}</span>
</span></code></pre></div> <h3 id=0103-install-controller-gen-and-other-tools>01.03 Install controller-gen and other tools<a class=headerlink href=#0103-install-controller-gen-and-other-tools title="Permanent link">&para;</a></h3> <p>Kubebuilder uses several helper binaries installed by <code>make</code>. They are downloaded automatically on first use:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1># These are auto-downloaded by the Makefile when needed:</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=c1># - controller-gen   (code + manifest generation)</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=c1># - envtest          (testing framework binaries)</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=c1># - kustomize        (manifest composition)</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=c1># - golangci-lint    (linter)</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=c1># You can pre-download them:</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a>make<span class=w> </span>controller-gen
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a>make<span class=w> </span>kustomize
</span></code></pre></div> <h3 id=0104-verify-cluster-access>01.04 Verify cluster access<a class=headerlink href=#0104-verify-cluster-access title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>kubectl<span class=w> </span>cluster-info
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>kubectl<span class=w> </span>get<span class=w> </span>nodes
</span></code></pre></div> <hr> <h2 id=part-02-initialize-the-project>Part 02 - Initialize the Project<a class=headerlink href=#part-02-initialize-the-project title="Permanent link">&para;</a></h2> <p>We will build a <strong>WebApp Operator</strong> that manages a <code>WebApp</code> custom resource. A <code>WebApp</code> CR creates a <code>Deployment</code> (nginx), a <code>Service</code> (ClusterIP), and a <code>ConfigMap</code> (HTML content) - all owned and reconciled by our controller.</p> <h3 id=0201-create-and-enter-the-project-directory>02.01 Create and enter the project directory<a class=headerlink href=#0201-create-and-enter-the-project-directory title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a>mkdir<span class=w> </span>webapp-operator
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=nb>cd</span><span class=w> </span>webapp-operator
</span></code></pre></div> <h3 id=0202-initialize-the-kubebuilder-project>02.02 Initialize the Kubebuilder project<a class=headerlink href=#0202-initialize-the-kubebuilder-project title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a>kubebuilder<span class=w> </span>init<span class=w> </span><span class=se>\</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=w>    </span>--domain<span class=w> </span>codewizard.io<span class=w> </span><span class=se>\</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=w>    </span>--repo<span class=w>   </span>codewizard.io/webapp-operator
</span></code></pre></div> <p>Output:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a>Writing kustomize manifests for you to edit...
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>Writing scaffold for you to edit...
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>Get controller runtime:
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>$ go get sigs.k8s.io/controller-runtime@v0.18.x
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>go: downloading sigs.k8s.io/controller-runtime v0.18.x
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>...
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a>Next: define a resource with:
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a>$ kubebuilder create api
</span></code></pre></div> <h3 id=0203-inspect-the-scaffolded-files>02.03 Inspect the scaffolded files<a class=headerlink href=#0203-inspect-the-scaffolded-files title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=c1># Project layout</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>find<span class=w> </span>.<span class=w> </span>-type<span class=w> </span>f<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-v<span class=w> </span><span class=s1>&#39;.git\|vendor\|_test&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>sort
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=c1># Go module</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a>cat<span class=w> </span>go.mod
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=c1># Entrypoint</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a>cat<span class=w> </span>cmd/main.go
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a><span class=c1># Makefile targets</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a>make<span class=w> </span><span class=nb>help</span>
</span></code></pre></div> <p>The <code>cmd/main.go</code> sets up the manager - it starts the controller, serves metrics, and manages leader election. You rarely need to edit this file by hand.</p> <hr> <h2 id=part-03-create-the-api-crd-controller-scaffold>Part 03 - Create the API (CRD + Controller Scaffold)<a class=headerlink href=#part-03-create-the-api-crd-controller-scaffold title="Permanent link">&para;</a></h2> <h3 id=0301-scaffold-the-webapp-api>03.01 Scaffold the WebApp API<a class=headerlink href=#0301-scaffold-the-webapp-api title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a>kubebuilder<span class=w> </span>create<span class=w> </span>api<span class=w> </span><span class=se>\</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=w>    </span>--group<span class=w>   </span>apps<span class=w> </span><span class=se>\</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=w>    </span>--version<span class=w> </span>v1<span class=w> </span><span class=se>\</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=w>    </span>--kind<span class=w>    </span>WebApp
</span></code></pre></div> <p>When prompted: <div class="language-text highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a>Create Resource [y/n]   → y
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a>Create Controller [y/n] → y
</span></code></pre></div></p> <h3 id=0302-inspect-the-generated-files>03.02 Inspect the generated files<a class=headerlink href=#0302-inspect-the-generated-files title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=c1># Type definition (we will fill this in next)</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a>cat<span class=w> </span>api/v1/webapp_types.go
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=c1># Reconciler stub (we will fill this in next)</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a>cat<span class=w> </span>internal/controller/webapp_controller.go
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=c1># main.go is updated to register WebApp</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a>grep<span class=w> </span>WebApp<span class=w> </span>cmd/main.go
</span></code></pre></div> <hr> <h2 id=part-04-define-the-crd-types>Part 04 - Define the CRD Types<a class=headerlink href=#part-04-define-the-crd-types title="Permanent link">&para;</a></h2> <p>This is the heart of the API definition. Open <code>api/v1/webapp_types.go</code> and <strong>replace its contents</strong> with the following:</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=c1>// api/v1/webapp_types.go</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=kn>package</span><span class=w> </span><span class=nx>v1</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=kn>import</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=w>    </span><span class=nx>metav1</span><span class=w> </span><span class=s>&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=p>)</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=c1>// WebAppSpec defines the desired state of WebApp.</span>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=kd>type</span><span class=w> </span><span class=nx>WebAppSpec</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=w>    </span><span class=c1>// Replicas is the desired number of nginx Pods.</span>
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a><span class=w>    </span><span class=c1>// +kubebuilder:validation:Minimum=1</span>
</span><span id=__span-25-12><a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=w>    </span><span class=c1>// +kubebuilder:validation:Maximum=10</span>
</span><span id=__span-25-13><a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a><span class=w>    </span><span class=c1>// +kubebuilder:default=1</span>
</span><span id=__span-25-14><a id=__codelineno-25-14 name=__codelineno-25-14 href=#__codelineno-25-14></a><span class=w>    </span><span class=nx>Replicas</span><span class=w> </span><span class=kt>int32</span><span class=w> </span><span class=s>`json:&quot;replicas,omitempty&quot;`</span>
</span><span id=__span-25-15><a id=__codelineno-25-15 name=__codelineno-25-15 href=#__codelineno-25-15></a>
</span><span id=__span-25-16><a id=__codelineno-25-16 name=__codelineno-25-16 href=#__codelineno-25-16></a><span class=w>    </span><span class=c1>// Image is the nginx container image (repository:tag).</span>
</span><span id=__span-25-17><a id=__codelineno-25-17 name=__codelineno-25-17 href=#__codelineno-25-17></a><span class=w>    </span><span class=c1>// +kubebuilder:default=&quot;nginx:1.25.3&quot;</span>
</span><span id=__span-25-18><a id=__codelineno-25-18 name=__codelineno-25-18 href=#__codelineno-25-18></a><span class=w>    </span><span class=c1>// +kubebuilder:validation:MinLength=1</span>
</span><span id=__span-25-19><a id=__codelineno-25-19 name=__codelineno-25-19 href=#__codelineno-25-19></a><span class=w>    </span><span class=nx>Image</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=s>`json:&quot;image,omitempty&quot;`</span>
</span><span id=__span-25-20><a id=__codelineno-25-20 name=__codelineno-25-20 href=#__codelineno-25-20></a>
</span><span id=__span-25-21><a id=__codelineno-25-21 name=__codelineno-25-21 href=#__codelineno-25-21></a><span class=w>    </span><span class=c1>// Message is the HTML body text served by nginx.</span>
</span><span id=__span-25-22><a id=__codelineno-25-22 name=__codelineno-25-22 href=#__codelineno-25-22></a><span class=w>    </span><span class=c1>// +kubebuilder:validation:MinLength=1</span>
</span><span id=__span-25-23><a id=__codelineno-25-23 name=__codelineno-25-23 href=#__codelineno-25-23></a><span class=w>    </span><span class=c1>// +kubebuilder:validation:MaxLength=500</span>
</span><span id=__span-25-24><a id=__codelineno-25-24 name=__codelineno-25-24 href=#__codelineno-25-24></a><span class=w>    </span><span class=nx>Message</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=s>`json:&quot;message&quot;`</span>
</span><span id=__span-25-25><a id=__codelineno-25-25 name=__codelineno-25-25 href=#__codelineno-25-25></a>
</span><span id=__span-25-26><a id=__codelineno-25-26 name=__codelineno-25-26 href=#__codelineno-25-26></a><span class=w>    </span><span class=c1>// Port is the container port nginx listens on.</span>
</span><span id=__span-25-27><a id=__codelineno-25-27 name=__codelineno-25-27 href=#__codelineno-25-27></a><span class=w>    </span><span class=c1>// +kubebuilder:validation:Minimum=1</span>
</span><span id=__span-25-28><a id=__codelineno-25-28 name=__codelineno-25-28 href=#__codelineno-25-28></a><span class=w>    </span><span class=c1>// +kubebuilder:validation:Maximum=65535</span>
</span><span id=__span-25-29><a id=__codelineno-25-29 name=__codelineno-25-29 href=#__codelineno-25-29></a><span class=w>    </span><span class=c1>// +kubebuilder:default=80</span>
</span><span id=__span-25-30><a id=__codelineno-25-30 name=__codelineno-25-30 href=#__codelineno-25-30></a><span class=w>    </span><span class=nx>Port</span><span class=w> </span><span class=kt>int32</span><span class=w> </span><span class=s>`json:&quot;port,omitempty&quot;`</span>
</span><span id=__span-25-31><a id=__codelineno-25-31 name=__codelineno-25-31 href=#__codelineno-25-31></a>
</span><span id=__span-25-32><a id=__codelineno-25-32 name=__codelineno-25-32 href=#__codelineno-25-32></a><span class=w>    </span><span class=c1>// ServiceType controls how the Service is exposed.</span>
</span><span id=__span-25-33><a id=__codelineno-25-33 name=__codelineno-25-33 href=#__codelineno-25-33></a><span class=w>    </span><span class=c1>// +kubebuilder:validation:Enum=ClusterIP;NodePort;LoadBalancer</span>
</span><span id=__span-25-34><a id=__codelineno-25-34 name=__codelineno-25-34 href=#__codelineno-25-34></a><span class=w>    </span><span class=c1>// +kubebuilder:default=ClusterIP</span>
</span><span id=__span-25-35><a id=__codelineno-25-35 name=__codelineno-25-35 href=#__codelineno-25-35></a><span class=w>    </span><span class=nx>ServiceType</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=s>`json:&quot;serviceType,omitempty&quot;`</span>
</span><span id=__span-25-36><a id=__codelineno-25-36 name=__codelineno-25-36 href=#__codelineno-25-36></a><span class=p>}</span>
</span><span id=__span-25-37><a id=__codelineno-25-37 name=__codelineno-25-37 href=#__codelineno-25-37></a>
</span><span id=__span-25-38><a id=__codelineno-25-38 name=__codelineno-25-38 href=#__codelineno-25-38></a><span class=c1>// WebAppPhase is a simple enum for the overall lifecycle state.</span>
</span><span id=__span-25-39><a id=__codelineno-25-39 name=__codelineno-25-39 href=#__codelineno-25-39></a><span class=c1>// +kubebuilder:validation:Enum=Pending;Running;Degraded;Failed</span>
</span><span id=__span-25-40><a id=__codelineno-25-40 name=__codelineno-25-40 href=#__codelineno-25-40></a><span class=kd>type</span><span class=w> </span><span class=nx>WebAppPhase</span><span class=w> </span><span class=kt>string</span>
</span><span id=__span-25-41><a id=__codelineno-25-41 name=__codelineno-25-41 href=#__codelineno-25-41></a>
</span><span id=__span-25-42><a id=__codelineno-25-42 name=__codelineno-25-42 href=#__codelineno-25-42></a><span class=kd>const</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-25-43><a id=__codelineno-25-43 name=__codelineno-25-43 href=#__codelineno-25-43></a><span class=w>    </span><span class=nx>WebAppPhasePending</span><span class=w>  </span><span class=nx>WebAppPhase</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&quot;Pending&quot;</span>
</span><span id=__span-25-44><a id=__codelineno-25-44 name=__codelineno-25-44 href=#__codelineno-25-44></a><span class=w>    </span><span class=nx>WebAppPhaseRunning</span><span class=w>  </span><span class=nx>WebAppPhase</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&quot;Running&quot;</span>
</span><span id=__span-25-45><a id=__codelineno-25-45 name=__codelineno-25-45 href=#__codelineno-25-45></a><span class=w>    </span><span class=nx>WebAppPhaseDegraded</span><span class=w> </span><span class=nx>WebAppPhase</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&quot;Degraded&quot;</span>
</span><span id=__span-25-46><a id=__codelineno-25-46 name=__codelineno-25-46 href=#__codelineno-25-46></a><span class=w>    </span><span class=nx>WebAppPhaseFailed</span><span class=w>   </span><span class=nx>WebAppPhase</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&quot;Failed&quot;</span>
</span><span id=__span-25-47><a id=__codelineno-25-47 name=__codelineno-25-47 href=#__codelineno-25-47></a><span class=p>)</span>
</span><span id=__span-25-48><a id=__codelineno-25-48 name=__codelineno-25-48 href=#__codelineno-25-48></a>
</span><span id=__span-25-49><a id=__codelineno-25-49 name=__codelineno-25-49 href=#__codelineno-25-49></a><span class=c1>// WebAppStatus defines the observed state of WebApp.</span>
</span><span id=__span-25-50><a id=__codelineno-25-50 name=__codelineno-25-50 href=#__codelineno-25-50></a><span class=kd>type</span><span class=w> </span><span class=nx>WebAppStatus</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-51><a id=__codelineno-25-51 name=__codelineno-25-51 href=#__codelineno-25-51></a><span class=w>    </span><span class=c1>// AvailableReplicas is the number of Pods in the Ready state.</span>
</span><span id=__span-25-52><a id=__codelineno-25-52 name=__codelineno-25-52 href=#__codelineno-25-52></a><span class=w>    </span><span class=nx>AvailableReplicas</span><span class=w> </span><span class=kt>int32</span><span class=w> </span><span class=s>`json:&quot;availableReplicas,omitempty&quot;`</span>
</span><span id=__span-25-53><a id=__codelineno-25-53 name=__codelineno-25-53 href=#__codelineno-25-53></a>
</span><span id=__span-25-54><a id=__codelineno-25-54 name=__codelineno-25-54 href=#__codelineno-25-54></a><span class=w>    </span><span class=c1>// ReadyReplicas is the number of Pods that have passed readiness checks.</span>
</span><span id=__span-25-55><a id=__codelineno-25-55 name=__codelineno-25-55 href=#__codelineno-25-55></a><span class=w>    </span><span class=nx>ReadyReplicas</span><span class=w> </span><span class=kt>int32</span><span class=w> </span><span class=s>`json:&quot;readyReplicas,omitempty&quot;`</span>
</span><span id=__span-25-56><a id=__codelineno-25-56 name=__codelineno-25-56 href=#__codelineno-25-56></a>
</span><span id=__span-25-57><a id=__codelineno-25-57 name=__codelineno-25-57 href=#__codelineno-25-57></a><span class=w>    </span><span class=c1>// Phase is a high-level summary of the WebApp lifecycle.</span>
</span><span id=__span-25-58><a id=__codelineno-25-58 name=__codelineno-25-58 href=#__codelineno-25-58></a><span class=w>    </span><span class=nx>Phase</span><span class=w> </span><span class=nx>WebAppPhase</span><span class=w> </span><span class=s>`json:&quot;phase,omitempty&quot;`</span>
</span><span id=__span-25-59><a id=__codelineno-25-59 name=__codelineno-25-59 href=#__codelineno-25-59></a>
</span><span id=__span-25-60><a id=__codelineno-25-60 name=__codelineno-25-60 href=#__codelineno-25-60></a><span class=w>    </span><span class=c1>// DeploymentName is the name of the managed Deployment.</span>
</span><span id=__span-25-61><a id=__codelineno-25-61 name=__codelineno-25-61 href=#__codelineno-25-61></a><span class=w>    </span><span class=nx>DeploymentName</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=s>`json:&quot;deploymentName,omitempty&quot;`</span>
</span><span id=__span-25-62><a id=__codelineno-25-62 name=__codelineno-25-62 href=#__codelineno-25-62></a>
</span><span id=__span-25-63><a id=__codelineno-25-63 name=__codelineno-25-63 href=#__codelineno-25-63></a><span class=w>    </span><span class=c1>// ServiceName is the name of the managed Service.</span>
</span><span id=__span-25-64><a id=__codelineno-25-64 name=__codelineno-25-64 href=#__codelineno-25-64></a><span class=w>    </span><span class=nx>ServiceName</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=s>`json:&quot;serviceName,omitempty&quot;`</span>
</span><span id=__span-25-65><a id=__codelineno-25-65 name=__codelineno-25-65 href=#__codelineno-25-65></a>
</span><span id=__span-25-66><a id=__codelineno-25-66 name=__codelineno-25-66 href=#__codelineno-25-66></a><span class=w>    </span><span class=c1>// Conditions holds standard API conditions.</span>
</span><span id=__span-25-67><a id=__codelineno-25-67 name=__codelineno-25-67 href=#__codelineno-25-67></a><span class=w>    </span><span class=c1>// +listType=map</span>
</span><span id=__span-25-68><a id=__codelineno-25-68 name=__codelineno-25-68 href=#__codelineno-25-68></a><span class=w>    </span><span class=c1>// +listMapKey=type</span>
</span><span id=__span-25-69><a id=__codelineno-25-69 name=__codelineno-25-69 href=#__codelineno-25-69></a><span class=w>    </span><span class=nx>Conditions</span><span class=w> </span><span class=p>[]</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Condition</span><span class=w> </span><span class=s>`json:&quot;conditions,omitempty&quot;`</span>
</span><span id=__span-25-70><a id=__codelineno-25-70 name=__codelineno-25-70 href=#__codelineno-25-70></a><span class=p>}</span>
</span><span id=__span-25-71><a id=__codelineno-25-71 name=__codelineno-25-71 href=#__codelineno-25-71></a>
</span><span id=__span-25-72><a id=__codelineno-25-72 name=__codelineno-25-72 href=#__codelineno-25-72></a><span class=c1>// Condition type constants</span>
</span><span id=__span-25-73><a id=__codelineno-25-73 name=__codelineno-25-73 href=#__codelineno-25-73></a><span class=kd>const</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-25-74><a id=__codelineno-25-74 name=__codelineno-25-74 href=#__codelineno-25-74></a><span class=w>    </span><span class=c1>// ConditionTypeAvailable means the WebApp has at least one ready pod.</span>
</span><span id=__span-25-75><a id=__codelineno-25-75 name=__codelineno-25-75 href=#__codelineno-25-75></a><span class=w>    </span><span class=nx>ConditionTypeAvailable</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&quot;Available&quot;</span>
</span><span id=__span-25-76><a id=__codelineno-25-76 name=__codelineno-25-76 href=#__codelineno-25-76></a><span class=w>    </span><span class=c1>// ConditionTypeProgressing means a rollout or scale is in progress.</span>
</span><span id=__span-25-77><a id=__codelineno-25-77 name=__codelineno-25-77 href=#__codelineno-25-77></a><span class=w>    </span><span class=nx>ConditionTypeProgressing</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&quot;Progressing&quot;</span>
</span><span id=__span-25-78><a id=__codelineno-25-78 name=__codelineno-25-78 href=#__codelineno-25-78></a><span class=w>    </span><span class=c1>// ConditionTypeDegraded means some (but not all) replicas are ready.</span>
</span><span id=__span-25-79><a id=__codelineno-25-79 name=__codelineno-25-79 href=#__codelineno-25-79></a><span class=w>    </span><span class=nx>ConditionTypeDegraded</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&quot;Degraded&quot;</span>
</span><span id=__span-25-80><a id=__codelineno-25-80 name=__codelineno-25-80 href=#__codelineno-25-80></a><span class=p>)</span>
</span><span id=__span-25-81><a id=__codelineno-25-81 name=__codelineno-25-81 href=#__codelineno-25-81></a>
</span><span id=__span-25-82><a id=__codelineno-25-82 name=__codelineno-25-82 href=#__codelineno-25-82></a><span class=c1>//+kubebuilder:object:root=true</span>
</span><span id=__span-25-83><a id=__codelineno-25-83 name=__codelineno-25-83 href=#__codelineno-25-83></a><span class=c1>//+kubebuilder:subresource:status</span>
</span><span id=__span-25-84><a id=__codelineno-25-84 name=__codelineno-25-84 href=#__codelineno-25-84></a><span class=c1>//+kubebuilder:resource:shortName=wa,categories=all</span>
</span><span id=__span-25-85><a id=__codelineno-25-85 name=__codelineno-25-85 href=#__codelineno-25-85></a><span class=c1>//+kubebuilder:printcolumn:name=&quot;Replicas&quot;,type=integer,JSONPath=&quot;.spec.replicas&quot;</span>
</span><span id=__span-25-86><a id=__codelineno-25-86 name=__codelineno-25-86 href=#__codelineno-25-86></a><span class=c1>//+kubebuilder:printcolumn:name=&quot;Available&quot;,type=integer,JSONPath=&quot;.status.availableReplicas&quot;</span>
</span><span id=__span-25-87><a id=__codelineno-25-87 name=__codelineno-25-87 href=#__codelineno-25-87></a><span class=c1>//+kubebuilder:printcolumn:name=&quot;Phase&quot;,type=string,JSONPath=&quot;.status.phase&quot;</span>
</span><span id=__span-25-88><a id=__codelineno-25-88 name=__codelineno-25-88 href=#__codelineno-25-88></a><span class=c1>//+kubebuilder:printcolumn:name=&quot;Image&quot;,type=string,JSONPath=&quot;.spec.image&quot;</span>
</span><span id=__span-25-89><a id=__codelineno-25-89 name=__codelineno-25-89 href=#__codelineno-25-89></a><span class=c1>//+kubebuilder:printcolumn:name=&quot;Age&quot;,type=date,JSONPath=&quot;.metadata.creationTimestamp&quot;</span>
</span><span id=__span-25-90><a id=__codelineno-25-90 name=__codelineno-25-90 href=#__codelineno-25-90></a>
</span><span id=__span-25-91><a id=__codelineno-25-91 name=__codelineno-25-91 href=#__codelineno-25-91></a><span class=c1>// WebApp is the Schema for the webapps API.</span>
</span><span id=__span-25-92><a id=__codelineno-25-92 name=__codelineno-25-92 href=#__codelineno-25-92></a><span class=c1>// It provisions a Deployment, Service, and ConfigMap that serve the configured HTML page.</span>
</span><span id=__span-25-93><a id=__codelineno-25-93 name=__codelineno-25-93 href=#__codelineno-25-93></a><span class=kd>type</span><span class=w> </span><span class=nx>WebApp</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-94><a id=__codelineno-25-94 name=__codelineno-25-94 href=#__codelineno-25-94></a><span class=w>    </span><span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span><span class=w>   </span><span class=s>`json:&quot;,inline&quot;`</span>
</span><span id=__span-25-95><a id=__codelineno-25-95 name=__codelineno-25-95 href=#__codelineno-25-95></a><span class=w>    </span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=w> </span><span class=s>`json:&quot;metadata,omitempty&quot;`</span>
</span><span id=__span-25-96><a id=__codelineno-25-96 name=__codelineno-25-96 href=#__codelineno-25-96></a>
</span><span id=__span-25-97><a id=__codelineno-25-97 name=__codelineno-25-97 href=#__codelineno-25-97></a><span class=w>    </span><span class=nx>Spec</span><span class=w>   </span><span class=nx>WebAppSpec</span><span class=w>   </span><span class=s>`json:&quot;spec,omitempty&quot;`</span>
</span><span id=__span-25-98><a id=__codelineno-25-98 name=__codelineno-25-98 href=#__codelineno-25-98></a><span class=w>    </span><span class=nx>Status</span><span class=w> </span><span class=nx>WebAppStatus</span><span class=w> </span><span class=s>`json:&quot;status,omitempty&quot;`</span>
</span><span id=__span-25-99><a id=__codelineno-25-99 name=__codelineno-25-99 href=#__codelineno-25-99></a><span class=p>}</span>
</span><span id=__span-25-100><a id=__codelineno-25-100 name=__codelineno-25-100 href=#__codelineno-25-100></a>
</span><span id=__span-25-101><a id=__codelineno-25-101 name=__codelineno-25-101 href=#__codelineno-25-101></a><span class=c1>//+kubebuilder:object:root=true</span>
</span><span id=__span-25-102><a id=__codelineno-25-102 name=__codelineno-25-102 href=#__codelineno-25-102></a>
</span><span id=__span-25-103><a id=__codelineno-25-103 name=__codelineno-25-103 href=#__codelineno-25-103></a><span class=c1>// WebAppList contains a list of WebApp.</span>
</span><span id=__span-25-104><a id=__codelineno-25-104 name=__codelineno-25-104 href=#__codelineno-25-104></a><span class=kd>type</span><span class=w> </span><span class=nx>WebAppList</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-105><a id=__codelineno-25-105 name=__codelineno-25-105 href=#__codelineno-25-105></a><span class=w>    </span><span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span><span class=w> </span><span class=s>`json:&quot;,inline&quot;`</span>
</span><span id=__span-25-106><a id=__codelineno-25-106 name=__codelineno-25-106 href=#__codelineno-25-106></a><span class=w>    </span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ListMeta</span><span class=w> </span><span class=s>`json:&quot;metadata,omitempty&quot;`</span>
</span><span id=__span-25-107><a id=__codelineno-25-107 name=__codelineno-25-107 href=#__codelineno-25-107></a><span class=w>    </span><span class=nx>Items</span><span class=w>           </span><span class=p>[]</span><span class=nx>WebApp</span><span class=w> </span><span class=s>`json:&quot;items&quot;`</span>
</span><span id=__span-25-108><a id=__codelineno-25-108 name=__codelineno-25-108 href=#__codelineno-25-108></a><span class=p>}</span>
</span><span id=__span-25-109><a id=__codelineno-25-109 name=__codelineno-25-109 href=#__codelineno-25-109></a>
</span><span id=__span-25-110><a id=__codelineno-25-110 name=__codelineno-25-110 href=#__codelineno-25-110></a><span class=kd>func</span><span class=w> </span><span class=nx>init</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-111><a id=__codelineno-25-111 name=__codelineno-25-111 href=#__codelineno-25-111></a><span class=w>    </span><span class=nx>SchemeBuilder</span><span class=p>.</span><span class=nx>Register</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>WebApp</span><span class=p>{},</span><span class=w> </span><span class=o>&amp;</span><span class=nx>WebAppList</span><span class=p>{})</span>
</span><span id=__span-25-112><a id=__codelineno-25-112 name=__codelineno-25-112 href=#__codelineno-25-112></a><span class=p>}</span>
</span></code></pre></div> <h3 id=marker-reference>Marker Reference<a class=headerlink href=#marker-reference title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>Marker</th> <th>Effect</th> </tr> </thead> <tbody> <tr> <td><code>//+kubebuilder:object:root=true</code></td> <td>Marks this type as a root object (has its own API endpoint)</td> </tr> <tr> <td><code>//+kubebuilder:subresource:status</code></td> <td>Generates a <code>/status</code> sub-resource (status updates don&rsquo;t trigger spec watches)</td> </tr> <tr> <td><code>//+kubebuilder:resource:shortName=wa</code></td> <td>Allows <code>kubectl get wa</code> as a shorthand</td> </tr> <tr> <td><code>//+kubebuilder:printcolumn:...</code></td> <td>Extra columns shown by <code>kubectl get wa</code></td> </tr> <tr> <td><code>//+kubebuilder:validation:Minimum=1</code></td> <td>Adds server-side validation to the CRD schema</td> </tr> <tr> <td><code>//+kubebuilder:default=1</code></td> <td>Sets a default value when the field is omitted</td> </tr> <tr> <td><code>//+kubebuilder:validation:Enum=...</code></td> <td>Restricts the field to a fixed set of values</td> </tr> </tbody> </table> <h3 id=0401-generate-deepcopy-functions>04.01 Generate DeepCopy functions<a class=headerlink href=#0401-generate-deepcopy-functions title="Permanent link">&para;</a></h3> <p>After every change to <code>*_types.go</code> run:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a>make<span class=w> </span>generate
</span></code></pre></div> <p>This auto-generates <code>api/v1/zz_generated.deepcopy.go</code> which implements <code>DeepCopyObject()</code> - required by the Kubernetes runtime for garbage collection and caching.</p> <h3 id=0402-generate-crd-manifest>04.02 Generate CRD manifest<a class=headerlink href=#0402-generate-crd-manifest title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a>make<span class=w> </span>manifests
</span></code></pre></div> <p>Inspect the generated CRD YAML:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a>cat<span class=w> </span>config/crd/bases/apps.codewizard.io_webapps.yaml
</span></code></pre></div> <p>You will see the full OpenAPI v3 schema, validation rules, printer columns, and status subresource settings - all derived from the Go markers.</p> <hr> <h2 id=part-05-implement-the-reconciler>Part 05 - Implement the Reconciler<a class=headerlink href=#part-05-implement-the-reconciler title="Permanent link">&para;</a></h2> <p>Open <code>internal/controller/webapp_controller.go</code> and <strong>replace its contents</strong> with the full reconciler:</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=c1>// internal/controller/webapp_controller.go</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=kn>package</span><span class=w> </span><span class=nx>controller</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=kn>import</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=w>    </span><span class=s>&quot;context&quot;</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=w>    </span><span class=s>&quot;fmt&quot;</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=w>    </span><span class=nx>appsv1</span><span class=w> </span><span class=s>&quot;k8s.io/api/apps/v1&quot;</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=w>    </span><span class=nx>corev1</span><span class=w> </span><span class=s>&quot;k8s.io/api/core/v1&quot;</span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a><span class=w>    </span><span class=s>&quot;k8s.io/apimachinery/pkg/api/errors&quot;</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a><span class=w>    </span><span class=s>&quot;k8s.io/apimachinery/pkg/api/meta&quot;</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=w>    </span><span class=nx>metav1</span><span class=w> </span><span class=s>&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a><span class=w>    </span><span class=s>&quot;k8s.io/apimachinery/pkg/runtime&quot;</span>
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a><span class=w>    </span><span class=s>&quot;k8s.io/apimachinery/pkg/types&quot;</span>
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a><span class=w>    </span><span class=nx>ctrl</span><span class=w> </span><span class=s>&quot;sigs.k8s.io/controller-runtime&quot;</span>
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a><span class=w>    </span><span class=s>&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;</span>
</span><span id=__span-29-17><a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a><span class=w>    </span><span class=s>&quot;sigs.k8s.io/controller-runtime/pkg/log&quot;</span>
</span><span id=__span-29-18><a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a>
</span><span id=__span-29-19><a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a><span class=w>    </span><span class=nx>webappv1</span><span class=w> </span><span class=s>&quot;codewizard.io/webapp-operator/api/v1&quot;</span>
</span><span id=__span-29-20><a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a><span class=p>)</span>
</span><span id=__span-29-21><a id=__codelineno-29-21 name=__codelineno-29-21 href=#__codelineno-29-21></a>
</span><span id=__span-29-22><a id=__codelineno-29-22 name=__codelineno-29-22 href=#__codelineno-29-22></a><span class=c1>// WebAppReconciler reconciles a WebApp object.</span>
</span><span id=__span-29-23><a id=__codelineno-29-23 name=__codelineno-29-23 href=#__codelineno-29-23></a><span class=kd>type</span><span class=w> </span><span class=nx>WebAppReconciler</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-24><a id=__codelineno-29-24 name=__codelineno-29-24 href=#__codelineno-29-24></a><span class=w>    </span><span class=nx>client</span><span class=p>.</span><span class=nx>Client</span>
</span><span id=__span-29-25><a id=__codelineno-29-25 name=__codelineno-29-25 href=#__codelineno-29-25></a><span class=w>    </span><span class=nx>Scheme</span><span class=w> </span><span class=o>*</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>Scheme</span>
</span><span id=__span-29-26><a id=__codelineno-29-26 name=__codelineno-29-26 href=#__codelineno-29-26></a><span class=p>}</span>
</span><span id=__span-29-27><a id=__codelineno-29-27 name=__codelineno-29-27 href=#__codelineno-29-27></a>
</span><span id=__span-29-28><a id=__codelineno-29-28 name=__codelineno-29-28 href=#__codelineno-29-28></a><span class=c1>// RBAC markers - these generate config/rbac/role.yaml when `make manifests` is run.</span>
</span><span id=__span-29-29><a id=__codelineno-29-29 name=__codelineno-29-29 href=#__codelineno-29-29></a><span class=c1>//</span>
</span><span id=__span-29-30><a id=__codelineno-29-30 name=__codelineno-29-30 href=#__codelineno-29-30></a><span class=c1>//+kubebuilder:rbac:groups=apps.codewizard.io,resources=webapps,verbs=get;list;watch;create;update;patch;delete</span>
</span><span id=__span-29-31><a id=__codelineno-29-31 name=__codelineno-29-31 href=#__codelineno-29-31></a><span class=c1>//+kubebuilder:rbac:groups=apps.codewizard.io,resources=webapps/status,verbs=get;update;patch</span>
</span><span id=__span-29-32><a id=__codelineno-29-32 name=__codelineno-29-32 href=#__codelineno-29-32></a><span class=c1>//+kubebuilder:rbac:groups=apps.codewizard.io,resources=webapps/finalizers,verbs=update</span>
</span><span id=__span-29-33><a id=__codelineno-29-33 name=__codelineno-29-33 href=#__codelineno-29-33></a><span class=c1>//+kubebuilder:rbac:groups=apps,resources=deployments,verbs=get;list;watch;create;update;patch;delete</span>
</span><span id=__span-29-34><a id=__codelineno-29-34 name=__codelineno-29-34 href=#__codelineno-29-34></a><span class=c1>//+kubebuilder:rbac:groups=core,resources=services,verbs=get;list;watch;create;update;patch;delete</span>
</span><span id=__span-29-35><a id=__codelineno-29-35 name=__codelineno-29-35 href=#__codelineno-29-35></a><span class=c1>//+kubebuilder:rbac:groups=core,resources=configmaps,verbs=get;list;watch;create;update;patch;delete</span>
</span><span id=__span-29-36><a id=__codelineno-29-36 name=__codelineno-29-36 href=#__codelineno-29-36></a><span class=c1>//+kubebuilder:rbac:groups=core,resources=events,verbs=create;patch</span>
</span><span id=__span-29-37><a id=__codelineno-29-37 name=__codelineno-29-37 href=#__codelineno-29-37></a>
</span><span id=__span-29-38><a id=__codelineno-29-38 name=__codelineno-29-38 href=#__codelineno-29-38></a><span class=c1>// Reconcile is the main reconciliation loop.</span>
</span><span id=__span-29-39><a id=__codelineno-29-39 name=__codelineno-29-39 href=#__codelineno-29-39></a><span class=c1>// It is called whenever a WebApp CR (or a resource it owns) changes.</span>
</span><span id=__span-29-40><a id=__codelineno-29-40 name=__codelineno-29-40 href=#__codelineno-29-40></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>WebAppReconciler</span><span class=p>)</span><span class=w> </span><span class=nx>Reconcile</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>req</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-41><a id=__codelineno-29-41 name=__codelineno-29-41 href=#__codelineno-29-41></a><span class=w>    </span><span class=nx>logger</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>log</span><span class=p>.</span><span class=nx>FromContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span><span id=__span-29-42><a id=__codelineno-29-42 name=__codelineno-29-42 href=#__codelineno-29-42></a>
</span><span id=__span-29-43><a id=__codelineno-29-43 name=__codelineno-29-43 href=#__codelineno-29-43></a><span class=w>    </span><span class=c1>// ── Step 1: Fetch the WebApp instance ────────────────────────────────────</span>
</span><span id=__span-29-44><a id=__codelineno-29-44 name=__codelineno-29-44 href=#__codelineno-29-44></a><span class=w>    </span><span class=nx>webapp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>webappv1</span><span class=p>.</span><span class=nx>WebApp</span><span class=p>{}</span>
</span><span id=__span-29-45><a id=__codelineno-29-45 name=__codelineno-29-45 href=#__codelineno-29-45></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>req</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-46><a id=__codelineno-29-46 name=__codelineno-29-46 href=#__codelineno-29-46></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=nx>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-47><a id=__codelineno-29-47 name=__codelineno-29-47 href=#__codelineno-29-47></a><span class=w>            </span><span class=c1>// Object was deleted before we could reconcile - nothing to do.</span>
</span><span id=__span-29-48><a id=__codelineno-29-48 name=__codelineno-29-48 href=#__codelineno-29-48></a><span class=w>            </span><span class=nx>logger</span><span class=p>.</span><span class=nx>Info</span><span class=p>(</span><span class=s>&quot;WebApp not found, likely deleted&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;name&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>req</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span><span id=__span-29-49><a id=__codelineno-29-49 name=__codelineno-29-49 href=#__codelineno-29-49></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-29-50><a id=__codelineno-29-50 name=__codelineno-29-50 href=#__codelineno-29-50></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-29-51><a id=__codelineno-29-51 name=__codelineno-29-51 href=#__codelineno-29-51></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nx>Errorf</span><span class=p>(</span><span class=s>&quot;fetching WebApp: %w&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span>
</span><span id=__span-29-52><a id=__codelineno-29-52 name=__codelineno-29-52 href=#__codelineno-29-52></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-53><a id=__codelineno-29-53 name=__codelineno-29-53 href=#__codelineno-29-53></a>
</span><span id=__span-29-54><a id=__codelineno-29-54 name=__codelineno-29-54 href=#__codelineno-29-54></a><span class=w>    </span><span class=nx>logger</span><span class=p>.</span><span class=nx>Info</span><span class=p>(</span><span class=s>&quot;Reconciling WebApp&quot;</span><span class=p>,</span>
</span><span id=__span-29-55><a id=__codelineno-29-55 name=__codelineno-29-55 href=#__codelineno-29-55></a><span class=w>        </span><span class=s>&quot;name&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span><span id=__span-29-56><a id=__codelineno-29-56 name=__codelineno-29-56 href=#__codelineno-29-56></a><span class=w>        </span><span class=s>&quot;namespace&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span>
</span><span id=__span-29-57><a id=__codelineno-29-57 name=__codelineno-29-57 href=#__codelineno-29-57></a><span class=w>        </span><span class=s>&quot;replicas&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=p>)</span>
</span><span id=__span-29-58><a id=__codelineno-29-58 name=__codelineno-29-58 href=#__codelineno-29-58></a>
</span><span id=__span-29-59><a id=__codelineno-29-59 name=__codelineno-29-59 href=#__codelineno-29-59></a><span class=w>    </span><span class=c1>// ── Step 2: Reconcile ConfigMap (HTML content) ───────────────────────────</span>
</span><span id=__span-29-60><a id=__codelineno-29-60 name=__codelineno-29-60 href=#__codelineno-29-60></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>reconcileConfigMap</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-61><a id=__codelineno-29-61 name=__codelineno-29-61 href=#__codelineno-29-61></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nx>Errorf</span><span class=p>(</span><span class=s>&quot;reconciling ConfigMap: %w&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span>
</span><span id=__span-29-62><a id=__codelineno-29-62 name=__codelineno-29-62 href=#__codelineno-29-62></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-63><a id=__codelineno-29-63 name=__codelineno-29-63 href=#__codelineno-29-63></a>
</span><span id=__span-29-64><a id=__codelineno-29-64 name=__codelineno-29-64 href=#__codelineno-29-64></a><span class=w>    </span><span class=c1>// ── Step 3: Reconcile Deployment ─────────────────────────────────────────</span>
</span><span id=__span-29-65><a id=__codelineno-29-65 name=__codelineno-29-65 href=#__codelineno-29-65></a><span class=w>    </span><span class=nx>deployment</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>reconcileDeployment</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>)</span>
</span><span id=__span-29-66><a id=__codelineno-29-66 name=__codelineno-29-66 href=#__codelineno-29-66></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-67><a id=__codelineno-29-67 name=__codelineno-29-67 href=#__codelineno-29-67></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nx>Errorf</span><span class=p>(</span><span class=s>&quot;reconciling Deployment: %w&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span>
</span><span id=__span-29-68><a id=__codelineno-29-68 name=__codelineno-29-68 href=#__codelineno-29-68></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-69><a id=__codelineno-29-69 name=__codelineno-29-69 href=#__codelineno-29-69></a>
</span><span id=__span-29-70><a id=__codelineno-29-70 name=__codelineno-29-70 href=#__codelineno-29-70></a><span class=w>    </span><span class=c1>// ── Step 4: Reconcile Service ─────────────────────────────────────────────</span>
</span><span id=__span-29-71><a id=__codelineno-29-71 name=__codelineno-29-71 href=#__codelineno-29-71></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>reconcileService</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-72><a id=__codelineno-29-72 name=__codelineno-29-72 href=#__codelineno-29-72></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nx>Errorf</span><span class=p>(</span><span class=s>&quot;reconciling Service: %w&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span>
</span><span id=__span-29-73><a id=__codelineno-29-73 name=__codelineno-29-73 href=#__codelineno-29-73></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-74><a id=__codelineno-29-74 name=__codelineno-29-74 href=#__codelineno-29-74></a>
</span><span id=__span-29-75><a id=__codelineno-29-75 name=__codelineno-29-75 href=#__codelineno-29-75></a><span class=w>    </span><span class=c1>// ── Step 5: Update Status ─────────────────────────────────────────────────</span>
</span><span id=__span-29-76><a id=__codelineno-29-76 name=__codelineno-29-76 href=#__codelineno-29-76></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>updateStatus</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>,</span><span class=w> </span><span class=nx>deployment</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-77><a id=__codelineno-29-77 name=__codelineno-29-77 href=#__codelineno-29-77></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nx>Errorf</span><span class=p>(</span><span class=s>&quot;updating status: %w&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span>
</span><span id=__span-29-78><a id=__codelineno-29-78 name=__codelineno-29-78 href=#__codelineno-29-78></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-79><a id=__codelineno-29-79 name=__codelineno-29-79 href=#__codelineno-29-79></a>
</span><span id=__span-29-80><a id=__codelineno-29-80 name=__codelineno-29-80 href=#__codelineno-29-80></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-29-81><a id=__codelineno-29-81 name=__codelineno-29-81 href=#__codelineno-29-81></a><span class=p>}</span>
</span><span id=__span-29-82><a id=__codelineno-29-82 name=__codelineno-29-82 href=#__codelineno-29-82></a>
</span><span id=__span-29-83><a id=__codelineno-29-83 name=__codelineno-29-83 href=#__codelineno-29-83></a><span class=c1>// ── reconcileConfigMap ensures the HTML ConfigMap exists and is up-to-date. ──</span>
</span><span id=__span-29-84><a id=__codelineno-29-84 name=__codelineno-29-84 href=#__codelineno-29-84></a>
</span><span id=__span-29-85><a id=__codelineno-29-85 name=__codelineno-29-85 href=#__codelineno-29-85></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>WebAppReconciler</span><span class=p>)</span><span class=w> </span><span class=nx>reconcileConfigMap</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=w> </span><span class=o>*</span><span class=nx>webappv1</span><span class=p>.</span><span class=nx>WebApp</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-86><a id=__codelineno-29-86 name=__codelineno-29-86 href=#__codelineno-29-86></a><span class=w>    </span><span class=nx>logger</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>log</span><span class=p>.</span><span class=nx>FromContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span><span id=__span-29-87><a id=__codelineno-29-87 name=__codelineno-29-87 href=#__codelineno-29-87></a>
</span><span id=__span-29-88><a id=__codelineno-29-88 name=__codelineno-29-88 href=#__codelineno-29-88></a><span class=w>    </span><span class=nx>desired</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ConfigMap</span><span class=p>{</span>
</span><span id=__span-29-89><a id=__codelineno-29-89 name=__codelineno-29-89 href=#__codelineno-29-89></a><span class=w>        </span><span class=nx>ObjectMeta</span><span class=p>:</span><span class=w> </span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span><span id=__span-29-90><a id=__codelineno-29-90 name=__codelineno-29-90 href=#__codelineno-29-90></a><span class=w>            </span><span class=nx>Name</span><span class=p>:</span><span class=w>      </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;-html&quot;</span><span class=p>,</span>
</span><span id=__span-29-91><a id=__codelineno-29-91 name=__codelineno-29-91 href=#__codelineno-29-91></a><span class=w>            </span><span class=nx>Namespace</span><span class=p>:</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span>
</span><span id=__span-29-92><a id=__codelineno-29-92 name=__codelineno-29-92 href=#__codelineno-29-92></a><span class=w>            </span><span class=nx>Labels</span><span class=p>:</span><span class=w>    </span><span class=nx>labelsForWebApp</span><span class=p>(</span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Name</span><span class=p>),</span>
</span><span id=__span-29-93><a id=__codelineno-29-93 name=__codelineno-29-93 href=#__codelineno-29-93></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-29-94><a id=__codelineno-29-94 name=__codelineno-29-94 href=#__codelineno-29-94></a><span class=w>        </span><span class=nx>Data</span><span class=p>:</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span><span id=__span-29-95><a id=__codelineno-29-95 name=__codelineno-29-95 href=#__codelineno-29-95></a><span class=w>            </span><span class=s>&quot;index.html&quot;</span><span class=p>:</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nx>Sprintf</span><span class=p>(</span><span class=s>`&lt;!DOCTYPE html&gt;</span>
</span><span id=__span-29-96><a id=__codelineno-29-96 name=__codelineno-29-96 href=#__codelineno-29-96></a><span class=s>&lt;html&gt;</span>
</span><span id=__span-29-97><a id=__codelineno-29-97 name=__codelineno-29-97 href=#__codelineno-29-97></a><span class=s>&lt;head&gt;&lt;title&gt;%s&lt;/title&gt;&lt;/head&gt;</span>
</span><span id=__span-29-98><a id=__codelineno-29-98 name=__codelineno-29-98 href=#__codelineno-29-98></a><span class=s>&lt;body&gt;</span>
</span><span id=__span-29-99><a id=__codelineno-29-99 name=__codelineno-29-99 href=#__codelineno-29-99></a><span class=s>  &lt;h1&gt;%s&lt;/h1&gt;</span>
</span><span id=__span-29-100><a id=__codelineno-29-100 name=__codelineno-29-100 href=#__codelineno-29-100></a><span class=s>  &lt;p&gt;Managed by the &lt;strong&gt;WebApp Operator&lt;/strong&gt; | Instance: %s&lt;/p&gt;</span>
</span><span id=__span-29-101><a id=__codelineno-29-101 name=__codelineno-29-101 href=#__codelineno-29-101></a><span class=s>&lt;/body&gt;</span>
</span><span id=__span-29-102><a id=__codelineno-29-102 name=__codelineno-29-102 href=#__codelineno-29-102></a><span class=s>&lt;/html&gt;`</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Message</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Message</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Name</span><span class=p>),</span>
</span><span id=__span-29-103><a id=__codelineno-29-103 name=__codelineno-29-103 href=#__codelineno-29-103></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-29-104><a id=__codelineno-29-104 name=__codelineno-29-104 href=#__codelineno-29-104></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-105><a id=__codelineno-29-105 name=__codelineno-29-105 href=#__codelineno-29-105></a>
</span><span id=__span-29-106><a id=__codelineno-29-106 name=__codelineno-29-106 href=#__codelineno-29-106></a><span class=w>    </span><span class=c1>// Set the WebApp as the owner of the ConfigMap.</span>
</span><span id=__span-29-107><a id=__codelineno-29-107 name=__codelineno-29-107 href=#__codelineno-29-107></a><span class=w>    </span><span class=c1>// When the WebApp CR is deleted, Kubernetes garbage-collects the ConfigMap automatically.</span>
</span><span id=__span-29-108><a id=__codelineno-29-108 name=__codelineno-29-108 href=#__codelineno-29-108></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>SetControllerReference</span><span class=p>(</span><span class=nx>webapp</span><span class=p>,</span><span class=w> </span><span class=nx>desired</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-109><a id=__codelineno-29-109 name=__codelineno-29-109 href=#__codelineno-29-109></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-29-110><a id=__codelineno-29-110 name=__codelineno-29-110 href=#__codelineno-29-110></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-111><a id=__codelineno-29-111 name=__codelineno-29-111 href=#__codelineno-29-111></a>
</span><span id=__span-29-112><a id=__codelineno-29-112 name=__codelineno-29-112 href=#__codelineno-29-112></a><span class=w>    </span><span class=c1>// Fetch the existing ConfigMap</span>
</span><span id=__span-29-113><a id=__codelineno-29-113 name=__codelineno-29-113 href=#__codelineno-29-113></a><span class=w>    </span><span class=nx>existing</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ConfigMap</span><span class=p>{}</span>
</span><span id=__span-29-114><a id=__codelineno-29-114 name=__codelineno-29-114 href=#__codelineno-29-114></a><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span><span class=w> </span><span class=nx>desired</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span><span class=w> </span><span class=nx>Namespace</span><span class=p>:</span><span class=w> </span><span class=nx>desired</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>},</span><span class=w> </span><span class=nx>existing</span><span class=p>)</span>
</span><span id=__span-29-115><a id=__codelineno-29-115 name=__codelineno-29-115 href=#__codelineno-29-115></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=nx>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-116><a id=__codelineno-29-116 name=__codelineno-29-116 href=#__codelineno-29-116></a><span class=w>        </span><span class=nx>logger</span><span class=p>.</span><span class=nx>Info</span><span class=p>(</span><span class=s>&quot;Creating ConfigMap&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;name&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>desired</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span><span id=__span-29-117><a id=__codelineno-29-117 name=__codelineno-29-117 href=#__codelineno-29-117></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Create</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>desired</span><span class=p>)</span>
</span><span id=__span-29-118><a id=__codelineno-29-118 name=__codelineno-29-118 href=#__codelineno-29-118></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-119><a id=__codelineno-29-119 name=__codelineno-29-119 href=#__codelineno-29-119></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-120><a id=__codelineno-29-120 name=__codelineno-29-120 href=#__codelineno-29-120></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-29-121><a id=__codelineno-29-121 name=__codelineno-29-121 href=#__codelineno-29-121></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-122><a id=__codelineno-29-122 name=__codelineno-29-122 href=#__codelineno-29-122></a>
</span><span id=__span-29-123><a id=__codelineno-29-123 name=__codelineno-29-123 href=#__codelineno-29-123></a><span class=w>    </span><span class=c1>// Update if the content has changed</span>
</span><span id=__span-29-124><a id=__codelineno-29-124 name=__codelineno-29-124 href=#__codelineno-29-124></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>existing</span><span class=p>.</span><span class=nx>Data</span><span class=p>[</span><span class=s>&quot;index.html&quot;</span><span class=p>]</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>desired</span><span class=p>.</span><span class=nx>Data</span><span class=p>[</span><span class=s>&quot;index.html&quot;</span><span class=p>]</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-125><a id=__codelineno-29-125 name=__codelineno-29-125 href=#__codelineno-29-125></a><span class=w>        </span><span class=nx>existing</span><span class=p>.</span><span class=nx>Data</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>desired</span><span class=p>.</span><span class=nx>Data</span>
</span><span id=__span-29-126><a id=__codelineno-29-126 name=__codelineno-29-126 href=#__codelineno-29-126></a><span class=w>        </span><span class=nx>logger</span><span class=p>.</span><span class=nx>Info</span><span class=p>(</span><span class=s>&quot;Updating ConfigMap&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;name&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>existing</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span><span id=__span-29-127><a id=__codelineno-29-127 name=__codelineno-29-127 href=#__codelineno-29-127></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>existing</span><span class=p>)</span>
</span><span id=__span-29-128><a id=__codelineno-29-128 name=__codelineno-29-128 href=#__codelineno-29-128></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-129><a id=__codelineno-29-129 name=__codelineno-29-129 href=#__codelineno-29-129></a>
</span><span id=__span-29-130><a id=__codelineno-29-130 name=__codelineno-29-130 href=#__codelineno-29-130></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-29-131><a id=__codelineno-29-131 name=__codelineno-29-131 href=#__codelineno-29-131></a><span class=p>}</span>
</span><span id=__span-29-132><a id=__codelineno-29-132 name=__codelineno-29-132 href=#__codelineno-29-132></a>
</span><span id=__span-29-133><a id=__codelineno-29-133 name=__codelineno-29-133 href=#__codelineno-29-133></a><span class=c1>// ── reconcileDeployment ensures the nginx Deployment exists and matches spec. ──</span>
</span><span id=__span-29-134><a id=__codelineno-29-134 name=__codelineno-29-134 href=#__codelineno-29-134></a>
</span><span id=__span-29-135><a id=__codelineno-29-135 name=__codelineno-29-135 href=#__codelineno-29-135></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>WebAppReconciler</span><span class=p>)</span><span class=w> </span><span class=nx>reconcileDeployment</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=w> </span><span class=o>*</span><span class=nx>webappv1</span><span class=p>.</span><span class=nx>WebApp</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-136><a id=__codelineno-29-136 name=__codelineno-29-136 href=#__codelineno-29-136></a><span class=w>    </span><span class=nx>logger</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>log</span><span class=p>.</span><span class=nx>FromContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span><span id=__span-29-137><a id=__codelineno-29-137 name=__codelineno-29-137 href=#__codelineno-29-137></a>
</span><span id=__span-29-138><a id=__codelineno-29-138 name=__codelineno-29-138 href=#__codelineno-29-138></a><span class=w>    </span><span class=nx>labels</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>labelsForWebApp</span><span class=p>(</span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span><span id=__span-29-139><a id=__codelineno-29-139 name=__codelineno-29-139 href=#__codelineno-29-139></a><span class=w>    </span><span class=nx>replicas</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span>
</span><span id=__span-29-140><a id=__codelineno-29-140 name=__codelineno-29-140 href=#__codelineno-29-140></a>
</span><span id=__span-29-141><a id=__codelineno-29-141 name=__codelineno-29-141 href=#__codelineno-29-141></a><span class=w>    </span><span class=nx>desired</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{</span>
</span><span id=__span-29-142><a id=__codelineno-29-142 name=__codelineno-29-142 href=#__codelineno-29-142></a><span class=w>        </span><span class=nx>ObjectMeta</span><span class=p>:</span><span class=w> </span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span><span id=__span-29-143><a id=__codelineno-29-143 name=__codelineno-29-143 href=#__codelineno-29-143></a><span class=w>            </span><span class=nx>Name</span><span class=p>:</span><span class=w>      </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span><span id=__span-29-144><a id=__codelineno-29-144 name=__codelineno-29-144 href=#__codelineno-29-144></a><span class=w>            </span><span class=nx>Namespace</span><span class=p>:</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span>
</span><span id=__span-29-145><a id=__codelineno-29-145 name=__codelineno-29-145 href=#__codelineno-29-145></a><span class=w>            </span><span class=nx>Labels</span><span class=p>:</span><span class=w>    </span><span class=nx>labels</span><span class=p>,</span>
</span><span id=__span-29-146><a id=__codelineno-29-146 name=__codelineno-29-146 href=#__codelineno-29-146></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-29-147><a id=__codelineno-29-147 name=__codelineno-29-147 href=#__codelineno-29-147></a><span class=w>        </span><span class=nx>Spec</span><span class=p>:</span><span class=w> </span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>DeploymentSpec</span><span class=p>{</span>
</span><span id=__span-29-148><a id=__codelineno-29-148 name=__codelineno-29-148 href=#__codelineno-29-148></a><span class=w>            </span><span class=nx>Replicas</span><span class=p>:</span><span class=w> </span><span class=o>&amp;</span><span class=nx>replicas</span><span class=p>,</span>
</span><span id=__span-29-149><a id=__codelineno-29-149 name=__codelineno-29-149 href=#__codelineno-29-149></a><span class=w>            </span><span class=nx>Selector</span><span class=p>:</span><span class=w> </span><span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>LabelSelector</span><span class=p>{</span><span class=nx>MatchLabels</span><span class=p>:</span><span class=w> </span><span class=nx>labels</span><span class=p>},</span>
</span><span id=__span-29-150><a id=__codelineno-29-150 name=__codelineno-29-150 href=#__codelineno-29-150></a><span class=w>            </span><span class=nx>Template</span><span class=p>:</span><span class=w> </span><span class=nx>corev1</span><span class=p>.</span><span class=nx>PodTemplateSpec</span><span class=p>{</span>
</span><span id=__span-29-151><a id=__codelineno-29-151 name=__codelineno-29-151 href=#__codelineno-29-151></a><span class=w>                </span><span class=nx>ObjectMeta</span><span class=p>:</span><span class=w> </span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span><span class=nx>Labels</span><span class=p>:</span><span class=w> </span><span class=nx>labels</span><span class=p>},</span>
</span><span id=__span-29-152><a id=__codelineno-29-152 name=__codelineno-29-152 href=#__codelineno-29-152></a><span class=w>                </span><span class=nx>Spec</span><span class=p>:</span><span class=w> </span><span class=nx>corev1</span><span class=p>.</span><span class=nx>PodSpec</span><span class=p>{</span>
</span><span id=__span-29-153><a id=__codelineno-29-153 name=__codelineno-29-153 href=#__codelineno-29-153></a><span class=w>                    </span><span class=nx>Containers</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Container</span><span class=p>{</span>
</span><span id=__span-29-154><a id=__codelineno-29-154 name=__codelineno-29-154 href=#__codelineno-29-154></a><span class=w>                        </span><span class=p>{</span>
</span><span id=__span-29-155><a id=__codelineno-29-155 name=__codelineno-29-155 href=#__codelineno-29-155></a><span class=w>                            </span><span class=nx>Name</span><span class=p>:</span><span class=w>            </span><span class=s>&quot;nginx&quot;</span><span class=p>,</span>
</span><span id=__span-29-156><a id=__codelineno-29-156 name=__codelineno-29-156 href=#__codelineno-29-156></a><span class=w>                            </span><span class=nx>Image</span><span class=p>:</span><span class=w>           </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Image</span><span class=p>,</span>
</span><span id=__span-29-157><a id=__codelineno-29-157 name=__codelineno-29-157 href=#__codelineno-29-157></a><span class=w>                            </span><span class=nx>ImagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=nx>corev1</span><span class=p>.</span><span class=nx>PullIfNotPresent</span><span class=p>,</span>
</span><span id=__span-29-158><a id=__codelineno-29-158 name=__codelineno-29-158 href=#__codelineno-29-158></a><span class=w>                            </span><span class=nx>Ports</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ContainerPort</span><span class=p>{</span>
</span><span id=__span-29-159><a id=__codelineno-29-159 name=__codelineno-29-159 href=#__codelineno-29-159></a><span class=w>                                </span><span class=p>{</span><span class=nx>ContainerPort</span><span class=p>:</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Port</span><span class=p>,</span><span class=w> </span><span class=nx>Protocol</span><span class=p>:</span><span class=w> </span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ProtocolTCP</span><span class=p>},</span>
</span><span id=__span-29-160><a id=__codelineno-29-160 name=__codelineno-29-160 href=#__codelineno-29-160></a><span class=w>                            </span><span class=p>},</span>
</span><span id=__span-29-161><a id=__codelineno-29-161 name=__codelineno-29-161 href=#__codelineno-29-161></a><span class=w>                            </span><span class=nx>VolumeMounts</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>VolumeMount</span><span class=p>{</span>
</span><span id=__span-29-162><a id=__codelineno-29-162 name=__codelineno-29-162 href=#__codelineno-29-162></a><span class=w>                                </span><span class=p>{</span>
</span><span id=__span-29-163><a id=__codelineno-29-163 name=__codelineno-29-163 href=#__codelineno-29-163></a><span class=w>                                    </span><span class=nx>Name</span><span class=p>:</span><span class=w>      </span><span class=s>&quot;html&quot;</span><span class=p>,</span>
</span><span id=__span-29-164><a id=__codelineno-29-164 name=__codelineno-29-164 href=#__codelineno-29-164></a><span class=w>                                    </span><span class=nx>MountPath</span><span class=p>:</span><span class=w> </span><span class=s>&quot;/usr/share/nginx/html&quot;</span><span class=p>,</span>
</span><span id=__span-29-165><a id=__codelineno-29-165 name=__codelineno-29-165 href=#__codelineno-29-165></a><span class=w>                                </span><span class=p>},</span>
</span><span id=__span-29-166><a id=__codelineno-29-166 name=__codelineno-29-166 href=#__codelineno-29-166></a><span class=w>                            </span><span class=p>},</span>
</span><span id=__span-29-167><a id=__codelineno-29-167 name=__codelineno-29-167 href=#__codelineno-29-167></a><span class=w>                            </span><span class=nx>ReadinessProbe</span><span class=p>:</span><span class=w> </span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Probe</span><span class=p>{</span>
</span><span id=__span-29-168><a id=__codelineno-29-168 name=__codelineno-29-168 href=#__codelineno-29-168></a><span class=w>                                </span><span class=nx>ProbeHandler</span><span class=p>:</span><span class=w> </span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ProbeHandler</span><span class=p>{</span>
</span><span id=__span-29-169><a id=__codelineno-29-169 name=__codelineno-29-169 href=#__codelineno-29-169></a><span class=w>                                    </span><span class=nx>HTTPGet</span><span class=p>:</span><span class=w> </span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>HTTPGetAction</span><span class=p>{</span>
</span><span id=__span-29-170><a id=__codelineno-29-170 name=__codelineno-29-170 href=#__codelineno-29-170></a><span class=w>                                        </span><span class=nx>Path</span><span class=p>:</span><span class=w> </span><span class=s>&quot;/&quot;</span><span class=p>,</span>
</span><span id=__span-29-171><a id=__codelineno-29-171 name=__codelineno-29-171 href=#__codelineno-29-171></a><span class=w>                                        </span><span class=nx>Port</span><span class=p>:</span><span class=w> </span><span class=nx>intOrString</span><span class=p>(</span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Port</span><span class=p>),</span>
</span><span id=__span-29-172><a id=__codelineno-29-172 name=__codelineno-29-172 href=#__codelineno-29-172></a><span class=w>                                    </span><span class=p>},</span>
</span><span id=__span-29-173><a id=__codelineno-29-173 name=__codelineno-29-173 href=#__codelineno-29-173></a><span class=w>                                </span><span class=p>},</span>
</span><span id=__span-29-174><a id=__codelineno-29-174 name=__codelineno-29-174 href=#__codelineno-29-174></a><span class=w>                                </span><span class=nx>InitialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=mi>5</span><span class=p>,</span>
</span><span id=__span-29-175><a id=__codelineno-29-175 name=__codelineno-29-175 href=#__codelineno-29-175></a><span class=w>                                </span><span class=nx>PeriodSeconds</span><span class=p>:</span><span class=w>       </span><span class=mi>10</span><span class=p>,</span>
</span><span id=__span-29-176><a id=__codelineno-29-176 name=__codelineno-29-176 href=#__codelineno-29-176></a><span class=w>                            </span><span class=p>},</span>
</span><span id=__span-29-177><a id=__codelineno-29-177 name=__codelineno-29-177 href=#__codelineno-29-177></a><span class=w>                            </span><span class=nx>LivenessProbe</span><span class=p>:</span><span class=w> </span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Probe</span><span class=p>{</span>
</span><span id=__span-29-178><a id=__codelineno-29-178 name=__codelineno-29-178 href=#__codelineno-29-178></a><span class=w>                                </span><span class=nx>ProbeHandler</span><span class=p>:</span><span class=w> </span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ProbeHandler</span><span class=p>{</span>
</span><span id=__span-29-179><a id=__codelineno-29-179 name=__codelineno-29-179 href=#__codelineno-29-179></a><span class=w>                                    </span><span class=nx>HTTPGet</span><span class=p>:</span><span class=w> </span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>HTTPGetAction</span><span class=p>{</span>
</span><span id=__span-29-180><a id=__codelineno-29-180 name=__codelineno-29-180 href=#__codelineno-29-180></a><span class=w>                                        </span><span class=nx>Path</span><span class=p>:</span><span class=w> </span><span class=s>&quot;/&quot;</span><span class=p>,</span>
</span><span id=__span-29-181><a id=__codelineno-29-181 name=__codelineno-29-181 href=#__codelineno-29-181></a><span class=w>                                        </span><span class=nx>Port</span><span class=p>:</span><span class=w> </span><span class=nx>intOrString</span><span class=p>(</span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Port</span><span class=p>),</span>
</span><span id=__span-29-182><a id=__codelineno-29-182 name=__codelineno-29-182 href=#__codelineno-29-182></a><span class=w>                                    </span><span class=p>},</span>
</span><span id=__span-29-183><a id=__codelineno-29-183 name=__codelineno-29-183 href=#__codelineno-29-183></a><span class=w>                                </span><span class=p>},</span>
</span><span id=__span-29-184><a id=__codelineno-29-184 name=__codelineno-29-184 href=#__codelineno-29-184></a><span class=w>                                </span><span class=nx>InitialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=mi>15</span><span class=p>,</span>
</span><span id=__span-29-185><a id=__codelineno-29-185 name=__codelineno-29-185 href=#__codelineno-29-185></a><span class=w>                                </span><span class=nx>PeriodSeconds</span><span class=p>:</span><span class=w>       </span><span class=mi>20</span><span class=p>,</span>
</span><span id=__span-29-186><a id=__codelineno-29-186 name=__codelineno-29-186 href=#__codelineno-29-186></a><span class=w>                            </span><span class=p>},</span>
</span><span id=__span-29-187><a id=__codelineno-29-187 name=__codelineno-29-187 href=#__codelineno-29-187></a><span class=w>                        </span><span class=p>},</span>
</span><span id=__span-29-188><a id=__codelineno-29-188 name=__codelineno-29-188 href=#__codelineno-29-188></a><span class=w>                    </span><span class=p>},</span>
</span><span id=__span-29-189><a id=__codelineno-29-189 name=__codelineno-29-189 href=#__codelineno-29-189></a><span class=w>                    </span><span class=nx>Volumes</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Volume</span><span class=p>{</span>
</span><span id=__span-29-190><a id=__codelineno-29-190 name=__codelineno-29-190 href=#__codelineno-29-190></a><span class=w>                        </span><span class=p>{</span>
</span><span id=__span-29-191><a id=__codelineno-29-191 name=__codelineno-29-191 href=#__codelineno-29-191></a><span class=w>                            </span><span class=nx>Name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;html&quot;</span><span class=p>,</span>
</span><span id=__span-29-192><a id=__codelineno-29-192 name=__codelineno-29-192 href=#__codelineno-29-192></a><span class=w>                            </span><span class=nx>VolumeSource</span><span class=p>:</span><span class=w> </span><span class=nx>corev1</span><span class=p>.</span><span class=nx>VolumeSource</span><span class=p>{</span>
</span><span id=__span-29-193><a id=__codelineno-29-193 name=__codelineno-29-193 href=#__codelineno-29-193></a><span class=w>                                </span><span class=nx>ConfigMap</span><span class=p>:</span><span class=w> </span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ConfigMapVolumeSource</span><span class=p>{</span>
</span><span id=__span-29-194><a id=__codelineno-29-194 name=__codelineno-29-194 href=#__codelineno-29-194></a><span class=w>                                    </span><span class=nx>LocalObjectReference</span><span class=p>:</span><span class=w> </span><span class=nx>corev1</span><span class=p>.</span><span class=nx>LocalObjectReference</span><span class=p>{</span>
</span><span id=__span-29-195><a id=__codelineno-29-195 name=__codelineno-29-195 href=#__codelineno-29-195></a><span class=w>                                        </span><span class=nx>Name</span><span class=p>:</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;-html&quot;</span><span class=p>,</span>
</span><span id=__span-29-196><a id=__codelineno-29-196 name=__codelineno-29-196 href=#__codelineno-29-196></a><span class=w>                                    </span><span class=p>},</span>
</span><span id=__span-29-197><a id=__codelineno-29-197 name=__codelineno-29-197 href=#__codelineno-29-197></a><span class=w>                                </span><span class=p>},</span>
</span><span id=__span-29-198><a id=__codelineno-29-198 name=__codelineno-29-198 href=#__codelineno-29-198></a><span class=w>                            </span><span class=p>},</span>
</span><span id=__span-29-199><a id=__codelineno-29-199 name=__codelineno-29-199 href=#__codelineno-29-199></a><span class=w>                        </span><span class=p>},</span>
</span><span id=__span-29-200><a id=__codelineno-29-200 name=__codelineno-29-200 href=#__codelineno-29-200></a><span class=w>                    </span><span class=p>},</span>
</span><span id=__span-29-201><a id=__codelineno-29-201 name=__codelineno-29-201 href=#__codelineno-29-201></a><span class=w>                </span><span class=p>},</span>
</span><span id=__span-29-202><a id=__codelineno-29-202 name=__codelineno-29-202 href=#__codelineno-29-202></a><span class=w>            </span><span class=p>},</span>
</span><span id=__span-29-203><a id=__codelineno-29-203 name=__codelineno-29-203 href=#__codelineno-29-203></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-29-204><a id=__codelineno-29-204 name=__codelineno-29-204 href=#__codelineno-29-204></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-205><a id=__codelineno-29-205 name=__codelineno-29-205 href=#__codelineno-29-205></a>
</span><span id=__span-29-206><a id=__codelineno-29-206 name=__codelineno-29-206 href=#__codelineno-29-206></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>SetControllerReference</span><span class=p>(</span><span class=nx>webapp</span><span class=p>,</span><span class=w> </span><span class=nx>desired</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-207><a id=__codelineno-29-207 name=__codelineno-29-207 href=#__codelineno-29-207></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-29-208><a id=__codelineno-29-208 name=__codelineno-29-208 href=#__codelineno-29-208></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-209><a id=__codelineno-29-209 name=__codelineno-29-209 href=#__codelineno-29-209></a>
</span><span id=__span-29-210><a id=__codelineno-29-210 name=__codelineno-29-210 href=#__codelineno-29-210></a><span class=w>    </span><span class=nx>existing</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{}</span>
</span><span id=__span-29-211><a id=__codelineno-29-211 name=__codelineno-29-211 href=#__codelineno-29-211></a><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span><span class=w> </span><span class=nx>desired</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span><span class=w> </span><span class=nx>Namespace</span><span class=p>:</span><span class=w> </span><span class=nx>desired</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>},</span><span class=w> </span><span class=nx>existing</span><span class=p>)</span>
</span><span id=__span-29-212><a id=__codelineno-29-212 name=__codelineno-29-212 href=#__codelineno-29-212></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=nx>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-213><a id=__codelineno-29-213 name=__codelineno-29-213 href=#__codelineno-29-213></a><span class=w>        </span><span class=nx>logger</span><span class=p>.</span><span class=nx>Info</span><span class=p>(</span><span class=s>&quot;Creating Deployment&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;name&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>desired</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span><span id=__span-29-214><a id=__codelineno-29-214 name=__codelineno-29-214 href=#__codelineno-29-214></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Create</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>desired</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-215><a id=__codelineno-29-215 name=__codelineno-29-215 href=#__codelineno-29-215></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-29-216><a id=__codelineno-29-216 name=__codelineno-29-216 href=#__codelineno-29-216></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-29-217><a id=__codelineno-29-217 name=__codelineno-29-217 href=#__codelineno-29-217></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>desired</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-29-218><a id=__codelineno-29-218 name=__codelineno-29-218 href=#__codelineno-29-218></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-219><a id=__codelineno-29-219 name=__codelineno-29-219 href=#__codelineno-29-219></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-220><a id=__codelineno-29-220 name=__codelineno-29-220 href=#__codelineno-29-220></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-29-221><a id=__codelineno-29-221 name=__codelineno-29-221 href=#__codelineno-29-221></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-222><a id=__codelineno-29-222 name=__codelineno-29-222 href=#__codelineno-29-222></a>
</span><span id=__span-29-223><a id=__codelineno-29-223 name=__codelineno-29-223 href=#__codelineno-29-223></a><span class=w>    </span><span class=c1>// Reconcile mutable fields: replicas and image</span>
</span><span id=__span-29-224><a id=__codelineno-29-224 name=__codelineno-29-224 href=#__codelineno-29-224></a><span class=w>    </span><span class=nx>needsUpdate</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=kc>false</span>
</span><span id=__span-29-225><a id=__codelineno-29-225 name=__codelineno-29-225 href=#__codelineno-29-225></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=o>*</span><span class=nx>existing</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>replicas</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-226><a id=__codelineno-29-226 name=__codelineno-29-226 href=#__codelineno-29-226></a><span class=w>        </span><span class=nx>existing</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>replicas</span>
</span><span id=__span-29-227><a id=__codelineno-29-227 name=__codelineno-29-227 href=#__codelineno-29-227></a><span class=w>        </span><span class=nx>needsUpdate</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>true</span>
</span><span id=__span-29-228><a id=__codelineno-29-228 name=__codelineno-29-228 href=#__codelineno-29-228></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-229><a id=__codelineno-29-229 name=__codelineno-29-229 href=#__codelineno-29-229></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>existing</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Template</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Containers</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Image</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Image</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-230><a id=__codelineno-29-230 name=__codelineno-29-230 href=#__codelineno-29-230></a><span class=w>        </span><span class=nx>existing</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Template</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Containers</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Image</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Image</span>
</span><span id=__span-29-231><a id=__codelineno-29-231 name=__codelineno-29-231 href=#__codelineno-29-231></a><span class=w>        </span><span class=nx>needsUpdate</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>true</span>
</span><span id=__span-29-232><a id=__codelineno-29-232 name=__codelineno-29-232 href=#__codelineno-29-232></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-233><a id=__codelineno-29-233 name=__codelineno-29-233 href=#__codelineno-29-233></a>
</span><span id=__span-29-234><a id=__codelineno-29-234 name=__codelineno-29-234 href=#__codelineno-29-234></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>needsUpdate</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-235><a id=__codelineno-29-235 name=__codelineno-29-235 href=#__codelineno-29-235></a><span class=w>        </span><span class=nx>logger</span><span class=p>.</span><span class=nx>Info</span><span class=p>(</span><span class=s>&quot;Updating Deployment&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;name&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>existing</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span><span id=__span-29-236><a id=__codelineno-29-236 name=__codelineno-29-236 href=#__codelineno-29-236></a><span class=w>            </span><span class=s>&quot;replicas&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>replicas</span><span class=p>,</span><span class=w> </span><span class=s>&quot;image&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Image</span><span class=p>)</span>
</span><span id=__span-29-237><a id=__codelineno-29-237 name=__codelineno-29-237 href=#__codelineno-29-237></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>existing</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-238><a id=__codelineno-29-238 name=__codelineno-29-238 href=#__codelineno-29-238></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-29-239><a id=__codelineno-29-239 name=__codelineno-29-239 href=#__codelineno-29-239></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-29-240><a id=__codelineno-29-240 name=__codelineno-29-240 href=#__codelineno-29-240></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-241><a id=__codelineno-29-241 name=__codelineno-29-241 href=#__codelineno-29-241></a>
</span><span id=__span-29-242><a id=__codelineno-29-242 name=__codelineno-29-242 href=#__codelineno-29-242></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>existing</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-29-243><a id=__codelineno-29-243 name=__codelineno-29-243 href=#__codelineno-29-243></a><span class=p>}</span>
</span><span id=__span-29-244><a id=__codelineno-29-244 name=__codelineno-29-244 href=#__codelineno-29-244></a>
</span><span id=__span-29-245><a id=__codelineno-29-245 name=__codelineno-29-245 href=#__codelineno-29-245></a><span class=c1>// ── reconcileService ensures the Service exists and matches spec. ──────────────</span>
</span><span id=__span-29-246><a id=__codelineno-29-246 name=__codelineno-29-246 href=#__codelineno-29-246></a>
</span><span id=__span-29-247><a id=__codelineno-29-247 name=__codelineno-29-247 href=#__codelineno-29-247></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>WebAppReconciler</span><span class=p>)</span><span class=w> </span><span class=nx>reconcileService</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=w> </span><span class=o>*</span><span class=nx>webappv1</span><span class=p>.</span><span class=nx>WebApp</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-248><a id=__codelineno-29-248 name=__codelineno-29-248 href=#__codelineno-29-248></a><span class=w>    </span><span class=nx>logger</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>log</span><span class=p>.</span><span class=nx>FromContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span><span id=__span-29-249><a id=__codelineno-29-249 name=__codelineno-29-249 href=#__codelineno-29-249></a>
</span><span id=__span-29-250><a id=__codelineno-29-250 name=__codelineno-29-250 href=#__codelineno-29-250></a><span class=w>    </span><span class=nx>labels</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>labelsForWebApp</span><span class=p>(</span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span><span id=__span-29-251><a id=__codelineno-29-251 name=__codelineno-29-251 href=#__codelineno-29-251></a><span class=w>    </span><span class=nx>svcType</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ServiceType</span><span class=p>(</span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ServiceType</span><span class=p>)</span>
</span><span id=__span-29-252><a id=__codelineno-29-252 name=__codelineno-29-252 href=#__codelineno-29-252></a>
</span><span id=__span-29-253><a id=__codelineno-29-253 name=__codelineno-29-253 href=#__codelineno-29-253></a><span class=w>    </span><span class=nx>desired</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Service</span><span class=p>{</span>
</span><span id=__span-29-254><a id=__codelineno-29-254 name=__codelineno-29-254 href=#__codelineno-29-254></a><span class=w>        </span><span class=nx>ObjectMeta</span><span class=p>:</span><span class=w> </span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span><span id=__span-29-255><a id=__codelineno-29-255 name=__codelineno-29-255 href=#__codelineno-29-255></a><span class=w>            </span><span class=nx>Name</span><span class=p>:</span><span class=w>      </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span><span id=__span-29-256><a id=__codelineno-29-256 name=__codelineno-29-256 href=#__codelineno-29-256></a><span class=w>            </span><span class=nx>Namespace</span><span class=p>:</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span>
</span><span id=__span-29-257><a id=__codelineno-29-257 name=__codelineno-29-257 href=#__codelineno-29-257></a><span class=w>            </span><span class=nx>Labels</span><span class=p>:</span><span class=w>    </span><span class=nx>labels</span><span class=p>,</span>
</span><span id=__span-29-258><a id=__codelineno-29-258 name=__codelineno-29-258 href=#__codelineno-29-258></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-29-259><a id=__codelineno-29-259 name=__codelineno-29-259 href=#__codelineno-29-259></a><span class=w>        </span><span class=nx>Spec</span><span class=p>:</span><span class=w> </span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ServiceSpec</span><span class=p>{</span>
</span><span id=__span-29-260><a id=__codelineno-29-260 name=__codelineno-29-260 href=#__codelineno-29-260></a><span class=w>            </span><span class=nx>Selector</span><span class=p>:</span><span class=w> </span><span class=nx>labels</span><span class=p>,</span>
</span><span id=__span-29-261><a id=__codelineno-29-261 name=__codelineno-29-261 href=#__codelineno-29-261></a><span class=w>            </span><span class=nx>Type</span><span class=p>:</span><span class=w>     </span><span class=nx>svcType</span><span class=p>,</span>
</span><span id=__span-29-262><a id=__codelineno-29-262 name=__codelineno-29-262 href=#__codelineno-29-262></a><span class=w>            </span><span class=nx>Ports</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ServicePort</span><span class=p>{</span>
</span><span id=__span-29-263><a id=__codelineno-29-263 name=__codelineno-29-263 href=#__codelineno-29-263></a><span class=w>                </span><span class=p>{</span>
</span><span id=__span-29-264><a id=__codelineno-29-264 name=__codelineno-29-264 href=#__codelineno-29-264></a><span class=w>                    </span><span class=nx>Port</span><span class=p>:</span><span class=w>       </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Port</span><span class=p>,</span>
</span><span id=__span-29-265><a id=__codelineno-29-265 name=__codelineno-29-265 href=#__codelineno-29-265></a><span class=w>                    </span><span class=nx>TargetPort</span><span class=p>:</span><span class=w> </span><span class=nx>intOrString</span><span class=p>(</span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Port</span><span class=p>),</span>
</span><span id=__span-29-266><a id=__codelineno-29-266 name=__codelineno-29-266 href=#__codelineno-29-266></a><span class=w>                    </span><span class=nx>Protocol</span><span class=p>:</span><span class=w>   </span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ProtocolTCP</span><span class=p>,</span>
</span><span id=__span-29-267><a id=__codelineno-29-267 name=__codelineno-29-267 href=#__codelineno-29-267></a><span class=w>                </span><span class=p>},</span>
</span><span id=__span-29-268><a id=__codelineno-29-268 name=__codelineno-29-268 href=#__codelineno-29-268></a><span class=w>            </span><span class=p>},</span>
</span><span id=__span-29-269><a id=__codelineno-29-269 name=__codelineno-29-269 href=#__codelineno-29-269></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-29-270><a id=__codelineno-29-270 name=__codelineno-29-270 href=#__codelineno-29-270></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-271><a id=__codelineno-29-271 name=__codelineno-29-271 href=#__codelineno-29-271></a>
</span><span id=__span-29-272><a id=__codelineno-29-272 name=__codelineno-29-272 href=#__codelineno-29-272></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>SetControllerReference</span><span class=p>(</span><span class=nx>webapp</span><span class=p>,</span><span class=w> </span><span class=nx>desired</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-273><a id=__codelineno-29-273 name=__codelineno-29-273 href=#__codelineno-29-273></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-29-274><a id=__codelineno-29-274 name=__codelineno-29-274 href=#__codelineno-29-274></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-275><a id=__codelineno-29-275 name=__codelineno-29-275 href=#__codelineno-29-275></a>
</span><span id=__span-29-276><a id=__codelineno-29-276 name=__codelineno-29-276 href=#__codelineno-29-276></a><span class=w>    </span><span class=nx>existing</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Service</span><span class=p>{}</span>
</span><span id=__span-29-277><a id=__codelineno-29-277 name=__codelineno-29-277 href=#__codelineno-29-277></a><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span><span class=w> </span><span class=nx>desired</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span><span class=w> </span><span class=nx>Namespace</span><span class=p>:</span><span class=w> </span><span class=nx>desired</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>},</span><span class=w> </span><span class=nx>existing</span><span class=p>)</span>
</span><span id=__span-29-278><a id=__codelineno-29-278 name=__codelineno-29-278 href=#__codelineno-29-278></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=nx>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-279><a id=__codelineno-29-279 name=__codelineno-29-279 href=#__codelineno-29-279></a><span class=w>        </span><span class=nx>logger</span><span class=p>.</span><span class=nx>Info</span><span class=p>(</span><span class=s>&quot;Creating Service&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;name&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>desired</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span><span id=__span-29-280><a id=__codelineno-29-280 name=__codelineno-29-280 href=#__codelineno-29-280></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Create</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>desired</span><span class=p>)</span>
</span><span id=__span-29-281><a id=__codelineno-29-281 name=__codelineno-29-281 href=#__codelineno-29-281></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-282><a id=__codelineno-29-282 name=__codelineno-29-282 href=#__codelineno-29-282></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-283><a id=__codelineno-29-283 name=__codelineno-29-283 href=#__codelineno-29-283></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-29-284><a id=__codelineno-29-284 name=__codelineno-29-284 href=#__codelineno-29-284></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-285><a id=__codelineno-29-285 name=__codelineno-29-285 href=#__codelineno-29-285></a>
</span><span id=__span-29-286><a id=__codelineno-29-286 name=__codelineno-29-286 href=#__codelineno-29-286></a><span class=w>    </span><span class=c1>// Reconcile Service type (immutable field - recreate required)</span>
</span><span id=__span-29-287><a id=__codelineno-29-287 name=__codelineno-29-287 href=#__codelineno-29-287></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>existing</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Type</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>svcType</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-288><a id=__codelineno-29-288 name=__codelineno-29-288 href=#__codelineno-29-288></a><span class=w>        </span><span class=nx>logger</span><span class=p>.</span><span class=nx>Info</span><span class=p>(</span><span class=s>&quot;Recreating Service due to type change&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;old&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>existing</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Type</span><span class=p>,</span><span class=w> </span><span class=s>&quot;new&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>svcType</span><span class=p>)</span>
</span><span id=__span-29-289><a id=__codelineno-29-289 name=__codelineno-29-289 href=#__codelineno-29-289></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Delete</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>existing</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-290><a id=__codelineno-29-290 name=__codelineno-29-290 href=#__codelineno-29-290></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-29-291><a id=__codelineno-29-291 name=__codelineno-29-291 href=#__codelineno-29-291></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-29-292><a id=__codelineno-29-292 name=__codelineno-29-292 href=#__codelineno-29-292></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Create</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>desired</span><span class=p>)</span>
</span><span id=__span-29-293><a id=__codelineno-29-293 name=__codelineno-29-293 href=#__codelineno-29-293></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-294><a id=__codelineno-29-294 name=__codelineno-29-294 href=#__codelineno-29-294></a>
</span><span id=__span-29-295><a id=__codelineno-29-295 name=__codelineno-29-295 href=#__codelineno-29-295></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-29-296><a id=__codelineno-29-296 name=__codelineno-29-296 href=#__codelineno-29-296></a><span class=p>}</span>
</span><span id=__span-29-297><a id=__codelineno-29-297 name=__codelineno-29-297 href=#__codelineno-29-297></a>
</span><span id=__span-29-298><a id=__codelineno-29-298 name=__codelineno-29-298 href=#__codelineno-29-298></a><span class=c1>// ── updateStatus computes and persists the WebApp status. ───────────────────────</span>
</span><span id=__span-29-299><a id=__codelineno-29-299 name=__codelineno-29-299 href=#__codelineno-29-299></a>
</span><span id=__span-29-300><a id=__codelineno-29-300 name=__codelineno-29-300 href=#__codelineno-29-300></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>WebAppReconciler</span><span class=p>)</span><span class=w> </span><span class=nx>updateStatus</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=w> </span><span class=o>*</span><span class=nx>webappv1</span><span class=p>.</span><span class=nx>WebApp</span><span class=p>,</span><span class=w> </span><span class=nx>deployment</span><span class=w> </span><span class=o>*</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-301><a id=__codelineno-29-301 name=__codelineno-29-301 href=#__codelineno-29-301></a><span class=w>    </span><span class=c1>// Work on a copy to avoid mutating the cached object</span>
</span><span id=__span-29-302><a id=__codelineno-29-302 name=__codelineno-29-302 href=#__codelineno-29-302></a><span class=w>    </span><span class=nx>updated</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>DeepCopy</span><span class=p>()</span>
</span><span id=__span-29-303><a id=__codelineno-29-303 name=__codelineno-29-303 href=#__codelineno-29-303></a>
</span><span id=__span-29-304><a id=__codelineno-29-304 name=__codelineno-29-304 href=#__codelineno-29-304></a><span class=w>    </span><span class=nx>available</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>deployment</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>AvailableReplicas</span>
</span><span id=__span-29-305><a id=__codelineno-29-305 name=__codelineno-29-305 href=#__codelineno-29-305></a><span class=w>    </span><span class=nx>ready</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>deployment</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>ReadyReplicas</span>
</span><span id=__span-29-306><a id=__codelineno-29-306 name=__codelineno-29-306 href=#__codelineno-29-306></a>
</span><span id=__span-29-307><a id=__codelineno-29-307 name=__codelineno-29-307 href=#__codelineno-29-307></a><span class=w>    </span><span class=nx>updated</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>AvailableReplicas</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>available</span>
</span><span id=__span-29-308><a id=__codelineno-29-308 name=__codelineno-29-308 href=#__codelineno-29-308></a><span class=w>    </span><span class=nx>updated</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>ReadyReplicas</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ready</span>
</span><span id=__span-29-309><a id=__codelineno-29-309 name=__codelineno-29-309 href=#__codelineno-29-309></a><span class=w>    </span><span class=nx>updated</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>DeploymentName</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>deployment</span><span class=p>.</span><span class=nx>Name</span>
</span><span id=__span-29-310><a id=__codelineno-29-310 name=__codelineno-29-310 href=#__codelineno-29-310></a><span class=w>    </span><span class=nx>updated</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>ServiceName</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Name</span>
</span><span id=__span-29-311><a id=__codelineno-29-311 name=__codelineno-29-311 href=#__codelineno-29-311></a>
</span><span id=__span-29-312><a id=__codelineno-29-312 name=__codelineno-29-312 href=#__codelineno-29-312></a><span class=w>    </span><span class=c1>// Compute phase</span>
</span><span id=__span-29-313><a id=__codelineno-29-313 name=__codelineno-29-313 href=#__codelineno-29-313></a><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-314><a id=__codelineno-29-314 name=__codelineno-29-314 href=#__codelineno-29-314></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>available</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>:</span>
</span><span id=__span-29-315><a id=__codelineno-29-315 name=__codelineno-29-315 href=#__codelineno-29-315></a><span class=w>        </span><span class=nx>updated</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Phase</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>webappv1</span><span class=p>.</span><span class=nx>WebAppPhasePending</span>
</span><span id=__span-29-316><a id=__codelineno-29-316 name=__codelineno-29-316 href=#__codelineno-29-316></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>ready</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=p>:</span>
</span><span id=__span-29-317><a id=__codelineno-29-317 name=__codelineno-29-317 href=#__codelineno-29-317></a><span class=w>        </span><span class=nx>updated</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Phase</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>webappv1</span><span class=p>.</span><span class=nx>WebAppPhaseDegraded</span>
</span><span id=__span-29-318><a id=__codelineno-29-318 name=__codelineno-29-318 href=#__codelineno-29-318></a><span class=w>    </span><span class=k>default</span><span class=p>:</span>
</span><span id=__span-29-319><a id=__codelineno-29-319 name=__codelineno-29-319 href=#__codelineno-29-319></a><span class=w>        </span><span class=nx>updated</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Phase</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>webappv1</span><span class=p>.</span><span class=nx>WebAppPhaseRunning</span>
</span><span id=__span-29-320><a id=__codelineno-29-320 name=__codelineno-29-320 href=#__codelineno-29-320></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-321><a id=__codelineno-29-321 name=__codelineno-29-321 href=#__codelineno-29-321></a>
</span><span id=__span-29-322><a id=__codelineno-29-322 name=__codelineno-29-322 href=#__codelineno-29-322></a><span class=w>    </span><span class=c1>// Set the Available condition</span>
</span><span id=__span-29-323><a id=__codelineno-29-323 name=__codelineno-29-323 href=#__codelineno-29-323></a><span class=w>    </span><span class=nx>availableCond</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Condition</span><span class=p>{</span>
</span><span id=__span-29-324><a id=__codelineno-29-324 name=__codelineno-29-324 href=#__codelineno-29-324></a><span class=w>        </span><span class=nx>Type</span><span class=p>:</span><span class=w>               </span><span class=nx>webappv1</span><span class=p>.</span><span class=nx>ConditionTypeAvailable</span><span class=p>,</span>
</span><span id=__span-29-325><a id=__codelineno-29-325 name=__codelineno-29-325 href=#__codelineno-29-325></a><span class=w>        </span><span class=nx>ObservedGeneration</span><span class=p>:</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Generation</span><span class=p>,</span>
</span><span id=__span-29-326><a id=__codelineno-29-326 name=__codelineno-29-326 href=#__codelineno-29-326></a><span class=w>        </span><span class=nx>LastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Now</span><span class=p>(),</span>
</span><span id=__span-29-327><a id=__codelineno-29-327 name=__codelineno-29-327 href=#__codelineno-29-327></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-328><a id=__codelineno-29-328 name=__codelineno-29-328 href=#__codelineno-29-328></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>available</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-329><a id=__codelineno-29-329 name=__codelineno-29-329 href=#__codelineno-29-329></a><span class=w>        </span><span class=nx>availableCond</span><span class=p>.</span><span class=nx>Status</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ConditionTrue</span>
</span><span id=__span-29-330><a id=__codelineno-29-330 name=__codelineno-29-330 href=#__codelineno-29-330></a><span class=w>        </span><span class=nx>availableCond</span><span class=p>.</span><span class=nx>Reason</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&quot;DeploymentAvailable&quot;</span>
</span><span id=__span-29-331><a id=__codelineno-29-331 name=__codelineno-29-331 href=#__codelineno-29-331></a><span class=w>        </span><span class=nx>availableCond</span><span class=p>.</span><span class=nx>Message</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nx>Sprintf</span><span class=p>(</span><span class=s>&quot;%d/%d replicas are available&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>available</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=p>)</span>
</span><span id=__span-29-332><a id=__codelineno-29-332 name=__codelineno-29-332 href=#__codelineno-29-332></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-333><a id=__codelineno-29-333 name=__codelineno-29-333 href=#__codelineno-29-333></a><span class=w>        </span><span class=nx>availableCond</span><span class=p>.</span><span class=nx>Status</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ConditionFalse</span>
</span><span id=__span-29-334><a id=__codelineno-29-334 name=__codelineno-29-334 href=#__codelineno-29-334></a><span class=w>        </span><span class=nx>availableCond</span><span class=p>.</span><span class=nx>Reason</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&quot;DeploymentUnavailable&quot;</span>
</span><span id=__span-29-335><a id=__codelineno-29-335 name=__codelineno-29-335 href=#__codelineno-29-335></a><span class=w>        </span><span class=nx>availableCond</span><span class=p>.</span><span class=nx>Message</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nx>Sprintf</span><span class=p>(</span><span class=s>&quot;only %d/%d replicas are available&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>available</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=p>)</span>
</span><span id=__span-29-336><a id=__codelineno-29-336 name=__codelineno-29-336 href=#__codelineno-29-336></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-337><a id=__codelineno-29-337 name=__codelineno-29-337 href=#__codelineno-29-337></a><span class=w>    </span><span class=nx>meta</span><span class=p>.</span><span class=nx>SetStatusCondition</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>updated</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Conditions</span><span class=p>,</span><span class=w> </span><span class=nx>availableCond</span><span class=p>)</span>
</span><span id=__span-29-338><a id=__codelineno-29-338 name=__codelineno-29-338 href=#__codelineno-29-338></a>
</span><span id=__span-29-339><a id=__codelineno-29-339 name=__codelineno-29-339 href=#__codelineno-29-339></a><span class=w>    </span><span class=c1>// Only issue an update if anything changed</span>
</span><span id=__span-29-340><a id=__codelineno-29-340 name=__codelineno-29-340 href=#__codelineno-29-340></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>updated</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Phase</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Phase</span><span class=w> </span><span class=o>||</span>
</span><span id=__span-29-341><a id=__codelineno-29-341 name=__codelineno-29-341 href=#__codelineno-29-341></a><span class=w>        </span><span class=nx>updated</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>AvailableReplicas</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>AvailableReplicas</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-342><a id=__codelineno-29-342 name=__codelineno-29-342 href=#__codelineno-29-342></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Status</span><span class=p>().</span><span class=nx>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>updated</span><span class=p>)</span>
</span><span id=__span-29-343><a id=__codelineno-29-343 name=__codelineno-29-343 href=#__codelineno-29-343></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-344><a id=__codelineno-29-344 name=__codelineno-29-344 href=#__codelineno-29-344></a>
</span><span id=__span-29-345><a id=__codelineno-29-345 name=__codelineno-29-345 href=#__codelineno-29-345></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-29-346><a id=__codelineno-29-346 name=__codelineno-29-346 href=#__codelineno-29-346></a><span class=p>}</span>
</span><span id=__span-29-347><a id=__codelineno-29-347 name=__codelineno-29-347 href=#__codelineno-29-347></a>
</span><span id=__span-29-348><a id=__codelineno-29-348 name=__codelineno-29-348 href=#__codelineno-29-348></a><span class=c1>// ── SetupWithManager wires the controller into the manager. ─────────────────────</span>
</span><span id=__span-29-349><a id=__codelineno-29-349 name=__codelineno-29-349 href=#__codelineno-29-349></a>
</span><span id=__span-29-350><a id=__codelineno-29-350 name=__codelineno-29-350 href=#__codelineno-29-350></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>WebAppReconciler</span><span class=p>)</span><span class=w> </span><span class=nx>SetupWithManager</span><span class=p>(</span><span class=nx>mgr</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Manager</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-351><a id=__codelineno-29-351 name=__codelineno-29-351 href=#__codelineno-29-351></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>NewControllerManagedBy</span><span class=p>(</span><span class=nx>mgr</span><span class=p>).</span>
</span><span id=__span-29-352><a id=__codelineno-29-352 name=__codelineno-29-352 href=#__codelineno-29-352></a><span class=w>        </span><span class=c1>// Primary watch: WebApp CRs</span>
</span><span id=__span-29-353><a id=__codelineno-29-353 name=__codelineno-29-353 href=#__codelineno-29-353></a><span class=w>        </span><span class=nx>For</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>webappv1</span><span class=p>.</span><span class=nx>WebApp</span><span class=p>{}).</span>
</span><span id=__span-29-354><a id=__codelineno-29-354 name=__codelineno-29-354 href=#__codelineno-29-354></a><span class=w>        </span><span class=c1>// Secondary watches: owned resources - any change triggers reconciliation</span>
</span><span id=__span-29-355><a id=__codelineno-29-355 name=__codelineno-29-355 href=#__codelineno-29-355></a><span class=w>        </span><span class=nx>Owns</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{}).</span>
</span><span id=__span-29-356><a id=__codelineno-29-356 name=__codelineno-29-356 href=#__codelineno-29-356></a><span class=w>        </span><span class=nx>Owns</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Service</span><span class=p>{}).</span>
</span><span id=__span-29-357><a id=__codelineno-29-357 name=__codelineno-29-357 href=#__codelineno-29-357></a><span class=w>        </span><span class=nx>Owns</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ConfigMap</span><span class=p>{}).</span>
</span><span id=__span-29-358><a id=__codelineno-29-358 name=__codelineno-29-358 href=#__codelineno-29-358></a><span class=w>        </span><span class=nx>Complete</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span><span id=__span-29-359><a id=__codelineno-29-359 name=__codelineno-29-359 href=#__codelineno-29-359></a><span class=p>}</span>
</span><span id=__span-29-360><a id=__codelineno-29-360 name=__codelineno-29-360 href=#__codelineno-29-360></a>
</span><span id=__span-29-361><a id=__codelineno-29-361 name=__codelineno-29-361 href=#__codelineno-29-361></a><span class=c1>// ── Helpers ───────────────────────────────────────────────────────────────────────</span>
</span><span id=__span-29-362><a id=__codelineno-29-362 name=__codelineno-29-362 href=#__codelineno-29-362></a>
</span><span id=__span-29-363><a id=__codelineno-29-363 name=__codelineno-29-363 href=#__codelineno-29-363></a><span class=kd>func</span><span class=w> </span><span class=nx>labelsForWebApp</span><span class=p>(</span><span class=nx>name</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-364><a id=__codelineno-29-364 name=__codelineno-29-364 href=#__codelineno-29-364></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span><span id=__span-29-365><a id=__codelineno-29-365 name=__codelineno-29-365 href=#__codelineno-29-365></a><span class=w>        </span><span class=s>&quot;app.kubernetes.io/name&quot;</span><span class=p>:</span><span class=w>       </span><span class=s>&quot;webapp&quot;</span><span class=p>,</span>
</span><span id=__span-29-366><a id=__codelineno-29-366 name=__codelineno-29-366 href=#__codelineno-29-366></a><span class=w>        </span><span class=s>&quot;app.kubernetes.io/instance&quot;</span><span class=p>:</span><span class=w>   </span><span class=nx>name</span><span class=p>,</span>
</span><span id=__span-29-367><a id=__codelineno-29-367 name=__codelineno-29-367 href=#__codelineno-29-367></a><span class=w>        </span><span class=s>&quot;app.kubernetes.io/managed-by&quot;</span><span class=p>:</span><span class=w> </span><span class=s>&quot;webapp-operator&quot;</span><span class=p>,</span>
</span><span id=__span-29-368><a id=__codelineno-29-368 name=__codelineno-29-368 href=#__codelineno-29-368></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-369><a id=__codelineno-29-369 name=__codelineno-29-369 href=#__codelineno-29-369></a><span class=p>}</span>
</span><span id=__span-29-370><a id=__codelineno-29-370 name=__codelineno-29-370 href=#__codelineno-29-370></a>
</span><span id=__span-29-371><a id=__codelineno-29-371 name=__codelineno-29-371 href=#__codelineno-29-371></a><span class=kd>func</span><span class=w> </span><span class=nx>intOrString</span><span class=p>(</span><span class=nx>port</span><span class=w> </span><span class=kt>int32</span><span class=p>)</span><span class=w> </span><span class=nx>intstr</span><span class=p>.</span><span class=nx>IntOrString</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-372><a id=__codelineno-29-372 name=__codelineno-29-372 href=#__codelineno-29-372></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>intstr</span><span class=p>.</span><span class=nx>FromInt32</span><span class=p>(</span><span class=nx>port</span><span class=p>)</span>
</span><span id=__span-29-373><a id=__codelineno-29-373 name=__codelineno-29-373 href=#__codelineno-29-373></a><span class=p>}</span>
</span></code></pre></div> <div class="admonition tip"> <p class=admonition-title>Add the missing import</p> <p>The <code>intOrString</code> helper uses <code>k8s.io/apimachinery/pkg/util/intstr</code>. Add it to the import block: <div class="language-go highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=s>&quot;k8s.io/apimachinery/pkg/util/intstr&quot;</span>
</span></code></pre></div></p> </div> <h3 id=understanding-the-reconcile-loop>Understanding the Reconcile Loop<a class=headerlink href=#understanding-the-reconcile-loop title="Permanent link">&para;</a></h3> <pre class=mermaid><code>flowchart TD
    trigger["Event: WebApp changed\nor Deployment / Service / ConfigMap changed"]
    --&gt;fetch["r.Get(ctx, req, &amp;webapp)\nFetch current desired state"]
    --&gt;notfound{Not found?}
    notfound --&gt;|yes| done["return - resource deleted, nothing to do"]
    notfound --&gt;|no| cm["reconcileConfigMap()\nCreate or update HTML ConfigMap"]
    --&gt;dep["reconcileDeployment()\nCreate or update nginx Deployment"]
    --&gt;svc["reconcileService()\nCreate or update Service"]
    --&gt;status["updateStatus()\nCompute phase + conditions\nr.Status().Update()"]
    --&gt;requeue["return ctrl.Result{}"]</code></pre> <h3 id=key-controller-runtime-concepts>Key controller-runtime Concepts<a class=headerlink href=#key-controller-runtime-concepts title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>Concept</th> <th>Code</th> <th>Explanation</th> </tr> </thead> <tbody> <tr> <td><strong>Fetch CR</strong></td> <td><code>r.Get(ctx, req.NamespacedName, webapp)</code></td> <td>Always read fresh from API server</td> </tr> <tr> <td><strong>IsNotFound</strong></td> <td><code>errors.IsNotFound(err)</code></td> <td>Distinguish &ldquo;doesn&rsquo;t exist&rdquo; from real errors</td> </tr> <tr> <td><strong>Owner reference</strong></td> <td><code>ctrl.SetControllerReference(webapp, child, r.Scheme)</code></td> <td>Garbage-collect child when parent deleted</td> </tr> <tr> <td><strong>Status update</strong></td> <td><code>r.Status().Update(ctx, updated)</code></td> <td>Use the status subresource, not <code>r.Update</code></td> </tr> <tr> <td><strong>Watch child</strong></td> <td><code>.Owns(&amp;appsv1.Deployment{})</code></td> <td>Re-queue parent when child changes</td> </tr> <tr> <td><strong>Logger</strong></td> <td><code>log.FromContext(ctx)</code></td> <td>Context-scoped structured logger</td> </tr> </tbody> </table> <hr> <h2 id=part-06-install-crds-and-run-locally>Part 06 - Install CRDs and Run Locally<a class=headerlink href=#part-06-install-crds-and-run-locally title="Permanent link">&para;</a></h2> <h3 id=0601-install-crds-into-the-cluster>06.01 Install CRDs into the cluster<a class=headerlink href=#0601-install-crds-into-the-cluster title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=c1># Generate manifests from markers</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a>make<span class=w> </span>manifests
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=c1># Apply CRDs to the cluster</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a>make<span class=w> </span>install
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a><span class=c1># Verify</span>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a>kubectl<span class=w> </span>get<span class=w> </span>crds<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>codewizard
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a>kubectl<span class=w> </span>describe<span class=w> </span>crd<span class=w> </span>webapps.apps.codewizard.io<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-A<span class=w> </span><span class=m>20</span><span class=w> </span><span class=s2>&quot;COLUMNS\|Validation&quot;</span>
</span></code></pre></div> <h3 id=0602-verify-the-short-name-works>06.02 Verify the short name works<a class=headerlink href=#0602-verify-the-short-name-works title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=c1># The //+kubebuilder:resource:shortName=wa marker enables this</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a>kubectl<span class=w> </span>get<span class=w> </span>wa
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=c1># No resources found in default namespace.</span>
</span></code></pre></div> <h3 id=0603-run-the-controller-locally>06.03 Run the controller locally<a class=headerlink href=#0603-run-the-controller-locally title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a>make<span class=w> </span>run
</span></code></pre></div> <p>You will see logs like:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a>INFO    Starting manager
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a>INFO    Starting Controller    {&quot;controller&quot;: &quot;webapp&quot;}
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a>INFO    Starting workers       {&quot;controller&quot;: &quot;webapp&quot;, &quot;worker count&quot;: 1}
</span></code></pre></div> <p>Leave this running in one terminal and open a second terminal for the next steps.</p> <hr> <h2 id=part-07-create-your-first-webapp-cr>Part 07 - Create Your First WebApp CR<a class=headerlink href=#part-07-create-your-first-webapp-cr title="Permanent link">&para;</a></h2> <h3 id=0701-apply-the-sample-cr>07.01 Apply the sample CR<a class=headerlink href=#0701-apply-the-sample-cr title="Permanent link">&para;</a></h3> <p>Create <code>config/samples/apps_v1_webapp.yaml</code>:</p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps.codewizard.io/v1</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">WebApp</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my-webapp</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx:1.25.3</span>
</span><span id=__span-35-9><a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=w>  </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Hello</span><span class=nv> </span><span class=s>from</span><span class=nv> </span><span class=s>the</span><span class=nv> </span><span class=s>WebApp</span><span class=nv> </span><span class=s>Operator!&quot;</span>
</span><span id=__span-35-10><a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id=__span-35-11><a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a><span class=w>  </span><span class=nt>serviceType</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
</span></code></pre></div> <div class="language-bash highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>config/samples/apps_v1_webapp.yaml
</span></code></pre></div> <h3 id=0702-watch-the-controller-create-child-resources>07.02 Watch the controller create child resources<a class=headerlink href=#0702-watch-the-controller-create-child-resources title="Permanent link">&para;</a></h3> <p>In your second terminal:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=c1># Watch pods appear</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-l<span class=w> </span>app.kubernetes.io/name<span class=o>=</span>webapp<span class=w> </span>-w
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=c1># Check all resources created by the operator</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a>kubectl<span class=w> </span>get<span class=w> </span>deployment,service,configmap<span class=w> </span>-l<span class=w> </span>app.kubernetes.io/managed-by<span class=o>=</span>webapp-operator
</span></code></pre></div> <p>Expected output:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a>NAME                          READY   UP-TO-DATE   AVAILABLE
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a>deployment.apps/my-webapp     2/2     2            2
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a>NAME                 TYPE        CLUSTER-IP     PORT(S)
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a>service/my-webapp    ClusterIP   10.96.x.x      80/TCP
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a>
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a>NAME                          DATA
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a>configmap/my-webapp-html      1
</span></code></pre></div> <h3 id=0703-inspect-the-webapp-status>07.03 Inspect the WebApp status<a class=headerlink href=#0703-inspect-the-webapp-status title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a>kubectl<span class=w> </span>get<span class=w> </span>wa
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=c1># Output (notice the printer columns from our markers):</span>
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=c1># NAME        REPLICAS   AVAILABLE   PHASE     IMAGE           AGE</span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=c1># my-webapp   2          2           Running   nginx:1.25.3    30s</span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a>
</span><span id=__span-39-7><a id=__codelineno-39-7 name=__codelineno-39-7 href=#__codelineno-39-7></a><span class=c1># Full status</span>
</span><span id=__span-39-8><a id=__codelineno-39-8 name=__codelineno-39-8 href=#__codelineno-39-8></a>kubectl<span class=w> </span>get<span class=w> </span>wa<span class=w> </span>my-webapp<span class=w> </span>-o<span class=w> </span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status}&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>jq<span class=w> </span>.
</span><span id=__span-39-9><a id=__codelineno-39-9 name=__codelineno-39-9 href=#__codelineno-39-9></a>
</span><span id=__span-39-10><a id=__codelineno-39-10 name=__codelineno-39-10 href=#__codelineno-39-10></a><span class=c1># Check conditions</span>
</span><span id=__span-39-11><a id=__codelineno-39-11 name=__codelineno-39-11 href=#__codelineno-39-11></a>kubectl<span class=w> </span>get<span class=w> </span>wa<span class=w> </span>my-webapp<span class=w> </span>-o<span class=w> </span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.conditions}&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>jq<span class=w> </span>.
</span></code></pre></div> <h3 id=0704-test-the-application>07.04 Test the application<a class=headerlink href=#0704-test-the-application title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a>kubectl<span class=w> </span>port-forward<span class=w> </span>svc/my-webapp<span class=w> </span><span class=m>8080</span>:80<span class=w> </span><span class=p>&amp;</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a>sleep<span class=w> </span><span class=m>2</span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a>curl<span class=w> </span>http://localhost:8080
</span></code></pre></div> <p>Expected:</p> <div class="language-html highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Hello from the WebApp Operator!<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span><span id=__span-41-5><a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a>  <span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>Hello from the WebApp Operator!<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span><span id=__span-41-6><a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a>  <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Managed by the <span class=p>&lt;</span><span class=nt>strong</span><span class=p>&gt;</span>WebApp Operator<span class=p>&lt;/</span><span class=nt>strong</span><span class=p>&gt;</span> | Instance: my-webapp<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span><span id=__span-41-7><a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span><span id=__span-41-8><a id=__codelineno-41-8 name=__codelineno-41-8 href=#__codelineno-41-8></a><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></code></pre></div> <div class="language-bash highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=nb>kill</span><span class=w> </span>%1<span class=w>  </span><span class=c1># stop port-forward</span>
</span></code></pre></div> <hr> <h2 id=part-08-self-healing-the-reconciler-restores-deleted-resources>Part 08 - Self-Healing: The Reconciler Restores Deleted Resources<a class=headerlink href=#part-08-self-healing-the-reconciler-restores-deleted-resources title="Permanent link">&para;</a></h2> <p>This is one of the most powerful operator features: if someone manually deletes or modifies a child resource, the operator recreates it immediately.</p> <h3 id=0801-delete-the-deployment-manually>08.01 Delete the Deployment manually<a class=headerlink href=#0801-delete-the-deployment-manually title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a>kubectl<span class=w> </span>delete<span class=w> </span>deployment<span class=w> </span>my-webapp
</span></code></pre></div> <h3 id=0802-watch-the-operator-restore-it>08.02 Watch the operator restore it<a class=headerlink href=#0802-watch-the-operator-restore-it title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=c1># In the `make run` terminal you will see:</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a><span class=c1># INFO    Reconciling WebApp    {&quot;name&quot;: &quot;my-webapp&quot;}</span>
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a><span class=c1># INFO    Creating Deployment   {&quot;name&quot;: &quot;my-webapp&quot;}</span>
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a>
</span><span id=__span-44-5><a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a>kubectl<span class=w> </span>get<span class=w> </span>deployment<span class=w> </span>my-webapp
</span><span id=__span-44-6><a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a><span class=c1># NAME        READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span><span id=__span-44-7><a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a><span class=c1># my-webapp   2/2     2            2           5s</span>
</span></code></pre></div> <p>The deployment was recreated in seconds by the reconcile loop.</p> <h3 id=0803-why-does-this-work>08.03 Why does this work?<a class=headerlink href=#0803-why-does-this-work title="Permanent link">&para;</a></h3> <p>When <code>.Owns(&amp;appsv1.Deployment{})</code> is set in <code>SetupWithManager</code>, controller-runtime watches all Deployments that have an owner reference pointing to a <code>WebApp</code>. Any change (including deletion) enqueues the parent <code>WebApp</code> for reconciliation.</p> <hr> <h2 id=part-09-update-the-cr-and-observe-reconciliation>Part 09 - Update the CR and Observe Reconciliation<a class=headerlink href=#part-09-update-the-cr-and-observe-reconciliation title="Permanent link">&para;</a></h2> <h3 id=0901-scale-up-to-4-replicas>09.01 Scale up to 4 replicas<a class=headerlink href=#0901-scale-up-to-4-replicas title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a>kubectl<span class=w> </span>patch<span class=w> </span>wa<span class=w> </span>my-webapp<span class=w> </span>--type<span class=o>=</span>merge<span class=w> </span>-p<span class=w> </span><span class=s1>&#39;{&quot;spec&quot;:{&quot;replicas&quot;:4}}&#39;</span>
</span></code></pre></div> <h3 id=0902-watch-the-deployment-scale>09.02 Watch the Deployment scale<a class=headerlink href=#0902-watch-the-deployment-scale title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-l<span class=w> </span>app.kubernetes.io/name<span class=o>=</span>webapp<span class=w> </span>-w
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a><span class=c1># NAME              READY   STATUS    ...</span>
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a><span class=c1># my-webapp-xxx     1/1     Running</span>
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a><span class=c1># my-webapp-yyy     1/1     Running</span>
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a><span class=c1># my-webapp-zzz     1/1     Running   ← new</span>
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a><span class=c1># my-webapp-aaa     1/1     Running   ← new</span>
</span><span id=__span-46-7><a id=__codelineno-46-7 name=__codelineno-46-7 href=#__codelineno-46-7></a>
</span><span id=__span-46-8><a id=__codelineno-46-8 name=__codelineno-46-8 href=#__codelineno-46-8></a>kubectl<span class=w> </span>get<span class=w> </span>wa<span class=w> </span>my-webapp
</span><span id=__span-46-9><a id=__codelineno-46-9 name=__codelineno-46-9 href=#__codelineno-46-9></a><span class=c1># NAME        REPLICAS   AVAILABLE   PHASE     ...</span>
</span><span id=__span-46-10><a id=__codelineno-46-10 name=__codelineno-46-10 href=#__codelineno-46-10></a><span class=c1># my-webapp   4          4           Running</span>
</span></code></pre></div> <h3 id=0903-update-the-message>09.03 Update the message<a class=headerlink href=#0903-update-the-message title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a>kubectl<span class=w> </span>patch<span class=w> </span>wa<span class=w> </span>my-webapp<span class=w> </span>--type<span class=o>=</span>merge<span class=w> </span><span class=se>\</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=w>    </span>-p<span class=w> </span><span class=s1>&#39;{&quot;spec&quot;:{&quot;message&quot;:&quot;Updated by the operator!&quot;}}&#39;</span>
</span></code></pre></div> <div class="language-bash highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a>kubectl<span class=w> </span>port-forward<span class=w> </span>svc/my-webapp<span class=w> </span><span class=m>8080</span>:80<span class=w> </span><span class=p>&amp;</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a>sleep<span class=w> </span><span class=m>2</span>
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a>curl<span class=w> </span>http://localhost:8080<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s2>&quot;Updated&quot;</span>
</span><span id=__span-48-4><a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a><span class=nb>kill</span><span class=w> </span>%1
</span></code></pre></div> <h3 id=0904-update-the-image>09.04 Update the image<a class=headerlink href=#0904-update-the-image title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a>kubectl<span class=w> </span>patch<span class=w> </span>wa<span class=w> </span>my-webapp<span class=w> </span>--type<span class=o>=</span>merge<span class=w> </span><span class=se>\</span>
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=w>    </span>-p<span class=w> </span><span class=s1>&#39;{&quot;spec&quot;:{&quot;image&quot;:&quot;nginx:1.26.0&quot;}}&#39;</span>
</span><span id=__span-49-3><a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a>
</span><span id=__span-49-4><a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a>kubectl<span class=w> </span>get<span class=w> </span>deployment<span class=w> </span>my-webapp<span class=w> </span>-o<span class=w> </span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.spec.template.spec.containers[0].image}&#39;</span>
</span><span id=__span-49-5><a id=__codelineno-49-5 name=__codelineno-49-5 href=#__codelineno-49-5></a><span class=c1># nginx:1.26.0</span>
</span></code></pre></div> <hr> <h2 id=part-10-add-a-finalizer-for-cleanup-logic>Part 10 - Add a Finalizer for Cleanup Logic<a class=headerlink href=#part-10-add-a-finalizer-for-cleanup-logic title="Permanent link">&para;</a></h2> <p>Finalizers let you run custom cleanup code before the resource is actually deleted from etcd.</p> <h3 id=1001-add-the-finalizer-constant>10.01 Add the finalizer constant<a class=headerlink href=#1001-add-the-finalizer-constant title="Permanent link">&para;</a></h3> <p>In <code>internal/controller/webapp_controller.go</code> add:</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a><span class=kd>const</span><span class=w> </span><span class=nx>webappFinalizer</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&quot;apps.codewizard.io/finalizer&quot;</span>
</span></code></pre></div> <h3 id=1002-add-finalizer-handling-to-reconcile>10.02 Add finalizer handling to Reconcile<a class=headerlink href=#1002-add-finalizer-handling-to-reconcile title="Permanent link">&para;</a></h3> <p>Insert this block at the <strong>beginning</strong> of the <code>Reconcile()</code> function, after fetching the WebApp:</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=c1>// ── Finalizer handling ────────────────────────────────────────────────────────</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=k>if</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>DeletionTimestamp</span><span class=p>.</span><span class=nx>IsZero</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a><span class=w>    </span><span class=c1>// Not being deleted - ensure finalizer is present</span>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>controllerutil</span><span class=p>.</span><span class=nx>ContainsFinalizer</span><span class=p>(</span><span class=nx>webapp</span><span class=p>,</span><span class=w> </span><span class=nx>webappFinalizer</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a><span class=w>        </span><span class=nx>controllerutil</span><span class=p>.</span><span class=nx>AddFinalizer</span><span class=p>(</span><span class=nx>webapp</span><span class=p>,</span><span class=w> </span><span class=nx>webappFinalizer</span><span class=p>)</span>
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-51-8><a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-51-9><a id=__codelineno-51-9 name=__codelineno-51-9 href=#__codelineno-51-9></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=kc>nil</span><span class=w>  </span><span class=c1>// re-queue after update</span>
</span><span id=__span-51-10><a id=__codelineno-51-10 name=__codelineno-51-10 href=#__codelineno-51-10></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-51-11><a id=__codelineno-51-11 name=__codelineno-51-11 href=#__codelineno-51-11></a><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-51-12><a id=__codelineno-51-12 name=__codelineno-51-12 href=#__codelineno-51-12></a><span class=w>    </span><span class=c1>// Being deleted - run cleanup before allowing deletion</span>
</span><span id=__span-51-13><a id=__codelineno-51-13 name=__codelineno-51-13 href=#__codelineno-51-13></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>controllerutil</span><span class=p>.</span><span class=nx>ContainsFinalizer</span><span class=p>(</span><span class=nx>webapp</span><span class=p>,</span><span class=w> </span><span class=nx>webappFinalizer</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-51-14><a id=__codelineno-51-14 name=__codelineno-51-14 href=#__codelineno-51-14></a><span class=w>        </span><span class=nx>logger</span><span class=p>.</span><span class=nx>Info</span><span class=p>(</span><span class=s>&quot;Running finalizer cleanup&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;name&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span><span id=__span-51-15><a id=__codelineno-51-15 name=__codelineno-51-15 href=#__codelineno-51-15></a><span class=w>        </span><span class=c1>// (perform any external cleanup here, e.g. cloud resources, DNS records)</span>
</span><span id=__span-51-16><a id=__codelineno-51-16 name=__codelineno-51-16 href=#__codelineno-51-16></a>
</span><span id=__span-51-17><a id=__codelineno-51-17 name=__codelineno-51-17 href=#__codelineno-51-17></a><span class=w>        </span><span class=c1>// Remove finalizer - Kubernetes will then delete the object</span>
</span><span id=__span-51-18><a id=__codelineno-51-18 name=__codelineno-51-18 href=#__codelineno-51-18></a><span class=w>        </span><span class=nx>controllerutil</span><span class=p>.</span><span class=nx>RemoveFinalizer</span><span class=p>(</span><span class=nx>webapp</span><span class=p>,</span><span class=w> </span><span class=nx>webappFinalizer</span><span class=p>)</span>
</span><span id=__span-51-19><a id=__codelineno-51-19 name=__codelineno-51-19 href=#__codelineno-51-19></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-51-20><a id=__codelineno-51-20 name=__codelineno-51-20 href=#__codelineno-51-20></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-51-21><a id=__codelineno-51-21 name=__codelineno-51-21 href=#__codelineno-51-21></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-51-22><a id=__codelineno-51-22 name=__codelineno-51-22 href=#__codelineno-51-22></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-51-23><a id=__codelineno-51-23 name=__codelineno-51-23 href=#__codelineno-51-23></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-51-24><a id=__codelineno-51-24 name=__codelineno-51-24 href=#__codelineno-51-24></a><span class=p>}</span>
</span></code></pre></div> <p>Add <code>"sigs.k8s.io/controller-runtime/pkg/controller/controllerutil"</code> to imports.</p> <h3 id=1003-test-the-finalizer>10.03 Test the finalizer<a class=headerlink href=#1003-test-the-finalizer title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=c1># Delete the WebApp</span>
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a>kubectl<span class=w> </span>delete<span class=w> </span>wa<span class=w> </span>my-webapp
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a>
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a><span class=c1># Before the finalizer is removed, the object shows DeletionTimestamp</span>
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a>kubectl<span class=w> </span>get<span class=w> </span>wa<span class=w> </span>my-webapp<span class=w> </span>-o<span class=w> </span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.metadata.deletionTimestamp}&#39;</span>
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a>
</span><span id=__span-52-7><a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a><span class=c1># After cleanup the object and all owned resources disappear</span>
</span><span id=__span-52-8><a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a>kubectl<span class=w> </span>get<span class=w> </span>deployment,service,configmap<span class=w> </span>-l<span class=w> </span>app.kubernetes.io/managed-by<span class=o>=</span>webapp-operator
</span><span id=__span-52-9><a id=__codelineno-52-9 name=__codelineno-52-9 href=#__codelineno-52-9></a><span class=c1># No resources found.</span>
</span></code></pre></div> <hr> <h2 id=part-11-add-a-validation-webhook>Part 11 - Add a Validation Webhook<a class=headerlink href=#part-11-add-a-validation-webhook title="Permanent link">&para;</a></h2> <p>Webhooks intercept API calls to validate or mutate resources <strong>before</strong> they are persisted to etcd.</p> <h3 id=1101-scaffold-the-webhook>11.01 Scaffold the webhook<a class=headerlink href=#1101-scaffold-the-webhook title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a>kubebuilder<span class=w> </span>create<span class=w> </span>webhook<span class=w> </span><span class=se>\</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=w>    </span>--group<span class=w> </span>apps<span class=w> </span><span class=se>\</span>
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a><span class=w>    </span>--version<span class=w> </span>v1<span class=w> </span><span class=se>\</span>
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=w>    </span>--kind<span class=w> </span>WebApp<span class=w> </span><span class=se>\</span>
</span><span id=__span-53-5><a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a><span class=w>    </span>--defaulting<span class=w> </span><span class=se>\</span>
</span><span id=__span-53-6><a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a><span class=w>    </span>--programmatic-validation
</span></code></pre></div> <p>This creates <code>api/v1/webapp_webhook.go</code>.</p> <h3 id=1102-implement-defaulting-mutating-webhook>11.02 Implement defaulting (mutating webhook)<a class=headerlink href=#1102-implement-defaulting-mutating-webhook title="Permanent link">&para;</a></h3> <p>In <code>api/v1/webapp_webhook.go</code>, implement the <code>Default()</code> method:</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>WebApp</span><span class=p>)</span><span class=w> </span><span class=nx>Default</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-2><a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a><span class=w>    </span><span class=nx>log</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>logf</span><span class=p>.</span><span class=nx>Log</span><span class=p>.</span><span class=nx>WithName</span><span class=p>(</span><span class=s>&quot;webapp-resource&quot;</span><span class=p>)</span>
</span><span id=__span-54-3><a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a><span class=w>    </span><span class=nx>log</span><span class=p>.</span><span class=nx>Info</span><span class=p>(</span><span class=s>&quot;Applying defaults&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;name&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span><span id=__span-54-4><a id=__codelineno-54-4 name=__codelineno-54-4 href=#__codelineno-54-4></a>
</span><span id=__span-54-5><a id=__codelineno-54-5 name=__codelineno-54-5 href=#__codelineno-54-5></a><span class=w>    </span><span class=c1>// Set default image if not provided</span>
</span><span id=__span-54-6><a id=__codelineno-54-6 name=__codelineno-54-6 href=#__codelineno-54-6></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Image</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-7><a id=__codelineno-54-7 name=__codelineno-54-7 href=#__codelineno-54-7></a><span class=w>        </span><span class=nx>r</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Image</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&quot;nginx:1.25.3&quot;</span>
</span><span id=__span-54-8><a id=__codelineno-54-8 name=__codelineno-54-8 href=#__codelineno-54-8></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-54-9><a id=__codelineno-54-9 name=__codelineno-54-9 href=#__codelineno-54-9></a>
</span><span id=__span-54-10><a id=__codelineno-54-10 name=__codelineno-54-10 href=#__codelineno-54-10></a><span class=w>    </span><span class=c1>// Set default replicas</span>
</span><span id=__span-54-11><a id=__codelineno-54-11 name=__codelineno-54-11 href=#__codelineno-54-11></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-12><a id=__codelineno-54-12 name=__codelineno-54-12 href=#__codelineno-54-12></a><span class=w>        </span><span class=nx>r</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>1</span>
</span><span id=__span-54-13><a id=__codelineno-54-13 name=__codelineno-54-13 href=#__codelineno-54-13></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-54-14><a id=__codelineno-54-14 name=__codelineno-54-14 href=#__codelineno-54-14></a>
</span><span id=__span-54-15><a id=__codelineno-54-15 name=__codelineno-54-15 href=#__codelineno-54-15></a><span class=w>    </span><span class=c1>// Set default port</span>
</span><span id=__span-54-16><a id=__codelineno-54-16 name=__codelineno-54-16 href=#__codelineno-54-16></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Port</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-17><a id=__codelineno-54-17 name=__codelineno-54-17 href=#__codelineno-54-17></a><span class=w>        </span><span class=nx>r</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Port</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>80</span>
</span><span id=__span-54-18><a id=__codelineno-54-18 name=__codelineno-54-18 href=#__codelineno-54-18></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-54-19><a id=__codelineno-54-19 name=__codelineno-54-19 href=#__codelineno-54-19></a>
</span><span id=__span-54-20><a id=__codelineno-54-20 name=__codelineno-54-20 href=#__codelineno-54-20></a><span class=w>    </span><span class=c1>// Set default service type</span>
</span><span id=__span-54-21><a id=__codelineno-54-21 name=__codelineno-54-21 href=#__codelineno-54-21></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ServiceType</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-22><a id=__codelineno-54-22 name=__codelineno-54-22 href=#__codelineno-54-22></a><span class=w>        </span><span class=nx>r</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ServiceType</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&quot;ClusterIP&quot;</span>
</span><span id=__span-54-23><a id=__codelineno-54-23 name=__codelineno-54-23 href=#__codelineno-54-23></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-54-24><a id=__codelineno-54-24 name=__codelineno-54-24 href=#__codelineno-54-24></a><span class=p>}</span>
</span></code></pre></div> <h3 id=1103-implement-validation-validating-webhook>11.03 Implement validation (validating webhook)<a class=headerlink href=#1103-implement-validation-validating-webhook title="Permanent link">&para;</a></h3> <div class="language-go highlight"><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>WebApp</span><span class=p>)</span><span class=w> </span><span class=nx>ValidateCreate</span><span class=p>()</span><span class=w> </span><span class=p>(</span><span class=nx>admission</span><span class=p>.</span><span class=nx>Warnings</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>validateWebApp</span><span class=p>()</span>
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a><span class=p>}</span>
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a>
</span><span id=__span-55-5><a id=__codelineno-55-5 name=__codelineno-55-5 href=#__codelineno-55-5></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>WebApp</span><span class=p>)</span><span class=w> </span><span class=nx>ValidateUpdate</span><span class=p>(</span><span class=nx>old</span><span class=w> </span><span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>admission</span><span class=p>.</span><span class=nx>Warnings</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-55-6><a id=__codelineno-55-6 name=__codelineno-55-6 href=#__codelineno-55-6></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>validateWebApp</span><span class=p>()</span>
</span><span id=__span-55-7><a id=__codelineno-55-7 name=__codelineno-55-7 href=#__codelineno-55-7></a><span class=p>}</span>
</span><span id=__span-55-8><a id=__codelineno-55-8 name=__codelineno-55-8 href=#__codelineno-55-8></a>
</span><span id=__span-55-9><a id=__codelineno-55-9 name=__codelineno-55-9 href=#__codelineno-55-9></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>WebApp</span><span class=p>)</span><span class=w> </span><span class=nx>ValidateDelete</span><span class=p>()</span><span class=w> </span><span class=p>(</span><span class=nx>admission</span><span class=p>.</span><span class=nx>Warnings</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-55-10><a id=__codelineno-55-10 name=__codelineno-55-10 href=#__codelineno-55-10></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-55-11><a id=__codelineno-55-11 name=__codelineno-55-11 href=#__codelineno-55-11></a><span class=p>}</span>
</span><span id=__span-55-12><a id=__codelineno-55-12 name=__codelineno-55-12 href=#__codelineno-55-12></a>
</span><span id=__span-55-13><a id=__codelineno-55-13 name=__codelineno-55-13 href=#__codelineno-55-13></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>WebApp</span><span class=p>)</span><span class=w> </span><span class=nx>validateWebApp</span><span class=p>()</span><span class=w> </span><span class=p>(</span><span class=nx>admission</span><span class=p>.</span><span class=nx>Warnings</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-55-14><a id=__codelineno-55-14 name=__codelineno-55-14 href=#__codelineno-55-14></a><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>errs</span><span class=w> </span><span class=nx>field</span><span class=p>.</span><span class=nx>ErrorList</span>
</span><span id=__span-55-15><a id=__codelineno-55-15 name=__codelineno-55-15 href=#__codelineno-55-15></a>
</span><span id=__span-55-16><a id=__codelineno-55-16 name=__codelineno-55-16 href=#__codelineno-55-16></a><span class=w>    </span><span class=c1>// Replicas must be between 1 and 10</span>
</span><span id=__span-55-17><a id=__codelineno-55-17 name=__codelineno-55-17 href=#__codelineno-55-17></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-55-18><a id=__codelineno-55-18 name=__codelineno-55-18 href=#__codelineno-55-18></a><span class=w>        </span><span class=nx>errs</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>errs</span><span class=p>,</span><span class=w> </span><span class=nx>field</span><span class=p>.</span><span class=nx>Invalid</span><span class=p>(</span>
</span><span id=__span-55-19><a id=__codelineno-55-19 name=__codelineno-55-19 href=#__codelineno-55-19></a><span class=w>            </span><span class=nx>field</span><span class=p>.</span><span class=nx>NewPath</span><span class=p>(</span><span class=s>&quot;spec&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;replicas&quot;</span><span class=p>),</span>
</span><span id=__span-55-20><a id=__codelineno-55-20 name=__codelineno-55-20 href=#__codelineno-55-20></a><span class=w>            </span><span class=nx>r</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=p>,</span>
</span><span id=__span-55-21><a id=__codelineno-55-21 name=__codelineno-55-21 href=#__codelineno-55-21></a><span class=w>            </span><span class=s>&quot;must be between 1 and 10&quot;</span><span class=p>,</span>
</span><span id=__span-55-22><a id=__codelineno-55-22 name=__codelineno-55-22 href=#__codelineno-55-22></a><span class=w>        </span><span class=p>))</span>
</span><span id=__span-55-23><a id=__codelineno-55-23 name=__codelineno-55-23 href=#__codelineno-55-23></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-55-24><a id=__codelineno-55-24 name=__codelineno-55-24 href=#__codelineno-55-24></a>
</span><span id=__span-55-25><a id=__codelineno-55-25 name=__codelineno-55-25 href=#__codelineno-55-25></a><span class=w>    </span><span class=c1>// Message must not be empty</span>
</span><span id=__span-55-26><a id=__codelineno-55-26 name=__codelineno-55-26 href=#__codelineno-55-26></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Message</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-55-27><a id=__codelineno-55-27 name=__codelineno-55-27 href=#__codelineno-55-27></a><span class=w>        </span><span class=nx>errs</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>errs</span><span class=p>,</span><span class=w> </span><span class=nx>field</span><span class=p>.</span><span class=nx>Required</span><span class=p>(</span>
</span><span id=__span-55-28><a id=__codelineno-55-28 name=__codelineno-55-28 href=#__codelineno-55-28></a><span class=w>            </span><span class=nx>field</span><span class=p>.</span><span class=nx>NewPath</span><span class=p>(</span><span class=s>&quot;spec&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;message&quot;</span><span class=p>),</span>
</span><span id=__span-55-29><a id=__codelineno-55-29 name=__codelineno-55-29 href=#__codelineno-55-29></a><span class=w>            </span><span class=s>&quot;message is required and cannot be empty&quot;</span><span class=p>,</span>
</span><span id=__span-55-30><a id=__codelineno-55-30 name=__codelineno-55-30 href=#__codelineno-55-30></a><span class=w>        </span><span class=p>))</span>
</span><span id=__span-55-31><a id=__codelineno-55-31 name=__codelineno-55-31 href=#__codelineno-55-31></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-55-32><a id=__codelineno-55-32 name=__codelineno-55-32 href=#__codelineno-55-32></a>
</span><span id=__span-55-33><a id=__codelineno-55-33 name=__codelineno-55-33 href=#__codelineno-55-33></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>errs</span><span class=p>)</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-55-34><a id=__codelineno-55-34 name=__codelineno-55-34 href=#__codelineno-55-34></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>apierrors</span><span class=p>.</span><span class=nx>NewInvalid</span><span class=p>(</span>
</span><span id=__span-55-35><a id=__codelineno-55-35 name=__codelineno-55-35 href=#__codelineno-55-35></a><span class=w>            </span><span class=nx>schema</span><span class=p>.</span><span class=nx>GroupKind</span><span class=p>{</span><span class=nx>Group</span><span class=p>:</span><span class=w> </span><span class=s>&quot;apps.codewizard.io&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>Kind</span><span class=p>:</span><span class=w> </span><span class=s>&quot;WebApp&quot;</span><span class=p>},</span>
</span><span id=__span-55-36><a id=__codelineno-55-36 name=__codelineno-55-36 href=#__codelineno-55-36></a><span class=w>            </span><span class=nx>r</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span><span id=__span-55-37><a id=__codelineno-55-37 name=__codelineno-55-37 href=#__codelineno-55-37></a><span class=w>            </span><span class=nx>errs</span><span class=p>,</span>
</span><span id=__span-55-38><a id=__codelineno-55-38 name=__codelineno-55-38 href=#__codelineno-55-38></a><span class=w>        </span><span class=p>)</span>
</span><span id=__span-55-39><a id=__codelineno-55-39 name=__codelineno-55-39 href=#__codelineno-55-39></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-55-40><a id=__codelineno-55-40 name=__codelineno-55-40 href=#__codelineno-55-40></a>
</span><span id=__span-55-41><a id=__codelineno-55-41 name=__codelineno-55-41 href=#__codelineno-55-41></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-55-42><a id=__codelineno-55-42 name=__codelineno-55-42 href=#__codelineno-55-42></a><span class=p>}</span>
</span></code></pre></div> <h3 id=1104-test-webhook-validation>11.04 Test webhook validation<a class=headerlink href=#1104-test-webhook-validation title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=c1># This should fail - replicas = 15 exceeds maximum of 10</span>
</span><span id=__span-56-2><a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
</span><span id=__span-56-3><a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a><span class=s>apiVersion: apps.codewizard.io/v1</span>
</span><span id=__span-56-4><a id=__codelineno-56-4 name=__codelineno-56-4 href=#__codelineno-56-4></a><span class=s>kind: WebApp</span>
</span><span id=__span-56-5><a id=__codelineno-56-5 name=__codelineno-56-5 href=#__codelineno-56-5></a><span class=s>metadata:</span>
</span><span id=__span-56-6><a id=__codelineno-56-6 name=__codelineno-56-6 href=#__codelineno-56-6></a><span class=s>  name: invalid-webapp</span>
</span><span id=__span-56-7><a id=__codelineno-56-7 name=__codelineno-56-7 href=#__codelineno-56-7></a><span class=s>spec:</span>
</span><span id=__span-56-8><a id=__codelineno-56-8 name=__codelineno-56-8 href=#__codelineno-56-8></a><span class=s>  replicas: 15</span>
</span><span id=__span-56-9><a id=__codelineno-56-9 name=__codelineno-56-9 href=#__codelineno-56-9></a><span class=s>  message: &quot;test&quot;</span>
</span><span id=__span-56-10><a id=__codelineno-56-10 name=__codelineno-56-10 href=#__codelineno-56-10></a><span class=s>  image: nginx:1.25.3</span>
</span><span id=__span-56-11><a id=__codelineno-56-11 name=__codelineno-56-11 href=#__codelineno-56-11></a><span class=s>  port: 80</span>
</span><span id=__span-56-12><a id=__codelineno-56-12 name=__codelineno-56-12 href=#__codelineno-56-12></a><span class=s>EOF</span>
</span><span id=__span-56-13><a id=__codelineno-56-13 name=__codelineno-56-13 href=#__codelineno-56-13></a>
</span><span id=__span-56-14><a id=__codelineno-56-14 name=__codelineno-56-14 href=#__codelineno-56-14></a><span class=c1># Expected error:</span>
</span><span id=__span-56-15><a id=__codelineno-56-15 name=__codelineno-56-15 href=#__codelineno-56-15></a><span class=c1># Error from server (WebApp.apps.codewizard.io &quot;invalid-webapp&quot; is invalid):</span>
</span><span id=__span-56-16><a id=__codelineno-56-16 name=__codelineno-56-16 href=#__codelineno-56-16></a><span class=c1>#   spec.replicas: Invalid value: 15: must be between 1 and 10</span>
</span></code></pre></div> <hr> <h2 id=part-12-writing-controller-tests>Part 12 - Writing Controller Tests<a class=headerlink href=#part-12-writing-controller-tests title="Permanent link">&para;</a></h2> <p>Kubebuilder sets up <code>envtest</code> which runs a real <code>kube-apiserver</code> and <code>etcd</code> - no cluster needed.</p> <h3 id=1201-inspect-the-test-suite-setup>12.01 Inspect the test suite setup<a class=headerlink href=#1201-inspect-the-test-suite-setup title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a>cat<span class=w> </span>internal/controller/suite_test.go
</span></code></pre></div> <h3 id=1202-write-a-reconciler-integration-test>12.02 Write a reconciler integration test<a class=headerlink href=#1202-write-a-reconciler-integration-test title="Permanent link">&para;</a></h3> <p>Create <code>internal/controller/webapp_controller_test.go</code>:</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a><span class=kn>package</span><span class=w> </span><span class=nx>controller</span>
</span><span id=__span-58-2><a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a>
</span><span id=__span-58-3><a id=__codelineno-58-3 name=__codelineno-58-3 href=#__codelineno-58-3></a><span class=kn>import</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-58-4><a id=__codelineno-58-4 name=__codelineno-58-4 href=#__codelineno-58-4></a><span class=w>    </span><span class=s>&quot;context&quot;</span>
</span><span id=__span-58-5><a id=__codelineno-58-5 name=__codelineno-58-5 href=#__codelineno-58-5></a><span class=w>    </span><span class=s>&quot;time&quot;</span>
</span><span id=__span-58-6><a id=__codelineno-58-6 name=__codelineno-58-6 href=#__codelineno-58-6></a>
</span><span id=__span-58-7><a id=__codelineno-58-7 name=__codelineno-58-7 href=#__codelineno-58-7></a><span class=w>    </span><span class=p>.</span><span class=w> </span><span class=s>&quot;github.com/onsi/ginkgo/v2&quot;</span>
</span><span id=__span-58-8><a id=__codelineno-58-8 name=__codelineno-58-8 href=#__codelineno-58-8></a><span class=w>    </span><span class=p>.</span><span class=w> </span><span class=s>&quot;github.com/onsi/gomega&quot;</span>
</span><span id=__span-58-9><a id=__codelineno-58-9 name=__codelineno-58-9 href=#__codelineno-58-9></a><span class=w>    </span><span class=nx>appsv1</span><span class=w> </span><span class=s>&quot;k8s.io/api/apps/v1&quot;</span>
</span><span id=__span-58-10><a id=__codelineno-58-10 name=__codelineno-58-10 href=#__codelineno-58-10></a><span class=w>    </span><span class=nx>corev1</span><span class=w> </span><span class=s>&quot;k8s.io/api/core/v1&quot;</span>
</span><span id=__span-58-11><a id=__codelineno-58-11 name=__codelineno-58-11 href=#__codelineno-58-11></a><span class=w>    </span><span class=s>&quot;k8s.io/apimachinery/pkg/types&quot;</span>
</span><span id=__span-58-12><a id=__codelineno-58-12 name=__codelineno-58-12 href=#__codelineno-58-12></a>
</span><span id=__span-58-13><a id=__codelineno-58-13 name=__codelineno-58-13 href=#__codelineno-58-13></a><span class=w>    </span><span class=nx>webappv1</span><span class=w> </span><span class=s>&quot;codewizard.io/webapp-operator/api/v1&quot;</span>
</span><span id=__span-58-14><a id=__codelineno-58-14 name=__codelineno-58-14 href=#__codelineno-58-14></a><span class=w>    </span><span class=nx>metav1</span><span class=w> </span><span class=s>&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
</span><span id=__span-58-15><a id=__codelineno-58-15 name=__codelineno-58-15 href=#__codelineno-58-15></a><span class=p>)</span>
</span><span id=__span-58-16><a id=__codelineno-58-16 name=__codelineno-58-16 href=#__codelineno-58-16></a>
</span><span id=__span-58-17><a id=__codelineno-58-17 name=__codelineno-58-17 href=#__codelineno-58-17></a><span class=kd>var</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>Describe</span><span class=p>(</span><span class=s>&quot;WebApp Controller&quot;</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-58-18><a id=__codelineno-58-18 name=__codelineno-58-18 href=#__codelineno-58-18></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-58-19><a id=__codelineno-58-19 name=__codelineno-58-19 href=#__codelineno-58-19></a><span class=w>        </span><span class=nx>WebAppName</span><span class=w>      </span><span class=p>=</span><span class=w> </span><span class=s>&quot;test-webapp&quot;</span>
</span><span id=__span-58-20><a id=__codelineno-58-20 name=__codelineno-58-20 href=#__codelineno-58-20></a><span class=w>        </span><span class=nx>WebAppNamespace</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&quot;default&quot;</span>
</span><span id=__span-58-21><a id=__codelineno-58-21 name=__codelineno-58-21 href=#__codelineno-58-21></a><span class=w>        </span><span class=nx>timeout</span><span class=w>         </span><span class=p>=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>30</span>
</span><span id=__span-58-22><a id=__codelineno-58-22 name=__codelineno-58-22 href=#__codelineno-58-22></a><span class=w>        </span><span class=nx>interval</span><span class=w>        </span><span class=p>=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>250</span>
</span><span id=__span-58-23><a id=__codelineno-58-23 name=__codelineno-58-23 href=#__codelineno-58-23></a><span class=w>    </span><span class=p>)</span>
</span><span id=__span-58-24><a id=__codelineno-58-24 name=__codelineno-58-24 href=#__codelineno-58-24></a>
</span><span id=__span-58-25><a id=__codelineno-58-25 name=__codelineno-58-25 href=#__codelineno-58-25></a><span class=w>    </span><span class=nx>ctx</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Background</span><span class=p>()</span>
</span><span id=__span-58-26><a id=__codelineno-58-26 name=__codelineno-58-26 href=#__codelineno-58-26></a>
</span><span id=__span-58-27><a id=__codelineno-58-27 name=__codelineno-58-27 href=#__codelineno-58-27></a><span class=w>    </span><span class=nx>Context</span><span class=p>(</span><span class=s>&quot;When creating a WebApp&quot;</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-58-28><a id=__codelineno-58-28 name=__codelineno-58-28 href=#__codelineno-58-28></a><span class=w>        </span><span class=nx>It</span><span class=p>(</span><span class=s>&quot;should create a Deployment, Service and ConfigMap&quot;</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-58-29><a id=__codelineno-58-29 name=__codelineno-58-29 href=#__codelineno-58-29></a><span class=w>            </span><span class=c1>// ── Create the WebApp CR ────────────────────────────────────────</span>
</span><span id=__span-58-30><a id=__codelineno-58-30 name=__codelineno-58-30 href=#__codelineno-58-30></a><span class=w>            </span><span class=nx>webapp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>webappv1</span><span class=p>.</span><span class=nx>WebApp</span><span class=p>{</span>
</span><span id=__span-58-31><a id=__codelineno-58-31 name=__codelineno-58-31 href=#__codelineno-58-31></a><span class=w>                </span><span class=nx>ObjectMeta</span><span class=p>:</span><span class=w> </span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span><span id=__span-58-32><a id=__codelineno-58-32 name=__codelineno-58-32 href=#__codelineno-58-32></a><span class=w>                    </span><span class=nx>Name</span><span class=p>:</span><span class=w>      </span><span class=nx>WebAppName</span><span class=p>,</span>
</span><span id=__span-58-33><a id=__codelineno-58-33 name=__codelineno-58-33 href=#__codelineno-58-33></a><span class=w>                    </span><span class=nx>Namespace</span><span class=p>:</span><span class=w> </span><span class=nx>WebAppNamespace</span><span class=p>,</span>
</span><span id=__span-58-34><a id=__codelineno-58-34 name=__codelineno-58-34 href=#__codelineno-58-34></a><span class=w>                </span><span class=p>},</span>
</span><span id=__span-58-35><a id=__codelineno-58-35 name=__codelineno-58-35 href=#__codelineno-58-35></a><span class=w>                </span><span class=nx>Spec</span><span class=p>:</span><span class=w> </span><span class=nx>webappv1</span><span class=p>.</span><span class=nx>WebAppSpec</span><span class=p>{</span>
</span><span id=__span-58-36><a id=__codelineno-58-36 name=__codelineno-58-36 href=#__codelineno-58-36></a><span class=w>                    </span><span class=nx>Replicas</span><span class=p>:</span><span class=w>    </span><span class=mi>2</span><span class=p>,</span>
</span><span id=__span-58-37><a id=__codelineno-58-37 name=__codelineno-58-37 href=#__codelineno-58-37></a><span class=w>                    </span><span class=nx>Image</span><span class=p>:</span><span class=w>       </span><span class=s>&quot;nginx:1.25.3&quot;</span><span class=p>,</span>
</span><span id=__span-58-38><a id=__codelineno-58-38 name=__codelineno-58-38 href=#__codelineno-58-38></a><span class=w>                    </span><span class=nx>Message</span><span class=p>:</span><span class=w>     </span><span class=s>&quot;Hello from test&quot;</span><span class=p>,</span>
</span><span id=__span-58-39><a id=__codelineno-58-39 name=__codelineno-58-39 href=#__codelineno-58-39></a><span class=w>                    </span><span class=nx>Port</span><span class=p>:</span><span class=w>        </span><span class=mi>80</span><span class=p>,</span>
</span><span id=__span-58-40><a id=__codelineno-58-40 name=__codelineno-58-40 href=#__codelineno-58-40></a><span class=w>                    </span><span class=nx>ServiceType</span><span class=p>:</span><span class=w> </span><span class=s>&quot;ClusterIP&quot;</span><span class=p>,</span>
</span><span id=__span-58-41><a id=__codelineno-58-41 name=__codelineno-58-41 href=#__codelineno-58-41></a><span class=w>                </span><span class=p>},</span>
</span><span id=__span-58-42><a id=__codelineno-58-42 name=__codelineno-58-42 href=#__codelineno-58-42></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-58-43><a id=__codelineno-58-43 name=__codelineno-58-43 href=#__codelineno-58-43></a><span class=w>            </span><span class=nx>Expect</span><span class=p>(</span><span class=nx>k8sClient</span><span class=p>.</span><span class=nx>Create</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>)).</span><span class=nx>To</span><span class=p>(</span><span class=nx>Succeed</span><span class=p>())</span>
</span><span id=__span-58-44><a id=__codelineno-58-44 name=__codelineno-58-44 href=#__codelineno-58-44></a>
</span><span id=__span-58-45><a id=__codelineno-58-45 name=__codelineno-58-45 href=#__codelineno-58-45></a><span class=w>            </span><span class=c1>// ── Assert: Deployment is created ────────────────────────────────</span>
</span><span id=__span-58-46><a id=__codelineno-58-46 name=__codelineno-58-46 href=#__codelineno-58-46></a><span class=w>            </span><span class=nx>deploymentLookup</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span><span class=w> </span><span class=nx>WebAppName</span><span class=p>,</span><span class=w> </span><span class=nx>Namespace</span><span class=p>:</span><span class=w> </span><span class=nx>WebAppNamespace</span><span class=p>}</span>
</span><span id=__span-58-47><a id=__codelineno-58-47 name=__codelineno-58-47 href=#__codelineno-58-47></a><span class=w>            </span><span class=nx>createdDeployment</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{}</span>
</span><span id=__span-58-48><a id=__codelineno-58-48 name=__codelineno-58-48 href=#__codelineno-58-48></a>
</span><span id=__span-58-49><a id=__codelineno-58-49 name=__codelineno-58-49 href=#__codelineno-58-49></a><span class=w>            </span><span class=nx>Eventually</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-58-50><a id=__codelineno-58-50 name=__codelineno-58-50 href=#__codelineno-58-50></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=nx>k8sClient</span><span class=p>.</span><span class=nx>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>deploymentLookup</span><span class=p>,</span><span class=w> </span><span class=nx>createdDeployment</span><span class=p>)</span>
</span><span id=__span-58-51><a id=__codelineno-58-51 name=__codelineno-58-51 href=#__codelineno-58-51></a><span class=w>            </span><span class=p>},</span><span class=w> </span><span class=nx>timeout</span><span class=p>,</span><span class=w> </span><span class=nx>interval</span><span class=p>).</span><span class=nx>Should</span><span class=p>(</span><span class=nx>Succeed</span><span class=p>())</span>
</span><span id=__span-58-52><a id=__codelineno-58-52 name=__codelineno-58-52 href=#__codelineno-58-52></a>
</span><span id=__span-58-53><a id=__codelineno-58-53 name=__codelineno-58-53 href=#__codelineno-58-53></a><span class=w>            </span><span class=nx>Expect</span><span class=p>(</span><span class=o>*</span><span class=nx>createdDeployment</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=p>).</span><span class=nx>To</span><span class=p>(</span><span class=nx>Equal</span><span class=p>(</span><span class=nb>int32</span><span class=p>(</span><span class=mi>2</span><span class=p>)))</span>
</span><span id=__span-58-54><a id=__codelineno-58-54 name=__codelineno-58-54 href=#__codelineno-58-54></a><span class=w>            </span><span class=nx>Expect</span><span class=p>(</span><span class=nx>createdDeployment</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Template</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Containers</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Image</span><span class=p>).</span><span class=nx>To</span><span class=p>(</span><span class=nx>Equal</span><span class=p>(</span><span class=s>&quot;nginx:1.25.3&quot;</span><span class=p>))</span>
</span><span id=__span-58-55><a id=__codelineno-58-55 name=__codelineno-58-55 href=#__codelineno-58-55></a>
</span><span id=__span-58-56><a id=__codelineno-58-56 name=__codelineno-58-56 href=#__codelineno-58-56></a><span class=w>            </span><span class=c1>// ── Assert: Service is created ───────────────────────────────────</span>
</span><span id=__span-58-57><a id=__codelineno-58-57 name=__codelineno-58-57 href=#__codelineno-58-57></a><span class=w>            </span><span class=nx>createdService</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Service</span><span class=p>{}</span>
</span><span id=__span-58-58><a id=__codelineno-58-58 name=__codelineno-58-58 href=#__codelineno-58-58></a><span class=w>            </span><span class=nx>Eventually</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-58-59><a id=__codelineno-58-59 name=__codelineno-58-59 href=#__codelineno-58-59></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=nx>k8sClient</span><span class=p>.</span><span class=nx>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>deploymentLookup</span><span class=p>,</span><span class=w> </span><span class=nx>createdService</span><span class=p>)</span>
</span><span id=__span-58-60><a id=__codelineno-58-60 name=__codelineno-58-60 href=#__codelineno-58-60></a><span class=w>            </span><span class=p>},</span><span class=w> </span><span class=nx>timeout</span><span class=p>,</span><span class=w> </span><span class=nx>interval</span><span class=p>).</span><span class=nx>Should</span><span class=p>(</span><span class=nx>Succeed</span><span class=p>())</span>
</span><span id=__span-58-61><a id=__codelineno-58-61 name=__codelineno-58-61 href=#__codelineno-58-61></a>
</span><span id=__span-58-62><a id=__codelineno-58-62 name=__codelineno-58-62 href=#__codelineno-58-62></a><span class=w>            </span><span class=nx>Expect</span><span class=p>(</span><span class=nx>createdService</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Type</span><span class=p>).</span><span class=nx>To</span><span class=p>(</span><span class=nx>Equal</span><span class=p>(</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ServiceTypeClusterIP</span><span class=p>))</span>
</span><span id=__span-58-63><a id=__codelineno-58-63 name=__codelineno-58-63 href=#__codelineno-58-63></a>
</span><span id=__span-58-64><a id=__codelineno-58-64 name=__codelineno-58-64 href=#__codelineno-58-64></a><span class=w>            </span><span class=c1>// ── Assert: ConfigMap is created ─────────────────────────────────</span>
</span><span id=__span-58-65><a id=__codelineno-58-65 name=__codelineno-58-65 href=#__codelineno-58-65></a><span class=w>            </span><span class=nx>cmLookup</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span><span class=w> </span><span class=nx>WebAppName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;-html&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>Namespace</span><span class=p>:</span><span class=w> </span><span class=nx>WebAppNamespace</span><span class=p>}</span>
</span><span id=__span-58-66><a id=__codelineno-58-66 name=__codelineno-58-66 href=#__codelineno-58-66></a><span class=w>            </span><span class=nx>createdCM</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ConfigMap</span><span class=p>{}</span>
</span><span id=__span-58-67><a id=__codelineno-58-67 name=__codelineno-58-67 href=#__codelineno-58-67></a><span class=w>            </span><span class=nx>Eventually</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-58-68><a id=__codelineno-58-68 name=__codelineno-58-68 href=#__codelineno-58-68></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=nx>k8sClient</span><span class=p>.</span><span class=nx>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>cmLookup</span><span class=p>,</span><span class=w> </span><span class=nx>createdCM</span><span class=p>)</span>
</span><span id=__span-58-69><a id=__codelineno-58-69 name=__codelineno-58-69 href=#__codelineno-58-69></a><span class=w>            </span><span class=p>},</span><span class=w> </span><span class=nx>timeout</span><span class=p>,</span><span class=w> </span><span class=nx>interval</span><span class=p>).</span><span class=nx>Should</span><span class=p>(</span><span class=nx>Succeed</span><span class=p>())</span>
</span><span id=__span-58-70><a id=__codelineno-58-70 name=__codelineno-58-70 href=#__codelineno-58-70></a>
</span><span id=__span-58-71><a id=__codelineno-58-71 name=__codelineno-58-71 href=#__codelineno-58-71></a><span class=w>            </span><span class=nx>Expect</span><span class=p>(</span><span class=nx>createdCM</span><span class=p>.</span><span class=nx>Data</span><span class=p>[</span><span class=s>&quot;index.html&quot;</span><span class=p>]).</span><span class=nx>To</span><span class=p>(</span><span class=nx>ContainSubstring</span><span class=p>(</span><span class=s>&quot;Hello from test&quot;</span><span class=p>))</span>
</span><span id=__span-58-72><a id=__codelineno-58-72 name=__codelineno-58-72 href=#__codelineno-58-72></a><span class=w>        </span><span class=p>})</span>
</span><span id=__span-58-73><a id=__codelineno-58-73 name=__codelineno-58-73 href=#__codelineno-58-73></a>
</span><span id=__span-58-74><a id=__codelineno-58-74 name=__codelineno-58-74 href=#__codelineno-58-74></a><span class=w>        </span><span class=nx>It</span><span class=p>(</span><span class=s>&quot;should update the Deployment when replicas change&quot;</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-58-75><a id=__codelineno-58-75 name=__codelineno-58-75 href=#__codelineno-58-75></a><span class=w>            </span><span class=c1>// Patch replicas from 2 → 4</span>
</span><span id=__span-58-76><a id=__codelineno-58-76 name=__codelineno-58-76 href=#__codelineno-58-76></a><span class=w>            </span><span class=nx>webapp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>webappv1</span><span class=p>.</span><span class=nx>WebApp</span><span class=p>{}</span>
</span><span id=__span-58-77><a id=__codelineno-58-77 name=__codelineno-58-77 href=#__codelineno-58-77></a><span class=w>            </span><span class=nx>Expect</span><span class=p>(</span><span class=nx>k8sClient</span><span class=p>.</span><span class=nx>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span>
</span><span id=__span-58-78><a id=__codelineno-58-78 name=__codelineno-58-78 href=#__codelineno-58-78></a><span class=w>                </span><span class=nx>Name</span><span class=p>:</span><span class=w>      </span><span class=nx>WebAppName</span><span class=p>,</span>
</span><span id=__span-58-79><a id=__codelineno-58-79 name=__codelineno-58-79 href=#__codelineno-58-79></a><span class=w>                </span><span class=nx>Namespace</span><span class=p>:</span><span class=w> </span><span class=nx>WebAppNamespace</span><span class=p>,</span>
</span><span id=__span-58-80><a id=__codelineno-58-80 name=__codelineno-58-80 href=#__codelineno-58-80></a><span class=w>            </span><span class=p>},</span><span class=w> </span><span class=nx>webapp</span><span class=p>)).</span><span class=nx>To</span><span class=p>(</span><span class=nx>Succeed</span><span class=p>())</span>
</span><span id=__span-58-81><a id=__codelineno-58-81 name=__codelineno-58-81 href=#__codelineno-58-81></a>
</span><span id=__span-58-82><a id=__codelineno-58-82 name=__codelineno-58-82 href=#__codelineno-58-82></a><span class=w>            </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>4</span>
</span><span id=__span-58-83><a id=__codelineno-58-83 name=__codelineno-58-83 href=#__codelineno-58-83></a><span class=w>            </span><span class=nx>Expect</span><span class=p>(</span><span class=nx>k8sClient</span><span class=p>.</span><span class=nx>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>)).</span><span class=nx>To</span><span class=p>(</span><span class=nx>Succeed</span><span class=p>())</span>
</span><span id=__span-58-84><a id=__codelineno-58-84 name=__codelineno-58-84 href=#__codelineno-58-84></a>
</span><span id=__span-58-85><a id=__codelineno-58-85 name=__codelineno-58-85 href=#__codelineno-58-85></a><span class=w>            </span><span class=c1>// Assert Deployment reflects new replica count</span>
</span><span id=__span-58-86><a id=__codelineno-58-86 name=__codelineno-58-86 href=#__codelineno-58-86></a><span class=w>            </span><span class=nx>Eventually</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=kt>int32</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-58-87><a id=__codelineno-58-87 name=__codelineno-58-87 href=#__codelineno-58-87></a><span class=w>                </span><span class=nx>dep</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{}</span>
</span><span id=__span-58-88><a id=__codelineno-58-88 name=__codelineno-58-88 href=#__codelineno-58-88></a><span class=w>                </span><span class=nx>_</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>k8sClient</span><span class=p>.</span><span class=nx>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span>
</span><span id=__span-58-89><a id=__codelineno-58-89 name=__codelineno-58-89 href=#__codelineno-58-89></a><span class=w>                    </span><span class=nx>Name</span><span class=p>:</span><span class=w>      </span><span class=nx>WebAppName</span><span class=p>,</span>
</span><span id=__span-58-90><a id=__codelineno-58-90 name=__codelineno-58-90 href=#__codelineno-58-90></a><span class=w>                    </span><span class=nx>Namespace</span><span class=p>:</span><span class=w> </span><span class=nx>WebAppNamespace</span><span class=p>,</span>
</span><span id=__span-58-91><a id=__codelineno-58-91 name=__codelineno-58-91 href=#__codelineno-58-91></a><span class=w>                </span><span class=p>},</span><span class=w> </span><span class=nx>dep</span><span class=p>)</span>
</span><span id=__span-58-92><a id=__codelineno-58-92 name=__codelineno-58-92 href=#__codelineno-58-92></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=o>*</span><span class=nx>dep</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span>
</span><span id=__span-58-93><a id=__codelineno-58-93 name=__codelineno-58-93 href=#__codelineno-58-93></a><span class=w>            </span><span class=p>},</span><span class=w> </span><span class=nx>timeout</span><span class=p>,</span><span class=w> </span><span class=nx>interval</span><span class=p>).</span><span class=nx>Should</span><span class=p>(</span><span class=nx>Equal</span><span class=p>(</span><span class=nb>int32</span><span class=p>(</span><span class=mi>4</span><span class=p>)))</span>
</span><span id=__span-58-94><a id=__codelineno-58-94 name=__codelineno-58-94 href=#__codelineno-58-94></a><span class=w>        </span><span class=p>})</span>
</span><span id=__span-58-95><a id=__codelineno-58-95 name=__codelineno-58-95 href=#__codelineno-58-95></a>
</span><span id=__span-58-96><a id=__codelineno-58-96 name=__codelineno-58-96 href=#__codelineno-58-96></a><span class=w>        </span><span class=nx>It</span><span class=p>(</span><span class=s>&quot;should update the ConfigMap when message changes&quot;</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-58-97><a id=__codelineno-58-97 name=__codelineno-58-97 href=#__codelineno-58-97></a><span class=w>            </span><span class=nx>webapp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>webappv1</span><span class=p>.</span><span class=nx>WebApp</span><span class=p>{}</span>
</span><span id=__span-58-98><a id=__codelineno-58-98 name=__codelineno-58-98 href=#__codelineno-58-98></a><span class=w>            </span><span class=nx>Expect</span><span class=p>(</span><span class=nx>k8sClient</span><span class=p>.</span><span class=nx>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span>
</span><span id=__span-58-99><a id=__codelineno-58-99 name=__codelineno-58-99 href=#__codelineno-58-99></a><span class=w>                </span><span class=nx>Name</span><span class=p>:</span><span class=w>      </span><span class=nx>WebAppName</span><span class=p>,</span>
</span><span id=__span-58-100><a id=__codelineno-58-100 name=__codelineno-58-100 href=#__codelineno-58-100></a><span class=w>                </span><span class=nx>Namespace</span><span class=p>:</span><span class=w> </span><span class=nx>WebAppNamespace</span><span class=p>,</span>
</span><span id=__span-58-101><a id=__codelineno-58-101 name=__codelineno-58-101 href=#__codelineno-58-101></a><span class=w>            </span><span class=p>},</span><span class=w> </span><span class=nx>webapp</span><span class=p>)).</span><span class=nx>To</span><span class=p>(</span><span class=nx>Succeed</span><span class=p>())</span>
</span><span id=__span-58-102><a id=__codelineno-58-102 name=__codelineno-58-102 href=#__codelineno-58-102></a>
</span><span id=__span-58-103><a id=__codelineno-58-103 name=__codelineno-58-103 href=#__codelineno-58-103></a><span class=w>            </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Message</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&quot;Updated message via test&quot;</span>
</span><span id=__span-58-104><a id=__codelineno-58-104 name=__codelineno-58-104 href=#__codelineno-58-104></a><span class=w>            </span><span class=nx>Expect</span><span class=p>(</span><span class=nx>k8sClient</span><span class=p>.</span><span class=nx>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>)).</span><span class=nx>To</span><span class=p>(</span><span class=nx>Succeed</span><span class=p>())</span>
</span><span id=__span-58-105><a id=__codelineno-58-105 name=__codelineno-58-105 href=#__codelineno-58-105></a>
</span><span id=__span-58-106><a id=__codelineno-58-106 name=__codelineno-58-106 href=#__codelineno-58-106></a><span class=w>            </span><span class=nx>Eventually</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-58-107><a id=__codelineno-58-107 name=__codelineno-58-107 href=#__codelineno-58-107></a><span class=w>                </span><span class=nx>cm</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ConfigMap</span><span class=p>{}</span>
</span><span id=__span-58-108><a id=__codelineno-58-108 name=__codelineno-58-108 href=#__codelineno-58-108></a><span class=w>                </span><span class=nx>_</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>k8sClient</span><span class=p>.</span><span class=nx>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span>
</span><span id=__span-58-109><a id=__codelineno-58-109 name=__codelineno-58-109 href=#__codelineno-58-109></a><span class=w>                    </span><span class=nx>Name</span><span class=p>:</span><span class=w>      </span><span class=nx>WebAppName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;-html&quot;</span><span class=p>,</span>
</span><span id=__span-58-110><a id=__codelineno-58-110 name=__codelineno-58-110 href=#__codelineno-58-110></a><span class=w>                    </span><span class=nx>Namespace</span><span class=p>:</span><span class=w> </span><span class=nx>WebAppNamespace</span><span class=p>,</span>
</span><span id=__span-58-111><a id=__codelineno-58-111 name=__codelineno-58-111 href=#__codelineno-58-111></a><span class=w>                </span><span class=p>},</span><span class=w> </span><span class=nx>cm</span><span class=p>)</span>
</span><span id=__span-58-112><a id=__codelineno-58-112 name=__codelineno-58-112 href=#__codelineno-58-112></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=nx>cm</span><span class=p>.</span><span class=nx>Data</span><span class=p>[</span><span class=s>&quot;index.html&quot;</span><span class=p>]</span>
</span><span id=__span-58-113><a id=__codelineno-58-113 name=__codelineno-58-113 href=#__codelineno-58-113></a><span class=w>            </span><span class=p>},</span><span class=w> </span><span class=nx>timeout</span><span class=p>,</span><span class=w> </span><span class=nx>interval</span><span class=p>).</span><span class=nx>Should</span><span class=p>(</span><span class=nx>ContainSubstring</span><span class=p>(</span><span class=s>&quot;Updated message via test&quot;</span><span class=p>))</span>
</span><span id=__span-58-114><a id=__codelineno-58-114 name=__codelineno-58-114 href=#__codelineno-58-114></a><span class=w>        </span><span class=p>})</span>
</span><span id=__span-58-115><a id=__codelineno-58-115 name=__codelineno-58-115 href=#__codelineno-58-115></a><span class=w>    </span><span class=p>})</span>
</span><span id=__span-58-116><a id=__codelineno-58-116 name=__codelineno-58-116 href=#__codelineno-58-116></a><span class=p>})</span>
</span></code></pre></div> <h3 id=1203-run-the-tests>12.03 Run the tests<a class=headerlink href=#1203-run-the-tests title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a>make<span class=w> </span><span class=nb>test</span>
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a>
</span><span id=__span-59-3><a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a><span class=c1># With verbose output</span>
</span><span id=__span-59-4><a id=__codelineno-59-4 name=__codelineno-59-4 href=#__codelineno-59-4></a>make<span class=w> </span><span class=nb>test</span><span class=w> </span><span class=nv>ARGS</span><span class=o>=</span><span class=s2>&quot;--v&quot;</span>
</span><span id=__span-59-5><a id=__codelineno-59-5 name=__codelineno-59-5 href=#__codelineno-59-5></a>
</span><span id=__span-59-6><a id=__codelineno-59-6 name=__codelineno-59-6 href=#__codelineno-59-6></a><span class=c1># Run only specific tests</span>
</span><span id=__span-59-7><a id=__codelineno-59-7 name=__codelineno-59-7 href=#__codelineno-59-7></a>go<span class=w> </span><span class=nb>test</span><span class=w> </span>./internal/controller/...<span class=w> </span>-run<span class=w> </span><span class=s2>&quot;WebApp Controller&quot;</span><span class=w> </span>-v
</span></code></pre></div> <hr> <h2 id=part-13-build-and-deploy-the-operator-in-cluster>Part 13 - Build and Deploy the Operator In-Cluster<a class=headerlink href=#part-13-build-and-deploy-the-operator-in-cluster title="Permanent link">&para;</a></h2> <h3 id=1301-write-the-dockerfile>13.01 Write the Dockerfile<a class=headerlink href=#1301-write-the-dockerfile title="Permanent link">&para;</a></h3> <p>The scaffolded <code>Dockerfile</code> uses a multi-stage build:</p> <div class="language-dockerfile highlight"><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a><span class=c># Build stage</span>
</span><span id=__span-60-2><a id=__codelineno-60-2 name=__codelineno-60-2 href=#__codelineno-60-2></a><span class=k>FROM</span><span class=w> </span><span class=s>golang:1.22</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s>builder</span>
</span><span id=__span-60-3><a id=__codelineno-60-3 name=__codelineno-60-3 href=#__codelineno-60-3></a><span class=k>ARG</span><span class=w> </span>TARGETOS
</span><span id=__span-60-4><a id=__codelineno-60-4 name=__codelineno-60-4 href=#__codelineno-60-4></a><span class=k>ARG</span><span class=w> </span>TARGETARCH
</span><span id=__span-60-5><a id=__codelineno-60-5 name=__codelineno-60-5 href=#__codelineno-60-5></a><span class=k>WORKDIR</span><span class=w> </span><span class=s>/workspace</span>
</span><span id=__span-60-6><a id=__codelineno-60-6 name=__codelineno-60-6 href=#__codelineno-60-6></a>
</span><span id=__span-60-7><a id=__codelineno-60-7 name=__codelineno-60-7 href=#__codelineno-60-7></a><span class=k>COPY</span><span class=w> </span>go.mod<span class=w> </span>go.sum<span class=w> </span>./
</span><span id=__span-60-8><a id=__codelineno-60-8 name=__codelineno-60-8 href=#__codelineno-60-8></a><span class=k>RUN</span><span class=w> </span>go<span class=w> </span>mod<span class=w> </span>download
</span><span id=__span-60-9><a id=__codelineno-60-9 name=__codelineno-60-9 href=#__codelineno-60-9></a>
</span><span id=__span-60-10><a id=__codelineno-60-10 name=__codelineno-60-10 href=#__codelineno-60-10></a><span class=k>COPY</span><span class=w> </span>cmd/<span class=w>       </span>cmd/
</span><span id=__span-60-11><a id=__codelineno-60-11 name=__codelineno-60-11 href=#__codelineno-60-11></a><span class=k>COPY</span><span class=w> </span>api/<span class=w>       </span>api/
</span><span id=__span-60-12><a id=__codelineno-60-12 name=__codelineno-60-12 href=#__codelineno-60-12></a><span class=k>COPY</span><span class=w> </span>internal/<span class=w>  </span>internal/
</span><span id=__span-60-13><a id=__codelineno-60-13 name=__codelineno-60-13 href=#__codelineno-60-13></a>
</span><span id=__span-60-14><a id=__codelineno-60-14 name=__codelineno-60-14 href=#__codelineno-60-14></a><span class=k>RUN</span><span class=w> </span><span class=nv>CGO_ENABLED</span><span class=o>=</span><span class=m>0</span><span class=w> </span><span class=nv>GOOS</span><span class=o>=</span><span class=si>${</span><span class=nv>TARGETOS</span><span class=k>:-</span><span class=nv>linux</span><span class=si>}</span><span class=w> </span><span class=nv>GOARCH</span><span class=o>=</span><span class=si>${</span><span class=nv>TARGETARCH</span><span class=si>}</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-60-15><a id=__codelineno-60-15 name=__codelineno-60-15 href=#__codelineno-60-15></a><span class=w>    </span>go<span class=w> </span>build<span class=w> </span>-a<span class=w> </span>-o<span class=w> </span>manager<span class=w> </span>cmd/main.go
</span><span id=__span-60-16><a id=__codelineno-60-16 name=__codelineno-60-16 href=#__codelineno-60-16></a>
</span><span id=__span-60-17><a id=__codelineno-60-17 name=__codelineno-60-17 href=#__codelineno-60-17></a><span class=c># Runtime stage - distroless for minimal attack surface</span>
</span><span id=__span-60-18><a id=__codelineno-60-18 name=__codelineno-60-18 href=#__codelineno-60-18></a><span class=k>FROM</span><span class=w> </span><span class=s>gcr.io/distroless/static:nonroot</span>
</span><span id=__span-60-19><a id=__codelineno-60-19 name=__codelineno-60-19 href=#__codelineno-60-19></a><span class=k>WORKDIR</span><span class=w> </span><span class=s>/</span>
</span><span id=__span-60-20><a id=__codelineno-60-20 name=__codelineno-60-20 href=#__codelineno-60-20></a><span class=k>COPY</span><span class=w> </span>--from<span class=o>=</span>builder<span class=w> </span>/workspace/manager<span class=w> </span>.
</span><span id=__span-60-21><a id=__codelineno-60-21 name=__codelineno-60-21 href=#__codelineno-60-21></a><span class=k>USER</span><span class=w> </span><span class=s>65532:65532</span>
</span><span id=__span-60-22><a id=__codelineno-60-22 name=__codelineno-60-22 href=#__codelineno-60-22></a><span class=k>ENTRYPOINT</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;/manager&quot;</span><span class=p>]</span>
</span></code></pre></div> <h3 id=1302-build-and-push-the-image>13.02 Build and push the image<a class=headerlink href=#1302-build-and-push-the-image title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a><span class=c1># Set your image registry</span>
</span><span id=__span-61-2><a id=__codelineno-61-2 name=__codelineno-61-2 href=#__codelineno-61-2></a><span class=nb>export</span><span class=w> </span><span class=nv>IMG</span><span class=o>=</span>ghcr.io/your-org/webapp-operator:v0.1.0
</span><span id=__span-61-3><a id=__codelineno-61-3 name=__codelineno-61-3 href=#__codelineno-61-3></a>
</span><span id=__span-61-4><a id=__codelineno-61-4 name=__codelineno-61-4 href=#__codelineno-61-4></a><span class=c1># Build the image</span>
</span><span id=__span-61-5><a id=__codelineno-61-5 name=__codelineno-61-5 href=#__codelineno-61-5></a>make<span class=w> </span>docker-build<span class=w> </span><span class=nv>IMG</span><span class=o>=</span><span class=si>${</span><span class=nv>IMG</span><span class=si>}</span>
</span><span id=__span-61-6><a id=__codelineno-61-6 name=__codelineno-61-6 href=#__codelineno-61-6></a>
</span><span id=__span-61-7><a id=__codelineno-61-7 name=__codelineno-61-7 href=#__codelineno-61-7></a><span class=c1># Push (requires docker login)</span>
</span><span id=__span-61-8><a id=__codelineno-61-8 name=__codelineno-61-8 href=#__codelineno-61-8></a>make<span class=w> </span>docker-push<span class=w> </span><span class=nv>IMG</span><span class=o>=</span><span class=si>${</span><span class=nv>IMG</span><span class=si>}</span>
</span></code></pre></div> <h3 id=1303-deploy-to-the-cluster>13.03 Deploy to the cluster<a class=headerlink href=#1303-deploy-to-the-cluster title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a><span class=c1># Deploys CRDs, RBAC, and the operator Deployment via Kustomize</span>
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a>make<span class=w> </span>deploy<span class=w> </span><span class=nv>IMG</span><span class=o>=</span><span class=si>${</span><span class=nv>IMG</span><span class=si>}</span>
</span><span id=__span-62-3><a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a>
</span><span id=__span-62-4><a id=__codelineno-62-4 name=__codelineno-62-4 href=#__codelineno-62-4></a><span class=c1># Verify the operator pod is running</span>
</span><span id=__span-62-5><a id=__codelineno-62-5 name=__codelineno-62-5 href=#__codelineno-62-5></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>webapp-system
</span><span id=__span-62-6><a id=__codelineno-62-6 name=__codelineno-62-6 href=#__codelineno-62-6></a>
</span><span id=__span-62-7><a id=__codelineno-62-7 name=__codelineno-62-7 href=#__codelineno-62-7></a><span class=c1># Watch the operator logs</span>
</span><span id=__span-62-8><a id=__codelineno-62-8 name=__codelineno-62-8 href=#__codelineno-62-8></a>kubectl<span class=w> </span>logs<span class=w> </span>-n<span class=w> </span>webapp-system<span class=w> </span><span class=se>\</span>
</span><span id=__span-62-9><a id=__codelineno-62-9 name=__codelineno-62-9 href=#__codelineno-62-9></a><span class=w>    </span>-l<span class=w> </span>control-plane<span class=o>=</span>controller-manager<span class=w> </span><span class=se>\</span>
</span><span id=__span-62-10><a id=__codelineno-62-10 name=__codelineno-62-10 href=#__codelineno-62-10></a><span class=w>    </span>-f
</span></code></pre></div> <h3 id=1304-apply-a-webapp-cr-in-the-cluster>13.04 Apply a WebApp CR in the cluster<a class=headerlink href=#1304-apply-a-webapp-cr-in-the-cluster title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>config/samples/apps_v1_webapp.yaml
</span><span id=__span-63-2><a id=__codelineno-63-2 name=__codelineno-63-2 href=#__codelineno-63-2></a>
</span><span id=__span-63-3><a id=__codelineno-63-3 name=__codelineno-63-3 href=#__codelineno-63-3></a>kubectl<span class=w> </span>get<span class=w> </span>wa<span class=w> </span>-A
</span><span id=__span-63-4><a id=__codelineno-63-4 name=__codelineno-63-4 href=#__codelineno-63-4></a>kubectl<span class=w> </span>get<span class=w> </span>deployment,service,configmap<span class=w> </span>-l<span class=w> </span>app.kubernetes.io/managed-by<span class=o>=</span>webapp-operator
</span></code></pre></div> <h3 id=1305-undeploy>13.05 Undeploy<a class=headerlink href=#1305-undeploy title="Permanent link">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a>make<span class=w> </span>undeploy
</span><span id=__span-64-2><a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a>make<span class=w> </span>uninstall<span class=w>   </span><span class=c1># remove CRDs</span>
</span></code></pre></div> <hr> <h2 id=part-14-quick-reference-cheatsheet>Part 14 - Quick Reference Cheatsheet<a class=headerlink href=#part-14-quick-reference-cheatsheet title="Permanent link">&para;</a></h2> <table> <thead> <tr> <th>Goal</th> <th>Command</th> </tr> </thead> <tbody> <tr> <td>Init new project</td> <td><code>kubebuilder init --domain codewizard.io --repo codewizard.io/my-op</code></td> </tr> <tr> <td>Create CRD + controller</td> <td><code>kubebuilder create api --group apps --version v1 --kind MyKind</code></td> </tr> <tr> <td>Create webhook</td> <td><code>kubebuilder create webhook --group apps --version v1 --kind MyKind --defaulting --programmatic-validation</code></td> </tr> <tr> <td>Regenerate DeepCopy</td> <td><code>make generate</code></td> </tr> <tr> <td>Regenerate CRD/RBAC YAML</td> <td><code>make manifests</code></td> </tr> <tr> <td>Install CRDs to cluster</td> <td><code>make install</code></td> </tr> <tr> <td>Run controller locally</td> <td><code>make run</code></td> </tr> <tr> <td>Run tests (no cluster)</td> <td><code>make test</code></td> </tr> <tr> <td>Build operator image</td> <td><code>make docker-build IMG=myregistry/myop:v1</code></td> </tr> <tr> <td>Push operator image</td> <td><code>make docker-push IMG=myregistry/myop:v1</code></td> </tr> <tr> <td>Deploy to cluster</td> <td><code>make deploy IMG=myregistry/myop:v1</code></td> </tr> <tr> <td>Undeploy</td> <td><code>make undeploy</code></td> </tr> <tr> <td>Remove CRDs</td> <td><code>make uninstall</code></td> </tr> <tr> <td>View all API resources</td> <td><code>kubectl api-resources --api-group=apps.codewizard.io</code></td> </tr> <tr> <td>Short-name get</td> <td><code>kubectl get wa</code></td> </tr> <tr> <td>Watch reconcile logs</td> <td><code>kubectl logs -n webapp-system -l control-plane=controller-manager -f</code></td> </tr> </tbody> </table> <hr> <h2 id=exercises>Exercises<a class=headerlink href=#exercises title="Permanent link">&para;</a></h2> <p>The following exercises build on the <code>webapp-operator</code> created in this lab.</p> <hr> <h4 id=exercise-01-add-a-maxunavailable-field>Exercise 01 - Add a <code>maxUnavailable</code> field<a class=headerlink href=#exercise-01-add-a-maxunavailable-field title="Permanent link">&para;</a></h4> <p>Add a <code>MaxUnavailable</code> field to <code>WebAppSpec</code> that maps to <code>deployment.spec.strategy.rollingUpdate.maxUnavailable</code>.</p> <ul> <li>Add the field with validation <code>Minimum=0</code>, <code>Maximum=replicas</code></li> <li>Default it to <code>1</code></li> <li>Implement the mapping in <code>reconcileDeployment()</code></li> <li>Run <code>make generate &amp;&amp; make manifests</code></li> <li>Test with a patch: <code>kubectl patch wa my-webapp --type=merge -p '{"spec":{"maxUnavailable":2}}'</code></li> </ul> <details> <summary>Hint</summary> <div class="language-go highlight"><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a><span class=c1>// In WebAppSpec</span>
</span><span id=__span-65-2><a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a><span class=c1>// +kubebuilder:validation:Minimum=0</span>
</span><span id=__span-65-3><a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a><span class=c1>// +kubebuilder:default=1</span>
</span><span id=__span-65-4><a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a><span class=nx>MaxUnavailable</span><span class=w> </span><span class=kt>int32</span><span class=w> </span><span class=s>`json:&quot;maxUnavailable,omitempty&quot;`</span>
</span><span id=__span-65-5><a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a>
</span><span id=__span-65-6><a id=__codelineno-65-6 name=__codelineno-65-6 href=#__codelineno-65-6></a><span class=c1>// In reconcileDeployment, set:</span>
</span><span id=__span-65-7><a id=__codelineno-65-7 name=__codelineno-65-7 href=#__codelineno-65-7></a><span class=nx>intMaxUnavailable</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>intstr</span><span class=p>.</span><span class=nx>FromInt32</span><span class=p>(</span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>MaxUnavailable</span><span class=p>)</span>
</span><span id=__span-65-8><a id=__codelineno-65-8 name=__codelineno-65-8 href=#__codelineno-65-8></a><span class=nx>desired</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Strategy</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>DeploymentStrategy</span><span class=p>{</span>
</span><span id=__span-65-9><a id=__codelineno-65-9 name=__codelineno-65-9 href=#__codelineno-65-9></a><span class=w>    </span><span class=nx>Type</span><span class=p>:</span><span class=w> </span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>RollingUpdateDeploymentStrategyType</span><span class=p>,</span>
</span><span id=__span-65-10><a id=__codelineno-65-10 name=__codelineno-65-10 href=#__codelineno-65-10></a><span class=w>    </span><span class=nx>RollingUpdate</span><span class=p>:</span><span class=w> </span><span class=o>&amp;</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>RollingUpdateDeployment</span><span class=p>{</span>
</span><span id=__span-65-11><a id=__codelineno-65-11 name=__codelineno-65-11 href=#__codelineno-65-11></a><span class=w>        </span><span class=nx>MaxUnavailable</span><span class=p>:</span><span class=w> </span><span class=o>&amp;</span><span class=nx>intMaxUnavailable</span><span class=p>,</span>
</span><span id=__span-65-12><a id=__codelineno-65-12 name=__codelineno-65-12 href=#__codelineno-65-12></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-65-13><a id=__codelineno-65-13 name=__codelineno-65-13 href=#__codelineno-65-13></a><span class=p>}</span>
</span></code></pre></div> </details> <hr> <h4 id=exercise-02-surface-a-url-in-the-status>Exercise 02 - Surface a URL in the status<a class=headerlink href=#exercise-02-surface-a-url-in-the-status title="Permanent link">&para;</a></h4> <p>Add a <code>URL</code> field to <code>WebAppStatus</code> that the controller populates with <code>http://&lt;service-cluster-ip&gt;:&lt;port&gt;</code>.</p> <ul> <li>Add <code>URL string</code> to <code>WebAppStatus</code></li> <li>In <code>updateStatus()</code>, fetch the Service&rsquo;s <code>ClusterIP</code> and populate <code>updated.Status.URL</code></li> <li>Verify: <code>kubectl get wa my-webapp -o jsonpath='{.status.url}'</code></li> </ul> <details> <summary>Hint</summary> <div class="language-go highlight"><pre><span></span><code><span id=__span-66-1><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a><span class=c1>// Fetch the service inside updateStatus</span>
</span><span id=__span-66-2><a id=__codelineno-66-2 name=__codelineno-66-2 href=#__codelineno-66-2></a><span class=nx>svc</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Service</span><span class=p>{}</span>
</span><span id=__span-66-3><a id=__codelineno-66-3 name=__codelineno-66-3 href=#__codelineno-66-3></a><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span><span class=w> </span><span class=nx>Namespace</span><span class=p>:</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>},</span><span class=w> </span><span class=nx>svc</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-66-4><a id=__codelineno-66-4 name=__codelineno-66-4 href=#__codelineno-66-4></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>svc</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ClusterIP</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-66-5><a id=__codelineno-66-5 name=__codelineno-66-5 href=#__codelineno-66-5></a><span class=w>        </span><span class=nx>updated</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>URL</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nx>Sprintf</span><span class=p>(</span><span class=s>&quot;http://%s:%d&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>svc</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ClusterIP</span><span class=p>,</span><span class=w> </span><span class=nx>webapp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Port</span><span class=p>)</span>
</span><span id=__span-66-6><a id=__codelineno-66-6 name=__codelineno-66-6 href=#__codelineno-66-6></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-66-7><a id=__codelineno-66-7 name=__codelineno-66-7 href=#__codelineno-66-7></a><span class=p>}</span>
</span></code></pre></div> </details> <hr> <h4 id=exercise-03-add-a-paused-field-to-skip-reconciliation>Exercise 03 - Add a <code>Paused</code> field to skip reconciliation<a class=headerlink href=#exercise-03-add-a-paused-field-to-skip-reconciliation title="Permanent link">&para;</a></h4> <p>Add a <code>Paused bool</code> field to <code>WebAppSpec</code>. When <code>true</code>, the controller exits the reconcile loop early with a log message, leaving all resources unchanged.</p> <ul> <li>Add <code>// +kubebuilder:default=false</code> and <code>Paused bool</code> to <code>WebAppSpec</code></li> <li>In <code>Reconcile()</code>, check early: <code>if webapp.Spec.Paused { logger.Info("Skipping - paused"); return ctrl.Result{}, nil }</code></li> <li>Test: <code>kubectl patch wa my-webapp --type=merge -p '{"spec":{"paused":true}}'</code> Then scale down manually and confirm the operator does <strong>not</strong> restore it.</li> </ul> <hr> <h4 id=exercise-04-add-a-webapppolicy-crd>Exercise 04 - Add a <code>WebAppPolicy</code> CRD<a class=headerlink href=#exercise-04-add-a-webapppolicy-crd title="Permanent link">&para;</a></h4> <p>Create a second API kind <code>WebAppPolicy</code> in the same group that defines a <code>maxReplicas</code> namespace-scoped limit.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-67-1><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a>kubebuilder<span class=w> </span>create<span class=w> </span>api<span class=w> </span><span class=se>\</span>
</span><span id=__span-67-2><a id=__codelineno-67-2 name=__codelineno-67-2 href=#__codelineno-67-2></a><span class=w>    </span>--group<span class=w> </span>apps<span class=w> </span><span class=se>\</span>
</span><span id=__span-67-3><a id=__codelineno-67-3 name=__codelineno-67-3 href=#__codelineno-67-3></a><span class=w>    </span>--version<span class=w> </span>v1<span class=w> </span><span class=se>\</span>
</span><span id=__span-67-4><a id=__codelineno-67-4 name=__codelineno-67-4 href=#__codelineno-67-4></a><span class=w>    </span>--kind<span class=w> </span>WebAppPolicy
</span></code></pre></div> <p>In the <code>WebAppReconciler</code>, after fetching the <code>WebApp</code>, look for a <code>WebAppPolicy</code> in the same namespace and enforce the <code>maxReplicas</code> limit by clamping <code>webapp.Spec.Replicas</code>.</p> <hr> <h4 id=exercise-05-write-a-webhook-that-prevents-downscaling-to-0>Exercise 05 - Write a webhook that prevents downscaling to 0<a class=headerlink href=#exercise-05-write-a-webhook-that-prevents-downscaling-to-0 title="Permanent link">&para;</a></h4> <p>Add a validating webhook that rejects any update to a <code>WebApp</code> where <code>spec.replicas</code> was changed from &gt; 0 to 0.</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-68-1><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>WebApp</span><span class=p>)</span><span class=w> </span><span class=nx>ValidateUpdate</span><span class=p>(</span><span class=nx>old</span><span class=w> </span><span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>admission</span><span class=p>.</span><span class=nx>Warnings</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-68-2><a id=__codelineno-68-2 name=__codelineno-68-2 href=#__codelineno-68-2></a><span class=w>    </span><span class=nx>oldWebApp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>old</span><span class=p>.(</span><span class=o>*</span><span class=nx>WebApp</span><span class=p>)</span>
</span><span id=__span-68-3><a id=__codelineno-68-3 name=__codelineno-68-3 href=#__codelineno-68-3></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>oldWebApp</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-68-4><a id=__codelineno-68-4 name=__codelineno-68-4 href=#__codelineno-68-4></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>apierrors</span><span class=p>.</span><span class=nx>NewForbidden</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span><span id=__span-68-5><a id=__codelineno-68-5 name=__codelineno-68-5 href=#__codelineno-68-5></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-68-6><a id=__codelineno-68-6 name=__codelineno-68-6 href=#__codelineno-68-6></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>validateWebApp</span><span class=p>()</span>
</span><span id=__span-68-7><a id=__codelineno-68-7 name=__codelineno-68-7 href=#__codelineno-68-7></a><span class=p>}</span>
</span></code></pre></div> <hr> <h2 id=cleanup>Cleanup<a class=headerlink href=#cleanup title="Permanent link">&para;</a></h2> <div class="language-bash highlight"><pre><span></span><code><span id=__span-69-1><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a><span class=c1># Delete sample CRs</span>
</span><span id=__span-69-2><a id=__codelineno-69-2 name=__codelineno-69-2 href=#__codelineno-69-2></a>kubectl<span class=w> </span>delete<span class=w> </span>wa<span class=w> </span>--all
</span><span id=__span-69-3><a id=__codelineno-69-3 name=__codelineno-69-3 href=#__codelineno-69-3></a>
</span><span id=__span-69-4><a id=__codelineno-69-4 name=__codelineno-69-4 href=#__codelineno-69-4></a><span class=c1># Uninstall CRDs from the cluster</span>
</span><span id=__span-69-5><a id=__codelineno-69-5 name=__codelineno-69-5 href=#__codelineno-69-5></a>make<span class=w> </span>uninstall
</span><span id=__span-69-6><a id=__codelineno-69-6 name=__codelineno-69-6 href=#__codelineno-69-6></a>
</span><span id=__span-69-7><a id=__codelineno-69-7 name=__codelineno-69-7 href=#__codelineno-69-7></a><span class=c1># If deployed in-cluster</span>
</span><span id=__span-69-8><a id=__codelineno-69-8 name=__codelineno-69-8 href=#__codelineno-69-8></a>make<span class=w> </span>undeploy
</span><span id=__span-69-9><a id=__codelineno-69-9 name=__codelineno-69-9 href=#__codelineno-69-9></a>
</span><span id=__span-69-10><a id=__codelineno-69-10 name=__codelineno-69-10 href=#__codelineno-69-10></a><span class=c1># Remove the project directory</span>
</span><span id=__span-69-11><a id=__codelineno-69-11 name=__codelineno-69-11 href=#__codelineno-69-11></a><span class=nb>cd</span><span class=w> </span>..
</span><span id=__span-69-12><a id=__codelineno-69-12 name=__codelineno-69-12 href=#__codelineno-69-12></a>rm<span class=w> </span>-rf<span class=w> </span>webapp-operator
</span></code></pre></div> <hr> <h2 id=troubleshooting>Troubleshooting<a class=headerlink href=#troubleshooting title="Permanent link">&para;</a></h2> <ul> <li><strong><code>make generate</code> fails with missing tool:</strong></li> </ul> <p>The Makefile auto-downloads <code>controller-gen</code>. If it fails, install manually:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-70-1><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a>go<span class=w> </span>install<span class=w> </span>sigs.k8s.io/controller-tools/cmd/controller-gen@latest
</span></code></pre></div> <p><br></p> <ul> <li><strong>CRD not appearing after <code>make install</code>:</strong></li> </ul> <p>Verify the CRD was generated and applied:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-71-1><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a>cat<span class=w> </span>config/crd/bases/*.yaml<span class=w> </span><span class=p>|</span><span class=w> </span>head<span class=w> </span>-20
</span><span id=__span-71-2><a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a>kubectl<span class=w> </span>get<span class=w> </span>crds<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>&lt;your-domain&gt;
</span><span id=__span-71-3><a id=__codelineno-71-3 name=__codelineno-71-3 href=#__codelineno-71-3></a>kubectl<span class=w> </span>describe<span class=w> </span>crd<span class=w> </span>&lt;crd-name&gt;
</span></code></pre></div> <p><br></p> <ul> <li><strong>Controller crashes with <code>cannot create resource</code> errors:</strong></li> </ul> <p>The RBAC markers in your controller file may be incomplete. Ensure you have <code>//+kubebuilder:rbac</code> markers for every resource your controller touches:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-72-1><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a><span class=c1># Check the generated RBAC role</span>
</span><span id=__span-72-2><a id=__codelineno-72-2 name=__codelineno-72-2 href=#__codelineno-72-2></a>cat<span class=w> </span>config/rbac/role.yaml
</span><span id=__span-72-3><a id=__codelineno-72-3 name=__codelineno-72-3 href=#__codelineno-72-3></a>
</span><span id=__span-72-4><a id=__codelineno-72-4 name=__codelineno-72-4 href=#__codelineno-72-4></a><span class=c1># Regenerate after adding markers</span>
</span><span id=__span-72-5><a id=__codelineno-72-5 name=__codelineno-72-5 href=#__codelineno-72-5></a>make<span class=w> </span>manifests
</span><span id=__span-72-6><a id=__codelineno-72-6 name=__codelineno-72-6 href=#__codelineno-72-6></a>make<span class=w> </span>deploy<span class=w> </span><span class=nv>IMG</span><span class=o>=</span><span class=si>${</span><span class=nv>IMG</span><span class=si>}</span>
</span></code></pre></div> <p><br></p> <ul> <li><strong><code>make test</code> fails with <code>envtest</code> binary not found:</strong></li> </ul> <p>Download the envtest binaries:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-73-1><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a>make<span class=w> </span>envtest
</span><span id=__span-73-2><a id=__codelineno-73-2 name=__codelineno-73-2 href=#__codelineno-73-2></a><span class=nb>source</span><span class=w> </span>&lt;<span class=o>(</span>setup-envtest<span class=w> </span>use<span class=w> </span>-p<span class=w> </span>env<span class=o>)</span>
</span><span id=__span-73-3><a id=__codelineno-73-3 name=__codelineno-73-3 href=#__codelineno-73-3></a>make<span class=w> </span><span class=nb>test</span>
</span></code></pre></div> <p><br></p> <ul> <li><strong>Status not updating on the CR:</strong></li> </ul> <p>Ensure you use <code>r.Status().Update()</code> (the status subresource), not <code>r.Update()</code>:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-74-1><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a>kubectl<span class=w> </span>get<span class=w> </span>&lt;kind&gt;<span class=w> </span>-o<span class=w> </span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status}&#39;</span>
</span><span id=__span-74-2><a id=__codelineno-74-2 name=__codelineno-74-2 href=#__codelineno-74-2></a>kubectl<span class=w> </span>describe<span class=w> </span>&lt;kind&gt;<span class=w> </span>&lt;name&gt;<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-A10<span class=w> </span><span class=s2>&quot;Status:&quot;</span>
</span></code></pre></div> <p><br></p> <ul> <li><strong>Owner reference / garbage collection not working:</strong></li> </ul> <p>Verify <code>ctrl.SetControllerReference()</code> is called for every child resource and that <code>.Owns()</code> is set in <code>SetupWithManager</code>:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-75-1><a id=__codelineno-75-1 name=__codelineno-75-1 href=#__codelineno-75-1></a>kubectl<span class=w> </span>get<span class=w> </span>deployment<span class=w> </span>&lt;child&gt;<span class=w> </span>-o<span class=w> </span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.metadata.ownerReferences}&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span>jq
</span></code></pre></div> <hr> <h2 id=next-steps>Next Steps<a class=headerlink href=#next-steps title="Permanent link">&para;</a></h2> <ul> <li>Explore the <a href=https://book.kubebuilder.io/ >Kubebuilder Book</a> for advanced patterns: multi-version APIs, conversion webhooks, and external event sources.</li> <li>Try the <a href=https://sdk.operatorframework.io/ >Operator SDK</a> which builds on Kubebuilder with Ansible and Helm-based operators.</li> <li>Browse <a href=https://operatorhub.io/ >OperatorHub.io</a> to see real-world operators and their patterns.</li> <li>Learn about <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/finalizers/ >Finalizers</a> for managing external resources during deletion.</li> <li>Combine your operator with <a href=../18-ArgoCD/ >ArgoCD (Lab 18)</a> for GitOps-managed operator deployments.</li> <li>Practice operator tasks in the <a href=../Tasks/Kubernetes-Kubebuilder-Tasks/ >Kubernetes Kubebuilder Tasks</a> section.</li> </ul> <hr> <!--
  Copyright (c) 2016-2025 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Render date of last update --> <!-- Render date of creation --> <!-- ---------------------------------------------------------------------- --> <!-- Render authors --> <!-- ---------------------------------------------------------------------- --> <!-- Render committers from GitHub --> <!-- Render committers from GitLab --> <!-- Render committers --> <!-- ---------------------------------------------------------------------- --> <!-- Determine date of last update --> <!-- Determine date of creation --> <!-- Source file information --> <aside class=md-source-file> <!-- Date of last update --> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="February 25, 2026 17:24:59 UTC">February 25, 2026</span> </span> <!-- Authors (git-authors plugin) --> <!-- Authors (git-committers plugin) --> <!-- Fallback: Manual GitHub avatar for repository owner --> <span class=md-source-file__fact> <nav> <a href=https://github.com/nirgeier class=md-author title=@nirgeier> <img src="https://avatars.githubusercontent.com/u/555154?size=256" alt="Nir Geier"> </a> </nav> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <!--
  Copyright (c) 2016-2025 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Footer --> <footer class=md-footer> <div class=logo1></div> <div class=logo2></div> <!-- Link to previous and/or next page --> <nav class="md-footer__inner md-grid" aria-label=Footer> <!-- Link to previous page --> <a href=../21-KubeAPI/ class="md-footer__link md-footer__link--prev" aria-label="Previous: 21 KubeAPI"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> 21 KubeAPI </div> </div> </a> <!-- <ul class="social-badges">
          <li><a href="https://visitor-badge.laobi.icu/badge?page_id=nirgeier" target="_blank" rel="noopener"><img src="https://visitor-badge.laobi.icu/badge?page_id=nirgeier" alt="Visitor Badge"></a></li>
          <li><a href="https://www.linkedin.com/in/nirgeier/" target="_blank" rel="noopener"><i class="fab fa-linkedin" aria-hidden="true"></i><span class="sr-only">LinkedIn profile</span></a></li>
          <li><a href="mailto:nirgeier@gmail.com"><img src="https://img.shields.io/badge/-nirgeier@gmail.com-fcc624?style=flat&logo=Gmail&logoColor=red" alt="Gmail Badge"></a></li>
          <li><a href="mailto:nirg@codewizard.co.il"><img src="https://img.shields.io/badge/-nirg@codewizard.co.il-fcc624?style=flat&logo=microsoftoutlook&logoColor=blue" alt="Outlook Badge"></a></li>
        </ul> --> <!-- Link to next page --> <a href=../25-krew/ class="md-footer__link md-footer__link--next" aria-label="Next: 25 Krew"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> 25 Krew </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <!-- Further information --> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> ©2021-2026 Nir Geier<br><a href="https://visitor-badge.laobi.icu/badge?page_id=nirgeier" target=_blank rel=noopener><img src="https://visitor-badge.laobi.icu/badge?page_id=nirgeier" alt="Visitor Badge"></a> </div> </div> <!-- Social links --> <div class=md-social> <a href=https://github.com/nirgeier/KubernetesLabs target=_blank rel=noopener title="View on GitHub" class="md-social__link social-class__github"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://github.com/nirgeier/KubernetesLabs/network/members target=_blank rel=noopener title="Fork this repo" class="md-social__link social-class__fork"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0M5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0m6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5m-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0"/></svg> </a> <a href=https://github.com/nirgeier/KubernetesLabs/stargazers target=_blank rel=noopener title="Star this repo" class="md-social__link social-class__star"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25m0 2.445L6.615 5.5a.75.75 0 0 1-.564.41l-3.097.45 2.24 2.184a.75.75 0 0 1 .216.664l-.528 3.084 2.769-1.456a.75.75 0 0 1 .698 0l2.77 1.456-.53-3.084a.75.75 0 0 1 .216-.664l2.24-2.183-3.096-.45a.75.75 0 0 1-.564-.41z"/></svg> </a> <a href=https://www.linkedin.com/in/nirgeier/ target=_blank rel=noopener title="Connect on LinkedIn" class="md-social__link social-class__linkedin"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://discord.gg/U6xW23Ss target=_blank rel=noopener title="Follow me on Discord" class="md-social__link social-class__discord"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"/></svg> </a> <a href=https://stackoverflow.com/users/1755598/codewizard target=_blank rel=noopener title="Follow me on Stack Overflow" class="md-social__link social-class__stackoverflow"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M291 311 95.3 269.7 87.1 309l195.7 41zm51-87L188.5 95.7 163 126.5l153.5 128.3zm-31.2 39.7L129.5 179l-16.7 36.5L294 300zM262.3 32l-32 24 119.3 160.3 32-24zm20.5 328h-200v39.7h200zm39.7 80H43V320H3v160h359.5V320h-40z"/></svg> </a> <a href=https://wa.me/972548122310 target=_blank rel=noopener title="Follow me on WhatsApp" class="md-social__link social-class__whatsapp"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157m-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1s56.2 81.2 56.1 130.5c0 101.8-84.9 184.6-186.6 184.6m101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8s-14.3 18-17.6 21.8c-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7s-12.5-30.1-17.1-41.2c-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2s-9.7 1.4-14.8 6.9c-5.1 5.6-19.4 19-19.4 46.3s19.9 53.7 22.6 57.4c2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4s4.6-24.1 3.2-26.4c-1.3-2.5-5-3.9-10.5-6.6"/></svg> </a> <a href=mailto:nirg@codewizard.co.il target=_blank rel=noopener title="Email me" class="md-social__link social-class__email"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l208 156a48 48 0 0 0 57.6 0l208-156c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48zM0 196v188c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V196L313.6 344.8c-34.1 25.6-81.1 25.6-115.2 0z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.footnote.tooltips", "content.tabs.link", "content.tooltips", "content.footer.last-updated", "content.footer.contributors", {"navigation.expand": false}, "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", {"navigation.top": true}, "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate", "toc.sticky"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../assets/javascripts/bundle.50899def.min.js></script> <script src=../js/print-site.js></script> <script src="https://buttons.github.io/buttons.js?v=1772199666"></script> <script src=https://unpkg.com/mermaid@11/dist/mermaid.esm.min.mjs type=module></script> </body> </html>